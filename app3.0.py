# -*- coding: utf-8 -*-
"""
AI è¶¨å‹¢åˆ†æ Streamlit æ‡‰ç”¨ç¨‹å¼
å°ˆå®¶å¢å¼·æœ€çµ‚ç‰ˆå¯¦ä½œ

æœ¬æ‡‰ç”¨ç¨‹å¼æ ¹æ“šä¸€ä»½è©³ç´°çš„é‡‘èåˆ†æå·¥å…·è¨­å®šæ–‡ä»¶é€²è¡Œé–‹ç™¼ï¼Œ
æ—¨åœ¨æä¾›ä¸€å€‹æ•´åˆæ€§çš„è‚¡ç¥¨ã€ETFã€æŒ‡æ•¸åŠåŠ å¯†è²¨å¹£çš„ AI è¶¨å‹¢åˆ†æå¹³å°ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š
- å¤šå…ƒåŒ–è³‡ç”¢é¸æ“‡ä»‹é¢
- çµ±ä¸€æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“
- é›™è»Œåˆ¶åŸºæœ¬é¢è©•åˆ†ç³»çµ±
- AI èåˆä¿¡è™Ÿç”Ÿæˆæ¨¡å‹
- å¤šç­–ç•¥å…±è­˜é¢¨éšªç®¡ç† (æ­¢ç›ˆ/æ­¢æ)
- æ¨™æº–åŒ–ç­–ç•¥å›æ¸¬å¼•æ“
- ç·šæ€§åŒ–å ±å‘Šèˆ‡ç¶œåˆåœ–è¡¨å±•ç¤º

é–‹ç™¼è€…ï¼šç¨‹å¼ç¢¼å°ˆå®¶ (Generated by Gemini)
ç‰ˆæœ¬ï¼š1.4.0 (Feature update: Added Entry Price & News Links)
"""

# è¼‰å…¥æ ¸å¿ƒå¥—ä»¶
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import pandas_ta as ta
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# --- 1. æ‡‰ç”¨ç¨‹å¼å…¨åŸŸè¨­å®šèˆ‡éœæ…‹è³‡æ–™ ---

# è¨­ç½®é é¢é…ç½® (å¯¬ç‰ˆ)
st.set_page_config(
    page_title="ğŸš€ AI è¶¨å‹¢åˆ†æå°ˆå®¶ç³»çµ±",
    page_icon="ğŸ“ˆ",
    layout="wide"
)

# è³‡ç”¢åº« (FULL_SYMBOLS_MAP) - æ ¹æ“šæ–‡ä»¶å»ºç«‹çš„ç²¾ç°¡ç‰ˆè³‡ç”¢æ± 
# æ¯å€‹è³‡ç”¢åŒ…å«: ä»£ç¢¼ (Symbol), åç¨± (Name), é—œéµå­— (Keywords)
FULL_SYMBOLS_MAP = {
    'ç¾è‚¡': {
        'AAPL': {'name': 'è˜‹æœ', 'keywords': ['Apple', 'iPhone']},
        'GOOGL': {'name': 'Alphabet (Google)', 'keywords': ['google', 'android']},
        'MSFT': {'name': 'å¾®è»Ÿ', 'keywords': ['Microsoft', 'windows']},
        'NVDA': {'name': 'è¼é”', 'keywords': ['Nvidia', 'AI', 'GPU']},
        'TSLA': {'name': 'ç‰¹æ–¯æ‹‰', 'keywords': ['Tesla', 'EV']},
        'SPY': {'name': 'S&P 500 ETF', 'keywords': ['sp500', 'index']},
        '^GSPC': {'name': 'S&P 500 æŒ‡æ•¸', 'keywords': ['spx']}
    },
    'å°è‚¡': {
        '2330.TW': {'name': 'å°ç©é›»', 'keywords': ['TSMC']},
        '2317.TW': {'name': 'é´»æµ·', 'keywords': ['foxconn']},
        '2454.TW': {'name': 'è¯ç™¼ç§‘', 'keywords': ['mediatek']},
        '0050.TW': {'name': 'å…ƒå¤§å°ç£50', 'keywords': ['etf']},
        '^TWII': {'name': 'å°ç£åŠ æ¬ŠæŒ‡æ•¸', 'keywords': ['taiex']}
    },
    'åŠ å¯†è²¨å¹£': {
        'BTC-USD': {'name': 'æ¯”ç‰¹å¹£', 'keywords': ['Bitcoin']},
        'ETH-USD': {'name': 'ä»¥å¤ªå¹£', 'keywords': ['Ethereum']},
        'SOL-USD': {'name': 'Solana', 'keywords': ['sol']},
    }
}

# åˆ†æé€±æœŸ (PERIOD_MAP) - UI é¸é …èˆ‡ yfinance API åƒæ•¸çš„æ˜ å°„
PERIOD_MAP = {
    '30 åˆ†': {'period': '60d', 'interval': '30m'},
    '4 å°æ™‚': {'period': '1y', 'interval': '60m'},
    '1 æ—¥': {'period': '5y', 'interval': '1d'},
    '1 é€±': {'period': 'max', 'interval': '1wk'}
}

# --- 2. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ (å¾Œç«¯é‚è¼¯) ---

@st.cache_data(ttl=600) # å¿«å–æ•¸æ“š 10 åˆ†é˜
def get_data(symbol, period, interval):
    """
    ä½¿ç”¨ yfinance ç²å–æŒ‡å®šè³‡ç”¢çš„æ­·å²å¸‚å ´æ•¸æ“šã€‚
    Args:
        symbol (str): è³‡ç”¢ä»£ç¢¼
        period (str): æ­·å²æ•¸æ“šæœŸé–“ (e.g., '5y')
        interval (str): æ•¸æ“šæ™‚é–“é–“éš” (e.g., '1d')
    Returns:
        pd.DataFrame: åŒ…å« OHLCV æ•¸æ“šçš„ DataFrameï¼Œè‹¥å¤±æ•—å‰‡è¿”å› Noneã€‚
    """
    try:
        ticker = yf.Ticker(symbol)
        df = ticker.history(period=period, interval=interval)
        if df.empty:
            st.error(f"éŒ¯èª¤ï¼šç„¡æ³•ç²å– '{symbol}' çš„æ•¸æ“šã€‚è«‹æª¢æŸ¥ä»£ç¢¼æˆ–æ›´æ›åˆ†æé€±æœŸã€‚")
            return None
        df.index = pd.to_datetime(df.index)
        # å°æ–¼åŠ å¯†è²¨å¹£ï¼Œyfinance çš„ index å¯èƒ½æ˜¯ UTCï¼Œéœ€è¦è½‰æ›
        if 'USD' in symbol:
             df.index = df.index.tz_convert(None)
        else:
             df.index = df.index.tz_localize(None)
        return df
    except Exception as e:
        st.error(f"æ•¸æ“šç²å–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
        return None

@st.cache_data
def calculate_indicators(df):
    """
    çµ±ä¸€è¨ˆç®—æ‰€æœ‰å¿…è¦çš„æŠ€è¡“æŒ‡æ¨™ã€‚
    ä½¿ç”¨ pandas-ta å¥—ä»¶ç°¡åŒ–è¨ˆç®—éç¨‹ã€‚
    Args:
        df (pd.DataFrame): åŒ…å« OHLCV æ•¸æ“šçš„ DataFrameã€‚
    Returns:
        pd.DataFrame: é™„åŠ äº†æŠ€è¡“æŒ‡æ¨™æ¬„ä½çš„ DataFrameã€‚
    """
    # è¶¨å‹¢æŒ‡æ¨™
    df.ta.ema(length=10, append=True)
    df.ta.ema(length=50, append=True)
    df.ta.ema(length=200, append=True)
    df.ta.macd(fast=12, slow=26, signal=9, append=True) # AIä¿¡è™Ÿç”Ÿæˆç”¨
    df.ta.adx(length=14, append=True)

    # å‹•èƒ½æŒ‡æ¨™
    df.ta.rsi(length=9, append=True)
    df.ta.rsi(length=14, append=True)

    # æ³¢å‹•ç‡æŒ‡æ¨™
    df.ta.bbands(length=20, std=2, append=True)
    df.ta.atr(length=14, append=True)

    # é‡èƒ½æŒ‡æ¨™
    df.ta.obv(append=True)
    df.ta.cmf(length=20, append=True)

    df.dropna(inplace=True)
    return df

@st.cache_data(ttl=3600)
def get_fundamental_data(symbol):
    """
    ç²å–åŸºæœ¬é¢æ•¸æ“šèˆ‡æ–°èã€‚
    æ³¨æ„ï¼šyfinance çš„åŸºæœ¬é¢æ•¸æ“šå¯èƒ½ä¸å®Œæ•´æˆ–å»¶é²ã€‚
    Args:
        symbol (str): è³‡ç”¢ä»£ç¢¼ã€‚
    Returns:
        dict: åŒ…å«åŸºæœ¬é¢æ•¸æ“šå’Œæ–°èçš„å­—å…¸ã€‚
    """
    try:
        if any(keyword in symbol for keyword in ['-USD', '^']):
             return {'info': {}, 'news': [{'title': 'æŒ‡æ•¸æˆ–åŠ å¯†è²¨å¹£ç„¡åŸºæœ¬é¢/æ–°èæ•¸æ“š'}]}

        ticker = yf.Ticker(symbol)
        info = ticker.info
        news = ticker.news
        return {'info': info, 'news': news[:5]} # åªå–æœ€æ–°çš„5æ¢æ–°è
    except Exception:
        return {'info': {}, 'news': [{'title': 'ç„¡æ³•ç²å–æ­¤è³‡ç”¢çš„åŸºæœ¬é¢/æ–°èæ•¸æ“š'}]}

def calculate_fundamental_scores(info):
    """
    é›™è»Œåˆ¶åŸºæœ¬é¢è©•åˆ†ã€‚
    Args:
        info (dict): ä¾†è‡ª yfinance çš„ Ticker.info å­—å…¸ã€‚
    Returns:
        dict: åŒ…å« AI_SCORE å’Œ DISPLAY_SCORE çš„å­—å…¸ã€‚
    """
    # åˆå§‹åŒ–åˆ†æ•¸
    ai_score = 0
    display_score = 0
    
    # è©•åˆ†æ¨™æº–
    roe = info.get('returnOnEquity', 0)
    debt_to_equity = info.get('debtToEquity')
    revenue_growth = info.get('revenueGrowth', 0)
    pe_ratio = info.get('trailingPE')
    peg_ratio = info.get('pegRatio')
    free_cash_flow = info.get('freeCashflow', 0)
    total_cash = info.get('totalCash', 0)
    total_debt = info.get('totalDebt', 1) # é¿å…é™¤ä»¥é›¶

    # --- AIèåˆåˆ†æ•¸ (AI_SCORE) - ç¸½åˆ†7åˆ† ---
    if roe is not None and roe > 0.15: ai_score += 2
    if debt_to_equity is not None and debt_to_equity < 50: ai_score += 2
    if revenue_growth is not None and revenue_growth > 0.10: ai_score += 1
    if pe_ratio is not None and pe_ratio < 15: ai_score += 1
    if peg_ratio is not None and peg_ratio < 1: ai_score += 1
    
    # --- ä»‹é¢é¡¯ç¤ºåˆ†æ•¸ (DISPLAY_SCORE) - ç¸½åˆ†9åˆ† ---
    # ROE è©•åˆ† (3åˆ†)
    if roe is not None:
        if roe > 0.15: display_score += 3
        elif roe > 0.10: display_score += 2
        elif roe > 0: display_score += 1
    
    # P/E è©•åˆ† (3åˆ†)
    if pe_ratio is not None:
        if pe_ratio < 15: display_score += 3
        elif pe_ratio < 25: display_score += 2
        elif pe_ratio < 35: display_score += 1
        
    # ç¾é‡‘æµ/å‚µå‹™è©•åˆ† (3åˆ†)
    if free_cash_flow > 0 and total_cash > total_debt:
        display_score += 3
    elif free_cash_flow > 0 or total_cash > total_debt:
        display_score += 2
    elif total_cash > total_debt * 0.5:
        display_score += 1
        
    return {'ai_score': ai_score, 'display_score': display_score}

def generate_ai_fusion_signal(df, fa_score):
    """
    AI èåˆä¿¡è™Ÿç”Ÿæˆæ¨¡å‹ã€‚
    æ ¹æ“šæŠ€è¡“é¢ã€åŸºæœ¬é¢æ•¸æ“šåŠ æ¬Šèåˆï¼Œç”¢ç”Ÿæœ€çµ‚è¡Œå‹•å»ºè­°ã€‚
    Args:
        df (pd.DataFrame): åŒ…å«æŠ€è¡“æŒ‡æ¨™çš„ DataFrameã€‚
        fa_score (int): åŸºæœ¬é¢ AI_SCOREã€‚
    Returns:
        dict: åŒ…å«ç¸½åˆ†ã€è¡Œå‹•å»ºè­°å’Œä¿¡å¿ƒæŒ‡æ•¸çš„å­—å…¸ã€‚
    """
    latest = df.iloc[-1]
    prev = df.iloc[-2]
    total_score = 0

    # 1. è¶¨å‹¢åˆ†æ•¸ (MA Score)
    ma_score = 0
    if latest['EMA_10'] > latest['EMA_50'] and prev['EMA_10'] <= prev['EMA_50']:
        ma_score = 3.5  # é»ƒé‡‘äº¤å‰
    elif latest['EMA_10'] < latest['EMA_50'] and prev['EMA_10'] >= prev['EMA_50']:
        ma_score = -3.5 # æ­»äº¡äº¤å‰
    elif latest['EMA_10'] > latest['EMA_50'] and latest['EMA_50'] > latest['EMA_200']:
        ma_score = 2.0   # å¼·å¤šé ­æ’åˆ—
    elif latest['EMA_10'] < latest['EMA_50'] and latest['EMA_50'] < latest['EMA_200']:
        ma_score = -2.0  # å¼·ç©ºé ­æ’åˆ—
    total_score += ma_score

    # 2. å‹•èƒ½åˆ†æ•¸ (Momentum Score)
    momentum_score = 0
    if latest['RSI_14'] < 40:
        momentum_score = 2.0 # è¶…è³£å€é–“ï¼Œæ½›åœ¨è²·å…¥
    elif latest['RSI_14'] > 60:
        momentum_score = -2.0 # è¶…è²·å€é–“ï¼Œæ½›åœ¨è³£å‡º
    total_score += momentum_score
        
    # 3. å¼·åº¦åˆ†æ•¸ (Strength Score)
    strength_score = 0
    if latest['MACDh_12_26_9'] > 0 and latest['MACDh_12_26_9'] > prev['MACDh_12_26_9']:
        strength_score = 1.5 # MACD æŸ±ç‹€åœ–æ”¾å¤§
    elif latest['MACDh_12_26_9'] < 0 and latest['MACDh_12_26_9'] < prev['MACDh_12_26_9']:
        strength_score = -1.5 # MACD æŸ±ç‹€åœ–ç¸®å°
    
    # ADX åŠ æ¬Š
    if latest['ADX_14'] > 25:
        strength_score *= 1.5
    total_score += strength_score

    # 4. Kç·šåˆ†æ•¸ (Kline Score)
    kline_score = 0
    body_size = abs(latest['Close'] - latest['Open'])
    if 'ATRr_14' in latest.index and body_size > 0.7 * latest['ATRr_14']:
        if latest['Close'] > latest['Open']:
            kline_score = 1.0 # å¤§é™½ç·š
        else:
            kline_score = -1.0 # å¤§é™°ç·š
    total_score += kline_score
    
    # 5. åŸºæœ¬é¢æ­£è¦åŒ–åˆ†æ•¸ (FA Normalized Score)
    # å°‡7åˆ†åˆ¶çš„åŸºæœ¬é¢åˆ†æ•¸è½‰æ›ç‚º -3 è‡³ +3 çš„å€é–“
    if fa_score > 0:
      fa_normalized_score = (fa_score / 7) * 3 
      total_score += fa_normalized_score

    # ç”¢ç”Ÿæœ€çµ‚è¡Œå‹•å»ºè­°
    if total_score >= 4.0:
        action = "è²·é€² (Buy)"
    elif 1.0 <= total_score < 4.0:
        action = "ä¸­æ€§åè²· (Hold/Buy)"
    elif -1.0 < total_score < 1.0:
        action = "è§€æœ› (Neutral)"
    elif -4.0 < total_score <= -1.0:
        action = "ä¸­æ€§åè³£ (Hold/Sell)"
    else:
        action = "è³£å‡º (Sell/Short)"

    # è¨ˆç®—ä¿¡å¿ƒæŒ‡æ•¸ (0-100)
    confidence = min(int(abs(total_score) / 8.0 * 100), 100)
        
    return {'total_score': round(total_score, 2), 'action': action, 'confidence': confidence}

def calculate_entry_price(action, latest):
    """
    (NEW v1.4.0) æ ¹æ“š AI è¡Œå‹•å»ºè­°è¨ˆç®—å»ºè­°çš„å…¥å ´åƒ¹ä½ã€‚
    Args:
        action (str): AI çš„è¡Œå‹•å»ºè­° (e.g., "è²·é€² (Buy)")
        latest (pd.Series): æœ€æ–°ä¸€ç­†åŒ…å«æŒ‡æ¨™çš„æ•¸æ“š
    Returns:
        float or str: è¨ˆç®—å‡ºçš„å…¥å ´åƒ¹æˆ– "N/A"
    """
    entry_price = "N/A"
    # å¤šé ­è¨Šè™Ÿï¼šå»ºè­°åœ¨å°å¹…å›èª¿æ™‚è²·å…¥ (åƒè€ƒ EMA_10 æˆ– ATR)
    if 'Buy' in action:
        if 'EMA_10' in latest.index and pd.notna(latest['EMA_10']):
            entry_price = latest['EMA_10']
        elif 'ATRr_14' in latest.index and pd.notna(latest['ATRr_14']):
            entry_price = latest['Close'] - 0.25 * latest['ATRr_14']
        else: # å‚™ç”¨æ–¹æ¡ˆ
            entry_price = latest['Close'] * 0.995
    # ç©ºé ­è¨Šè™Ÿï¼šå»ºè­°åœ¨å°å¹…åå½ˆæ™‚è³£å‡º (åƒè€ƒ EMA_10 æˆ– ATR)
    elif 'Sell' in action:
        if 'EMA_10' in latest.index and pd.notna(latest['EMA_10']):
            entry_price = latest['EMA_10']
        elif 'ATRr_14' in latest.index and pd.notna(latest['ATRr_14']):
            entry_price = latest['Close'] + 0.25 * latest['ATRr_14']
        else: # å‚™ç”¨æ–¹æ¡ˆ
            entry_price = latest['Close'] * 1.005
    
    if isinstance(entry_price, (int, float)):
        return round(entry_price, 2)
    return entry_price

def calculate_risk_management(df):
    """
    å¤šç­–ç•¥å…±è­˜æ­¢ç›ˆæ­¢æè¨ˆç®—ã€‚
    Args:
        df (pd.DataFrame): åŒ…å«æŒ‡æ¨™çš„ DataFrameã€‚
    Returns:
        dict: åŒ…å«å…±è­˜æ­¢ç›ˆ (TP) å’Œæ­¢æ (SL) åƒ¹ä½çš„å­—å…¸ã€‚
    """
    latest = df.iloc[-1]
    sl_prices, tp_prices = [], []

    # ç­–ç•¥1: ATR åœæ
    if 'ATRr_14' in latest.index and pd.notna(latest['ATRr_14']):
        sl_prices.append(latest['Close'] - 2 * latest['ATRr_14'])
        tp_prices.append(latest['Close'] + 2 * latest['ATRr_14'])

    # ç­–ç•¥2: å¸ƒæ—é€šé“
    if 'BBL_20_2.0' in latest.index and 'BBU_20_2.0' in latest.index:
        sl_prices.append(latest['BBL_20_2.0'])
        tp_prices.append(latest['BBU_20_2.0'])
    
    # ç­–ç•¥3: å‰æœŸé«˜ä½é» (è¿‘30æ ¹Kæ£’)
    if len(df) >= 30:
        recent_df = df.iloc[-30:]
        sl_prices.append(recent_df['Low'].min())
        tp_prices.append(recent_df['High'].max())
    elif not df.empty:
        sl_prices.append(df['Low'].min())
        tp_prices.append(df['High'].max())

    # å¦‚æœæ²’æœ‰ä»»ä½•ç­–ç•¥æˆåŠŸè¨ˆç®—ï¼Œå‰‡æä¾›ä¸€å€‹åŸºæ–¼ç•¶å‰åƒ¹æ ¼çš„å‚™ç”¨æ–¹æ¡ˆ
    if not sl_prices or not tp_prices:
        fallback_atr = latest.get('ATRr_14', latest['Close'] * 0.05)
        if pd.isna(fallback_atr): fallback_atr = latest['Close'] * 0.05
        
        sl = latest['Close'] - 2 * fallback_atr
        tp = latest['Close'] + 2 * fallback_atr
        return {'sl': round(sl, 2), 'tp': round(tp, 2)}

    # å…±è­˜åƒ¹è¨ˆç®—æ¼”ç®—æ³•
    consensus_sl = np.mean(sorted(sl_prices, reverse=True)[:2])
    consensus_tp = np.mean(sorted(tp_prices)[:2])

    return {'sl': round(consensus_sl, 2), 'tp': round(consensus_tp, 2)}

def run_backtest(df):
    """
    ç­–ç•¥å›æ¸¬å¼•æ“: SMA 20 / EMA 50 å‡ç·šäº¤å‰ç­–ç•¥ã€‚
    Args:
        df (pd.DataFrame): åŒ…å«æŒ‡æ¨™çš„ DataFrameã€‚
    Returns:
        dict: åŒ…å«å›æ¸¬çµæœæŒ‡æ¨™èˆ‡è³‡é‡‘æ›²ç·šçš„å­—å…¸ã€‚
    """
    # ç¢ºä¿æŒ‡æ¨™å­˜åœ¨
    if 'EMA_50' not in df.columns:
        df.ta.ema(length=50, append=True)
    
    # ç‚ºäº†å›æ¸¬ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹çŸ­æœŸçš„SMA
    df['SMA_20'] = ta.sma(df['Close'], length=20)
    df.dropna(inplace=True)
    
    if df.empty:
        return {'total_return': 0, 'win_rate': 0, 'max_drawdown': 0, 'trades_count': 0, 'equity_curve': pd.Series([1.0])}

    # ç”¢ç”Ÿäº¤æ˜“ä¿¡è™Ÿ
    df['signal'] = 0
    df.loc[(df['SMA_20'] > df['EMA_50']) & (df['SMA_20'].shift(1) <= df['EMA_50'].shift(1)), 'signal'] = 1  # è²·é€²
    df.loc[(df['SMA_20'] < df['EMA_50']) & (df['SMA_20'].shift(1) >= df['EMA_50'].shift(1)), 'signal'] = -1 # è³£å‡º

    # åŸ·è¡Œå›æ¸¬
    position = 0
    trades = []
    entry_price = 0
    for i, row in df.iterrows():
        if position == 0 and row['signal'] == 1:
            position = 1
            entry_price = row['Close']
        elif position == 1 and row['signal'] == -1:
            position = 0
            exit_price = row['Close']
            trades.append((exit_price / entry_price) - 1)

    if not trades:
        return {'total_return': 0, 'win_rate': 0, 'max_drawdown': 0, 'trades_count': 0, 'equity_curve': pd.Series([1.0])}
        
    # è¨ˆç®—å›æ¸¬æŒ‡æ¨™
    trades_count = len(trades)
    wins = [t for t in trades if t > 0]
    win_rate = len(wins) / trades_count * 100 if trades_count > 0 else 0
    
    # è¨ˆç®—è³‡é‡‘æ›²ç·šå’Œç¸½å›å ±
    equity = (pd.Series(trades) + 1).cumprod()
    total_return = (equity.iloc[-1] - 1) * 100 if not equity.empty else 0

    # è¨ˆç®—æœ€å¤§å›æ’¤
    peak = equity.cummax()
    drawdown = (equity - peak) / peak
    max_drawdown = abs(drawdown.min()) * 100

    return {
        'total_return': round(total_return, 2),
        'win_rate': round(win_rate, 2),
        'max_drawdown': round(max_drawdown, 2),
        'trades_count': trades_count,
        'equity_curve': equity
    }

# --- 3. Streamlit ä½¿ç”¨è€…ä»‹é¢ (UI) ---

# --- å´é‚Šæ¬„æ§åˆ¶é … ---
with st.sidebar:
    st.image("https://storage.googleapis.com/gemini-prod/images/workspace_icon_for_light_background.png", width=80)
    st.header("âš™ï¸ åˆ†æè¨­å®š")
    
    # 1. è³‡ç”¢é¸æ“‡
    st.subheader("1. é¸æ“‡åˆ†æè³‡ç”¢")
    asset_category = st.selectbox("è³‡ç”¢é¡åˆ¥", list(FULL_SYMBOLS_MAP.keys()))
    
    popular_assets = {f"{symbol} ({details['name']})": symbol for symbol, details in FULL_SYMBOLS_MAP[asset_category].items()}
    selected_popular = st.selectbox("ç†±é–€æ¨™çš„", list(popular_assets.keys()))
    
    manual_input = st.text_input("æˆ–æ‰‹å‹•è¼¸å…¥ä»£ç¢¼ (å„ªå…ˆä½¿ç”¨)", placeholder="ä¾‹å¦‚: 2330.TW, TSLA")

    # (FIXED v1.2.0) æ±ºå®šæœ€çµ‚åˆ†æçš„ symbol, ä¿®æ­£UIé‚è¼¯
    # åªæœ‰ç•¶ manual_input éç©ºæ™‚æ‰å„ªå…ˆä½¿ç”¨
    if manual_input.strip():
        final_symbol = manual_input.strip().upper()
        # å˜—è©¦å¾ map ä¸­æ‰¾åˆ°åç¨±
        try:
           # æœå°‹æ‰€æœ‰é¡åˆ¥ä»¥æ‰¾åˆ°åŒ¹é…çš„ä»£ç¢¼
           all_symbols = {s: d['name'] for cat in FULL_SYMBOLS_MAP.values() for s, d in cat.items()}
           final_symbol_name = all_symbols.get(final_symbol, "")
        except Exception:
           final_symbol_name = ""
    else:
        final_symbol = popular_assets[selected_popular]
        final_symbol_name = FULL_SYMBOLS_MAP[asset_category][final_symbol]['name']
        
    st.info(f"ç•¶å‰ç›®æ¨™: **{final_symbol} ({final_symbol_name})**")

    # 2. é€±æœŸè¨­å®š
    st.subheader("2. é¸æ“‡åˆ†æé€±æœŸ")
    selected_period_label = st.selectbox("æ™‚é–“é€±æœŸ", list(PERIOD_MAP.keys()))
    period_params = PERIOD_MAP[selected_period_label]

    # 3. åŸ·è¡Œåˆ†æ
    st.subheader("3. åŸ·è¡Œåˆ†æ")
    start_analysis = st.button("ğŸ“Š åŸ·è¡Œ AI åˆ†æ", use_container_width=True, type="primary")

# --- ä¸»ç•«é¢é¡¯ç¤ºå€ ---
st.title("ğŸš€ AI è¶¨å‹¢åˆ†æå°ˆå®¶ç³»çµ±")
st.caption(f"æ•¸æ“šæ›´æ–°æ™‚é–“: {pd.Timestamp.now('Asia/Taipei').strftime('%Y-%m-%d %H:%M:%S CST')}")

if start_analysis:
    with st.spinner('AI åˆ†æå¼•æ“å•Ÿå‹•ä¸­ï¼Œè«‹ç¨å€™...'):
        # æ­¥é©Ÿ 1: ç²å–æ•¸æ“š
        data = get_data(final_symbol, period_params['period'], period_params['interval'])

        if data is not None and not data.empty:
            # æ­¥é©Ÿ 2: è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
            data_with_indicators = calculate_indicators(data.copy())
            
            if data_with_indicators.empty or len(data_with_indicators) < 2:
                st.error("éŒ¯èª¤ï¼šè¨ˆç®—æŠ€è¡“æŒ‡æ¨™å¾Œç„¡æœ‰æ•ˆæ•¸æ“šï¼Œå¯èƒ½æ˜¯æ­·å²æ•¸æ“šéçŸ­ã€‚è«‹å˜—è©¦æ›´é•·çš„åˆ†æé€±æœŸã€‚")
            else:
                # æ­¥é©Ÿ 3: ç²å–åŸºæœ¬é¢æ•¸æ“šèˆ‡è©•åˆ†
                funda_data = get_fundamental_data(final_symbol)
                funda_scores = calculate_fundamental_scores(funda_data['info'])
                
                # æ­¥é©Ÿ 4: ç”Ÿæˆ AI èåˆä¿¡è™Ÿ
                ai_signal = generate_ai_fusion_signal(data_with_indicators, funda_scores['ai_score'])
                
                # æ­¥é©Ÿ 5: è¨ˆç®—é¢¨éšªç®¡ç†èˆ‡å…¥å ´åƒ¹ä½
                risk_levels = calculate_risk_management(data_with_indicators)
                entry_price = calculate_entry_price(ai_signal['action'], data_with_indicators.iloc[-1])
                
                # æ­¥é©Ÿ 6: åŸ·è¡Œç­–ç•¥å›æ¸¬
                backtest_results = run_backtest(data_with_indicators.copy())

                # ----------------------------------------
                # --- åˆ†æçµæœé é¢ä½ˆå±€ (ç·šæ€§å ±å‘Šæ ¼å¼) ---
                # ----------------------------------------
                
                st.markdown("---")
                
                # 1. ä¸»æ¨™é¡Œ
                funda_rating = f"åŸºæœ¬é¢è©•ç´š: {funda_scores['display_score']}/9" if funda_scores['display_score'] > 0 else "åŸºæœ¬é¢è©•ç´š: N/A"
                st.header(f"ğŸ“ˆ {final_symbol_name} ({final_symbol}) - {selected_period_label} åˆ†æå ±å‘Š")
                st.subheader(funda_rating)
                
                st.markdown("---")

                # 2. æ ¸å¿ƒè¡Œå‹•èˆ‡é‡åŒ–è©•åˆ†
                st.subheader("ğŸ¯ æ ¸å¿ƒè¡Œå‹•èˆ‡é‡åŒ–è©•åˆ†")
                col1, col2, col3, col4 = st.columns(4)
                col1.metric("ç•¶å‰åƒ¹æ ¼", f"{data_with_indicators['Close'].iloc[-1]:,.2f}")
                col2.metric("æœ€çµ‚è¡Œå‹•å»ºè­°", ai_signal['action'])
                col3.metric("ç¸½é‡åŒ–è©•åˆ†", f"{ai_signal['total_score']:.2f}")
                col4.metric("ä¿¡å¿ƒæŒ‡æ•¸", f"{ai_signal['confidence']}%")
                
                # 3. ç²¾ç¢ºäº¤æ˜“ç­–ç•¥èˆ‡é¢¨éšªæ§åˆ¶
                st.subheader("ğŸ›¡ï¸ ç²¾ç¢ºäº¤æ˜“ç­–ç•¥èˆ‡é¢¨éšªæ§åˆ¶")
                # (UPDATED v1.4.0) æ–°å¢ç¬¬å››æ¬„é¡¯ç¤ºå»ºè­°å…¥å ´åƒ¹
                col1, col2, col3, col4 = st.columns(4)
                col1.metric("å»ºè­°æ“ä½œ", ai_signal['action'].split(" ")[0])
                col2.metric("å»ºè­°å…¥å ´åƒ¹", f"{entry_price:,.2f}" if isinstance(entry_price, (int, float)) else "N/A")
                col3.metric("å…±è­˜æ­¢ç›ˆåƒ¹ (TP)", f"{risk_levels['tp']:,.2f}", delta=f"{((risk_levels['tp']/data_with_indicators['Close'].iloc[-1])-1)*100:.2f}%")
                col4.metric("å…±è­˜æ­¢æåƒ¹ (SL)", f"{risk_levels['sl']:,.2f}", delta=f"{((risk_levels['sl']/data_with_indicators['Close'].iloc[-1])-1)*100:.2f}%", delta_color="inverse")
                
                st.markdown("---")
                
                col_main, col_side = st.columns([2,1])
                
                with col_main:
                    # 4. é—œéµæŠ€è¡“æŒ‡æ¨™æ•¸æ“šèˆ‡AIåˆ¤è®€
                    st.subheader("ğŸ”¬ é—œéµæŠ€è¡“æŒ‡æ¨™æ•¸æ“š")
                    latest_indicators = data_with_indicators.iloc[-1]
                    
                    bbl_val = latest_indicators.get('BBL_20_2.0')
                    bbu_val = latest_indicators.get('BBU_20_2.0')
                    
                    bbl_str = f"{bbl_val:.1f}" if isinstance(bbl_val, (int, float)) else "N/A"
                    bbu_str = f"{bbu_val:.1f}" if isinstance(bbu_val, (int, float)) else "N/A"
                    bollinger_str = f"{bbl_str} - {bbu_str}"

                    if isinstance(bbl_val, (int, float)) and isinstance(bbu_val, (int, float)) and latest_indicators.get('Close', 1) > 0:
                        band_width = (bbu_val - bbl_val) / latest_indicators.get('Close', 1)
                        volatility_judgement = "æ³¢å‹•æ”¾å¤§" if band_width > 0.05 else "æ³¢å‹•æ”¶æ–‚"
                    else:
                        volatility_judgement = "N/A"

                    indicators_df = pd.DataFrame({
                        'æŒ‡æ¨™': ['RSI (14)', 'MACD (12,26,9)', 'ADX (14)', 'CMF (20)', 'å¸ƒæ—é€šé“'],
                        'æ•¸å€¼': [
                            f"{latest_indicators.get('RSI_14', 'N/A'):.2f}",
                            f"{latest_indicators.get('MACD_12_26_9', 'N/A'):.2f}",
                            f"{latest_indicators.get('ADX_14', 'N/A'):.2f}",
                            f"{latest_indicators.get('CMF_20', 'N/A'):.2f}",
                            bollinger_str
                        ],
                        'AI åˆ¤è®€': [
                            "è¶¨æ–¼è¶…è²·" if latest_indicators.get('RSI_14', 50) > 65 else ("è¶¨æ–¼è¶…è³£" if latest_indicators.get('RSI_14', 50) < 35 else "ä¸­æ€§"),
                            "å¤šé ­" if latest_indicators.get('MACDh_12_26_9', 0) > 0 else "ç©ºé ­",
                            "å¼·è¶¨å‹¢" if latest_indicators.get('ADX_14', 0) > 25 else "ç›¤æ•´",
                            "è³‡é‡‘æµå…¥" if latest_indicators.get('CMF_20', 0) > 0 else "è³‡é‡‘æµå‡º",
                            volatility_judgement
                        ]
                    })
                    st.table(indicators_df)

                with col_side:
                    # æœ€æ–°ç›¸é—œæ–°è
                    st.subheader("ğŸ“° æœ€æ–°ç›¸é—œæ–°è")
                    # (UPDATED v1.4.0) æ–°èæ¨™é¡Œæ”¹ç‚ºå¯é»æ“Šçš„è¶…é€£çµ
                    for news_item in funda_data['news']:
                        title = news_item.get('title', 'æ–°èæ¨™é¡Œä¸å¯ç”¨')
                        link = news_item.get('link')
                        if link:
                            st.markdown(f"- [{title}]({link})")
                        else:
                            st.markdown(f"- {title}")
                
                st.markdown("---")

                # 5. ç­–ç•¥å›æ¸¬å ±å‘Š
                st.subheader(f"ğŸ”™ ç­–ç•¥å›æ¸¬å ±å‘Š (SMA 20 / EMA 50 äº¤å‰)")
                col1, col2, col3, col4 = st.columns(4)
                col1.metric("ç¸½å›å ±ç‡", f"{backtest_results['total_return']:.2f}%")
                col2.metric("å‹ç‡", f"{backtest_results['win_rate']:.2f}%")
                col3.metric("æœ€å¤§å›æ’¤", f"{backtest_results['max_drawdown']:.2f}%")
                col4.metric("ç¸½äº¤æ˜“æ¬¡æ•¸", backtest_results['trades_count'])
                
                # è³‡é‡‘æ›²ç·šåœ–
                if backtest_results['trades_count'] > 0:
                    equity_curve = (backtest_results['equity_curve'] + 1)
                    equity_fig = go.Figure()
                    equity_fig.add_trace(go.Scatter(x=equity_curve.index, y=equity_curve.values, mode='lines', name='Equity'))
                    equity_fig.update_layout(title='è³‡é‡‘æ›²ç·šåœ–', xaxis_title='äº¤æ˜“æ¬¡æ•¸', yaxis_title='ç´¯è¨ˆå›å ±')
                    st.plotly_chart(equity_fig, use_container_width=True)
                
                st.markdown("---")

                # 6. å®Œæ•´æŠ€è¡“åˆ†æåœ–è¡¨
                st.subheader("ğŸ“Š å®Œæ•´æŠ€è¡“åˆ†æåœ–è¡¨")
                
                # å»ºç«‹åŒ…å«4å€‹å­åœ–çš„åœ–è¡¨
                fig = make_subplots(rows=4, cols=1, shared_xaxes=True, 
                                    vertical_spacing=0.03, row_heights=[0.5, 0.15, 0.15, 0.2])

                # åœ– 1: Kç·šèˆ‡ç§»å‹•å¹³å‡ç·š
                fig.add_trace(go.Candlestick(x=data_with_indicators.index,
                                             open=data_with_indicators['Open'],
                                             high=data_with_indicators['High'],
                                             low=data_with_indicators['Low'],
                                             close=data_with_indicators['Close'], name='Kç·š'), row=1, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['EMA_10'], mode='lines', name='EMA 10', line=dict(color='orange', width=1)), row=1, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['EMA_50'], mode='lines', name='EMA 50', line=dict(color='blue', width=1)), row=1, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['EMA_200'], mode='lines', name='EMA 200', line=dict(color='purple', width=2, dash='dash')), row=1, col=1)
                
                # åœ– 2: æˆäº¤é‡
                fig.add_trace(go.Bar(x=data_with_indicators.index, y=data_with_indicators['Volume'], name='æˆäº¤é‡'), row=2, col=1)

                # åœ– 3: MACD
                fig.add_trace(go.Bar(x=data_with_indicators.index, y=data_with_indicators['MACDh_12_26_9'], name='MACD Histogram'), row=3, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['MACD_12_26_9'], mode='lines', name='MACD', line=dict(color='blue', width=1)), row=3, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['MACDs_12_26_9'], mode='lines', name='Signal', line=dict(color='orange', width=1)), row=3, col=1)

                # åœ– 4: RSI
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['RSI_14'], mode='lines', name='RSI 14'), row=4, col=1)
                fig.add_hline(y=70, line_dash="dash", row=4, col=1, line_color="red")
                fig.add_hline(y=30, line_dash="dash", row=4, col=1, line_color="green")
                
                # æ›´æ–°åœ–è¡¨ä½ˆå±€
                fig.update_layout(
                    height=800,
                    xaxis_rangeslider_visible=False,
                    legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1)
                )
                fig.update_yaxes(title_text="åƒ¹æ ¼", row=1, col=1)
                fig.update_yaxes(title_text="æˆäº¤é‡", row=2, col=1)
                fig.update_yaxes(title_text="MACD", row=3, col=1)
                fig.update_yaxes(title_text="RSI", row=4, col=1)

                st.plotly_chart(fig, use_container_width=True)
else:
    st.info("è«‹åœ¨å·¦å´è¨­å®šåˆ†æåƒæ•¸ï¼Œç„¶å¾Œé»æ“Šã€ŒåŸ·è¡Œ AI åˆ†æã€æŒ‰éˆ•ã€‚")
    st.markdown("---")
    st.subheader("ğŸ“– æ‡‰ç”¨ç¨‹å¼èªªæ˜")
    st.markdown("""
    æœ¬æ‡‰ç”¨ç¨‹å¼æ˜¯ä¸€å€‹åŸºæ–¼å°ˆå®¶ç³»çµ±è¦å‰‡çš„ AI é‡‘èè¶¨å‹¢åˆ†æå·¥å…·ã€‚å®ƒæ•´åˆäº†å¤šå€‹ç¶­åº¦çš„å¸‚å ´æ•¸æ“šï¼Œç‚ºæ‚¨æä¾›ä¸€å€‹å…¨é¢çš„å¸‚å ´è¦–åœ–ã€‚
    
    **åŠŸèƒ½äº®é»:**
    - **AI èåˆä¿¡è™Ÿ**: çµåˆæŠ€è¡“ã€åŸºæœ¬é¢ã€å‹•èƒ½ç­‰å¤šå€‹é¢å‘ï¼Œç”¢ç”Ÿå…·é«”çš„è²·è³£å»ºè­°èˆ‡é‡åŒ–è©•åˆ†ã€‚
    - **å¤šç­–ç•¥å…±è­˜é¢¨æ§**: é€éé‹è¡Œå¤šç¨®ç®—æ³•ï¼Œè¨ˆç®—å‡ºç©©å¥çš„æ­¢ç›ˆ(TP)èˆ‡æ­¢æ(SL)åƒè€ƒåƒ¹ä½ã€‚
    - **è‡ªå‹•åŒ–å›æ¸¬**: å…§å»ºæ¨™æº–å‡ç·šäº¤å‰ç­–ç•¥ï¼Œè©•ä¼°è©²ç­–ç•¥åœ¨æ­·å²æ•¸æ“šä¸Šçš„è¡¨ç¾ã€‚
    - **äº’å‹•å¼åœ–è¡¨**: æä¾›åŒ…å«å¤šç¨®é—œéµæŒ‡æ¨™çš„ç¶œåˆ K ç·šåœ–ï¼ŒåŠ©æ‚¨æ·±å…¥æ´å¯Ÿå¸‚å ´å‹•æ…‹ã€‚

    **ä½¿ç”¨æ­¥é©Ÿ:**
    1. åœ¨å·¦å´é‚Šæ¬„é¸æ“‡æ‚¨æ„Ÿèˆˆè¶£çš„ **è³‡ç”¢é¡åˆ¥** (ç¾è‚¡ã€å°è‚¡ã€åŠ å¯†è²¨å¹£)ã€‚
    2. å¾ **ç†±é–€æ¨™çš„** ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ï¼Œæˆ– **æ‰‹å‹•è¼¸å…¥** æ‚¨æƒ³åˆ†æçš„è‚¡ç¥¨/åŠ å¯†è²¨å¹£ä»£ç¢¼ã€‚
    3. é¸æ“‡æ‚¨æƒ³åˆ†æçš„ **æ™‚é–“é€±æœŸ**ï¼Œå¾çŸ­ç·šäº¤æ˜“åˆ°é•·ç·šæŠ•è³‡ã€‚
    4. é»æ“Š **[ğŸ“Š åŸ·è¡Œ AI åˆ†æ]** æŒ‰éˆ•ï¼Œç¨å¾…ç‰‡åˆ»å³å¯ç²å¾—å®Œæ•´çš„åˆ†æå ±å‘Šã€‚

    **å…è²¬è²æ˜:**
    æœ¬å·¥å…·æä¾›çš„æ‰€æœ‰è³‡è¨Šèˆ‡åˆ†æçµæœåƒ…ä¾›ç ”ç©¶å’Œåƒè€ƒï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ã€‚ä½¿ç”¨è€…æ‡‰è‡ªè¡Œæ‰¿æ“”æ‰€æœ‰æŠ•è³‡é¢¨éšªã€‚
    """)
