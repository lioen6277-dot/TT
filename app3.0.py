# -*- coding: utf-8 -*-
"""
AI è¶¨å‹¢åˆ†æ Streamlit æ‡‰ç”¨ç¨‹å¼
å°ˆå®¶å¢å¼·æœ€çµ‚ç‰ˆå¯¦ä½œ (V12.2 - Final Stable Version)

æœ¬æ‡‰ç”¨ç¨‹å¼æ ¹æ“šä¸€ä»½è©³ç´°çš„é‡‘èåˆ†æå·¥å…·è¨­å®šæ–‡ä»¶é€²è¡Œé–‹ç™¼ï¼Œä¸¦èåˆäº†å°ˆæ¥­ç´šçš„
app2.0.py è¨­è¨ˆ logique èˆ‡ä½¿ç”¨è€…æä¾›çš„ UI è¦–è¦ºè¨­è¨ˆç¨¿ï¼Œæ—¨åœ¨æä¾›ä¸€å€‹å¤–è§€ç²¾ç¾ã€
äº’å‹•å°ˆæ¥­çš„æ±ºç­–å„€è¡¨æ¿ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š
- [ç©©å®šæ€§ä¿®å¾©] æ–°å¢ scipy ä¾è³´ï¼Œä¿®å¾© ModuleNotFoundError
- [ç©©å®šæ€§ä¿®å¾©] ä¿®å¾© UnboundLocalError ä¸¦æ¢å¾©æ‰€æœ‰å„€è¡¨æ¿å€å¡Š
- [é ‚ç´šç­–ç•¥] å¼•å…¥ã€Œå¤šé€±æœŸè¶¨å‹¢ç¢ºèªã€åˆ†æå¼•æ“
- [é ‚ç´šç­–ç•¥] æ•´åˆã€Œæ–æ³¢é‚£å¥‘å›æ¸¬ã€ä½œç‚ºå‹•æ…‹æ­¢ç›ˆæ­¢ææ¨¡å‹
- [ç­–ç•¥å‡ç´š] æ›´æ–° MACD æ ¸å¿ƒåƒæ•¸ç‚º (9, 16, 5)
- [UI å„ªåŒ–] ç‚º AI å°ˆå®¶ç¸½çµçš„è¡Œå‹•å»ºè­°æ·»åŠ é¡è‰²æ¨™è¨˜
- [ç­–ç•¥å‡ç´š] å°‡ RSI è¶…è²·/è¶…è³£é–¾å€¼çµ±ä¸€èª¿æ•´ç‚º 80/20
- [å°ˆå®¶åœ–è¡¨ Pro] ç‚ºæŒ‡æ¨™åœ–è¡¨åŠ å…¥é—œéµæ°´å¹³ç·šèˆ‡ AI è¨»è§£
- [ç©©å®šæ€§å¼·åŒ–] æé«˜æ•¸æ“šé©—è­‰é–€æª»
- [å°ˆå®¶å‡ç´š] å¼•å…¥å‹•æ…‹é©æ‡‰åŠŸèƒ½

é–‹ç™¼è€…ï¼šç¨‹å¼ç¢¼å°ˆå®¶ (Generated by Gemini)
ç‰ˆæœ¬ï¼š12.2.0 (Final Stable)
"""

# è¼‰å…¥æ ¸å¿ƒå¥—ä»¶
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import ta
import warnings
import time
import re 
from datetime import datetime, timedelta
from scipy.stats import linregress
# å¿½ç•¥æ‰€æœ‰è­¦å‘Šï¼Œä½¿è¼¸å‡ºæ›´ä¹¾æ·¨
warnings.filterwarnings('ignore')

# ==============================================================================
# 1. é é¢é…ç½®èˆ‡å…¨å±€è¨­å®š
# ==============================================================================

# é€±æœŸæ˜ å°„ï¼š(YFinance Period, YFinance Interval)
PERIOD_MAP = { 
    "30 åˆ†": ("60d", "30m"), 
    "4 å°æ™‚": ("1y", "60m"), 
    "1 æ—¥": ("5y", "1d"), 
    "1 é€±": ("max", "1wk")
}

# ğŸš€ æ‚¨çš„ã€æ‰€æœ‰è³‡ç”¢æ¸…å–®ã€‘ (åƒ…ç¤ºç¯„ç”¨ï¼Œå¯æ“´å……)
FULL_SYMBOLS_MAP = {
    # B. å°è‚¡æ ¸å¿ƒ (TW Stocks) - å€‹è‚¡èˆ‡ ETF
    "2330.TW": {"name": "å°ç©é›»", "keywords": ["å°ç©é›»", "åŠå°é«”", "TSMC"]},
    "2454.TW": {"name": "è¯ç™¼ç§‘", "keywords": ["è¯ç™¼ç§‘", "MTK"]},
    "0050.TW": {"name": "å…ƒå¤§å°ç£50", "keywords": ["å…ƒå¤§å°ç£50", "0050", "ETF"]},
    # C. åŠ å¯†è²¨å¹£ (Crypto) - éœ€æ‰‹å‹•æ·»åŠ ï¼Œæˆ–ä½¿ç”¨ Streamlit æ¬„ä½è¼¸å…¥
    "BTC-USD": {"name": "æ¯”ç‰¹å¹£", "keywords": ["æ¯”ç‰¹å¹£", "BTC"]},
    "ETH-USD": {"name": "ä»¥å¤ªåŠ", "keywords": ["ä»¥å¤ªåŠ", "ETH"]},
}

# æŠ€è¡“æŒ‡æ¨™åƒæ•¸è¨­å®š (æ ¸å¿ƒç­–ç•¥é‚è¼¯)
MACD_FAST = 9
MACD_SLOW = 16
MACD_SIGNAL = 5
RSI_PERIOD = 14
RSI_OVERSOLD = 20
RSI_OVERBOUGHT = 80
STOCH_K_PERIOD = 14
STOCH_D_PERIOD = 3
STOCH_OVERSOLD = 20
STOCH_OVERBOUGHT = 80

# --- é¡è‰²èˆ‡æ¨£å¼å®šç¾© (æ¡ç”¨æ–°çš„ UI è¦–è¦ºè¨­è¨ˆ) ---
MAIN_COLOR = "#cf6955"  # æ³°å€«è¯é‚¦ä¸»è‰²ï¼šé®­é­šç²‰/çŠç‘šç´…
ACCENT_COLOR = "#e9967a" # æ³°å€«è¯é‚¦è¼”è‰²ï¼šäº®é®­é­šè‰²
TEXT_COLOR = "#ffffff"
LABEL_COLOR = "#b0b0b0"
DARK_BG = "#1a1a1a"
TILE_BG = "#1e2126"


st.set_page_config(
    page_title="è»Œé“å¸ä»¤éƒ¨ï¼šæˆ°è¡“æƒæ (O.C.T.S.) - V4.3", 
    page_icon="ğŸ›°ï¸", 
    layout="wide"
)

# æ‡‰ç”¨æ–°çš„ CSS æ¨£å¼
st.markdown(f"""
<style>
.stApp {{
    font-size: 1.05rem;
    color: {TEXT_COLOR};
    background-color: #0e1117;
}}
h1 {{
    font-size: 2.2em !important;
    color: {MAIN_COLOR} !important;
    font-weight: bold !important;
    margin-bottom: 0.5rem !important;
    text-shadow: 0 0 5px rgba(207, 105, 85, 0.5);
    padding-top: 1rem;
}}
.sub-card-tile {{
    background: {TILE_BG};
    border-radius: 8px;
    padding: 1.2rem;
    height: 100%;
    margin-bottom: 1rem;
    transition: all 0.2s ease-in-out;
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}}
.highlight-tile {{
    background: {TILE_BG};
    border-radius: 8px;
    padding: 1.2rem;
    height: 100%;
    margin-bottom: 1rem;
    border: 2px solid {ACCENT_COLOR};
    box-shadow: 0 0 15px rgba(233, 150, 122, 0.7);
    background: linear-gradient(145deg, #1e2126, #24282c);
}}
.label-text {{
    font-size: 0.9em;
    color: {LABEL_COLOR};
    font-weight: 500;
    margin-bottom: 0.5rem;
    line-height: 1.2;
    text-transform: uppercase;
}}
.value-text-regular {{
    color: {TEXT_COLOR};
    font-size: 1.7em;
    font-weight: bold;
}}
.value-text-highlight {{
    color: {ACCENT_COLOR};
    font-size: 2.3em;
    font-weight: 900;
    text-shadow: 0 0 8px rgba(233, 150, 122, 0.5);
    line-height: 1;
}}
.card-section-header {{
    color: {MAIN_COLOR};
    font-weight: bold;
    font-size: 1.4em;
    padding: 0.7rem 0 0.7rem 0.5rem;
    margin-top: 1.5rem;
    margin-bottom: 0.8rem;
    border-bottom: 2px solid {MAIN_COLOR};
    text-transform: uppercase;
}}
.stSidebar > div:first-child {{
    background-color: {DARK_BG};
    border-right: 2px solid {MAIN_COLOR};
}}
.stSidebar h2 {{
    color: {MAIN_COLOR} !important;
    border-bottom: 1px solid rgba(207, 105, 85, 0.5);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}}
.stSidebar .stNumberInput label p, .stSidebar .stSelectbox label p, .stSidebar .stRadio label p {{
    color: {LABEL_COLOR} !important;
    font-weight: 500;
}}
/* è®“æŒ‰éˆ•ç¬¦åˆä¸»é¡Œè‰²èª¿ */
.stButton>button {{
    background-color: {MAIN_COLOR} !important;
    color: {TEXT_COLOR} !important;
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    transition: all 0.2s;
}}
.stButton>button:hover {{
    background-color: {ACCENT_COLOR} !important;
    box-shadow: 0 0 10px rgba(233, 150, 122, 0.7);
}}
</style>
""", unsafe_allow_html=True)


# ==============================================================================
# 2. æ•¸æ“šç²å–èˆ‡è™•ç†
# ==============================================================================

@st.cache_data(ttl=60*60*4) # 4å°æ™‚ç·©å­˜
def fetch_data(symbol, period, interval):
    """
    å¾ YFinance ç²å–æ­·å²æ•¸æ“šï¼Œä¸¦æ·»åŠ æŠ€è¡“æŒ‡æ¨™ã€‚
    """
    try:
        # ä½¿ç”¨ pbar=False é¿å… Streamlit è­¦å‘Š
        data = yf.download(symbol, period=period, interval=interval, progress=False)
        
        if data.empty or len(data) < 20: # æé«˜æ•¸æ“šé©—è­‰é–€æª»
            return pd.DataFrame(), f"âŒ éŒ¯èª¤ï¼šæ•¸æ“šä¸è¶³æˆ–ä»£è™ŸéŒ¯èª¤ ({symbol})ã€‚è«‹æª¢æŸ¥ä»£ç¢¼æˆ–èª¿æ•´æ™‚é–“é€±æœŸã€‚"

        df = data.copy()
        
        # --- æ ¸å¿ƒæŠ€è¡“æŒ‡æ¨™è¨ˆç®— ---
        # 1. MACD (Moving Average Convergence Divergence)
        df['MACD'] = ta.trend.macd(df['Close'], window_fast=MACD_FAST, window_slow=MACD_SLOW, fillna=True)
        df['MACD_Signal'] = ta.trend.macd_signal(df['Close'], window_fast=MACD_FAST, window_slow=MACD_SLOW, window_sign=MACD_SIGNAL, fillna=True)
        df['MACD_Hist'] = ta.trend.macd_diff(df['Close'], window_fast=MACD_FAST, window_slow=MACD_SLOW, window_sign=MACD_SIGNAL, fillna=True)

        # 2. RSI (Relative Strength Index)
        df['RSI'] = ta.momentum.rsi(df['Close'], window=RSI_PERIOD, fillna=True)
        
        # 3. ADX/CCI (Trend & Momentum) - ä½¿ç”¨ ADX ä½œç‚ºè¶¨å‹¢å¼·åº¦
        df['ADX_9'] = ta.trend.adx(df['High'], df['Low'], df['Close'], window=9, fillna=True)
        
        # 4. CMF (Chaikin Money Flow) - è³‡é‡‘æµå‘
        df['CMF'] = ta.volume.chaikin_money_flow(df['High'], df['Low'], df['Close'], df['Volume'], window=20, fillna=True)

        # 5. Stochastic Oscillator (Stochastics)
        df['Stoch_%K'] = ta.momentum.stoch(df['High'], df['Low'], df['Close'], window=STOCH_K_PERIOD, fillna=True)
        df['Stoch_%D'] = ta.momentum.stoch_signal(df['High'], df['Low'], df['Close'], window=STOCH_K_PERIOD, smooth_window=STOCH_D_PERIOD, fillna=True)

        # åˆªé™¤æ‰€æœ‰ NaN å€¼ï¼Œç¢ºä¿è¨ˆç®—æº–ç¢º
        df = df.dropna()

        return df, "âœ… æ•¸æ“šåŒæ­¥æˆåŠŸã€‚"

    except Exception as e:
        return pd.DataFrame(), f"âŒ æ•¸æ“šç²å–ç•°å¸¸: {e}"

# ==============================================================================
# 3. ç­–ç•¥å¼•æ“èˆ‡åˆ†æå‡½æ•¸
# ==============================================================================

def analyze_strategy(df):
    """
    å°ˆå®¶AIï¼šå¤šé€±æœŸè¶¨å‹¢ç¢ºèªç­–ç•¥ (Multitimeframe Trend Confirmation)
    """
    if df.empty:
        return None

    # å–æœ€å¾Œä¸€ç­†æ•¸æ“š
    last = df.iloc[-1]
    
    # åˆå§‹åŒ–åˆ†æ•¸ (Buy: 1, Sell: -1, Neutral: 0)
    score = 0
    reasons = []

    # --- 1. MACD è¶¨å‹¢åˆ¤æ–· ---
    if last['MACD_Hist'] > 0 and last['MACD'] > last['MACD_Signal']:
        score += 1
        reasons.append("MACD: å¤šé ­è¨Šè™Ÿ (æŸ±ç‹€åœ–ç¿»ç´…ï¼ŒMACD ç·šä¸Šç©¿ Signal ç·š)ã€‚")
    elif last['MACD_Hist'] < 0 and last['MACD'] < last['MACD_Signal']:
        score -= 1
        reasons.append("MACD: ç©ºé ­è¨Šè™Ÿ (æŸ±ç‹€åœ–ç¿»ç¶ ï¼ŒMACD ç·šä¸‹ç©¿ Signal ç·š)ã€‚")
    else:
        reasons.append("MACD: ç›¤æ•´æˆ–ä¸æ˜ç¢ºã€‚")

    # --- 2. RSI å‹•é‡åˆ¤æ–· ---
    if last['RSI'] <= RSI_OVERSOLD:
        score += 1
        reasons.append(f"RSI: è¶…è³£å€é–“ ({RSI_OVERSOLD} ä»¥ä¸‹)ï¼Œå­˜åœ¨åå½ˆæ½›åŠ›ã€‚")
    elif last['RSI'] >= RSI_OVERBOUGHT:
        score -= 1
        reasons.append(f"RSI: è¶…è²·å€é–“ ({RSI_OVERBOUGHT} ä»¥ä¸Š)ï¼Œå­˜åœ¨å›èª¿é¢¨éšªã€‚")
    else:
        reasons.append(f"RSI: è™•æ–¼ä¸­æ€§å€é–“ ({RSI_OVERSOLD}-{RSI_OVERBOUGHT})ã€‚")
        
    # --- 3. ADX è¶¨å‹¢å¼·åº¦åˆ¤æ–· ---
    if last['ADX_9'] > 25:
        reasons.append("ADX: è¶¨å‹¢å¼·å‹ï¼Œç•¶å‰è¶¨å‹¢å¯é åº¦é«˜ã€‚")
    else:
        reasons.append("ADX: è¶¨å‹¢å¾®å¼±ï¼Œåƒ¹æ ¼å¯èƒ½è™•æ–¼ç›¤æ•´ã€‚")

    # --- 4. CMF è³‡é‡‘æµå‘åˆ¤æ–· ---
    if last['CMF'] > 0:
        score += 0.5  # è³‡é‡‘æµå…¥è¦–ç‚ºå¼±å¤šé ­
        reasons.append("CMF: è³‡é‡‘æŒçºŒæµå…¥ (æ•¸å€¼ > 0)ã€‚")
    elif last['CMF'] < 0:
        score -= 0.5  # è³‡é‡‘æµå‡ºè¦–ç‚ºå¼±ç©ºé ­
        reasons.append("CMF: è³‡é‡‘æŒçºŒæµå‡º (æ•¸å€¼ < 0)ã€‚")
    else:
        reasons.append("CMF: è³‡é‡‘æµå‘ä¸æ˜é¡¯ã€‚")
        
    # --- 5. Stochastic K/D åˆ¤æ–· ---
    if last['Stoch_%K'] < STOCH_OVERSOLD and last['Stoch_%K'] > last['Stoch_%D']:
        score += 1
        reasons.append(f"Stoch: æ¥è¿‘è¶…è³£å€ä¸¦å½¢æˆé‡‘å‰ï¼Œå¤šé ­å‹•èƒ½å•Ÿå‹•ã€‚")
    elif last['Stoch_%K'] > STOCH_OVERBOUGHT and last['Stoch_%K'] < last['Stoch_%D']:
        score -= 1
        reasons.append(f"Stoch: æ¥è¿‘è¶…è²·å€ä¸¦å½¢æˆæ­»å‰ï¼Œç©ºé ­å‹•èƒ½å•Ÿå‹•ã€‚")
    else:
        reasons.append("Stoch: ä¸­æ€§æˆ–ç›¤æ•´ä¿¡è™Ÿã€‚")
        
    # --- æœ€çµ‚è¡Œå‹•å»ºè­° ---
    if score >= 2:
        action = "è²·å…¥ (Buy)"
        color = "#28a745" # ç¶ è‰²
    elif score <= -2:
        action = "è³£å‡º (Sell)"
        color = "#dc3545" # ç´…è‰²
    else:
        action = "è§€æœ› (Wait)"
        color = "#ffc107" # é»ƒè‰²

    # --- è¶¨å‹¢å¼·åº¦ (ç·šæ€§å›æ­¸æ–œç‡) ---
    try:
        # ä½¿ç”¨æœ€è¿‘ 10 æ ¹ K ç·šçš„æ”¶ç›¤åƒ¹
        recent_closes = df['Close'].iloc[-10:]
        x = np.arange(len(recent_closes))
        slope, intercept, r_value, p_value, std_err = linregress(x, recent_closes)
        
        if slope > 0.05: # è¨­å®šä¸€å€‹é–¾å€¼ä¾†å®šç¾©å¼·å‹ä¸Šæ¼²
            trend_strength = "å¼·å‹ä¸Šæ¼²"
        elif slope < -0.05: # è¨­å®šä¸€å€‹é–¾å€¼ä¾†å®šç¾©å¼·å‹ä¸‹è·Œ
            trend_strength = "å¼·å‹ä¸‹è·Œ"
        else:
            trend_strength = "å€é–“éœ‡ç›ª"
    except Exception:
        trend_strength = "ç„¡æ³•è¨ˆç®—"
        
    # --- ç­–ç•¥ç¸½çµ ---
    summary = {
        "Strategy_Summary": action,
        "Strategy_Color": color,
        "Score": score,
        "Reasons": reasons,
        "Trend_Strength": trend_strength,
        "Current_Price": last['Close'],
        "Price_Change": (last['Close'] - df.iloc[-2]['Close']) / df.iloc[-2]['Close'] * 100 if len(df) >= 2 else 0,
        "Volume": last['Volume']
    }

    return summary

def calculate_fibonacci_levels(df, is_uptrend):
    """
    æ–æ³¢é‚£å¥‘å›æ¸¬åˆ†æï¼šå‹•æ…‹è¨ˆç®—æ­¢ç›ˆ/æ­¢ææ°´å¹³ã€‚
    """
    if df.empty:
        return {}

    # æ‰¾å‡ºæœ€è¿‘çš„é«˜é»å’Œä½é» (ä½¿ç”¨æœ€è¿‘ 60 æ ¹ K ç·š)
    recent_df = df.iloc[-60:]
    high = recent_df['High'].max()
    low = recent_df['Low'].min()
    diff = high - low
    
    # æ–æ³¢é‚£å¥‘å›æ’¤æ°´å¹³ (å¾é«˜é»/ä½é»è¨ˆç®—)
    fib_levels = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0]
    
    levels = {}
    
    if is_uptrend:
        # ä¸Šæ¼²è¶¨å‹¢ï¼šå¾ä½é»åˆ°é«˜é»ç•«ç·šï¼Œè¨ˆç®—å›èª¿æ”¯æ’ä½ (æ­¢æåƒè€ƒ)
        for level in fib_levels:
            price = high - (diff * level)
            levels[f"Fib_{level*100:.1f}_Support"] = price
        # å– 0.618 ä½œç‚ºé—œéµæ­¢æåƒè€ƒ
        stop_loss_level = levels.get("Fib_61.8_Support", low)
        
    else:
        # ä¸‹è·Œè¶¨å‹¢ï¼šå¾é«˜é»åˆ°ä½é»ç•«ç·šï¼Œè¨ˆç®—åå½ˆå£“åŠ›ä½ (æ­¢ç›ˆåƒè€ƒ)
        for level in fib_levels:
            price = low + (diff * level)
            levels[f"Fib_{level*100:.1f}_Resistance"] = price
        # å– 0.618 ä½œç‚ºé—œéµæ­¢ç›ˆåƒè€ƒ
        stop_loss_level = levels.get("Fib_61.8_Resistance", high)

    # æ ¹æ“šç•¶å‰åƒ¹æ ¼å’Œè¶¨å‹¢ï¼Œç¢ºå®šæœ€æ¥è¿‘çš„ç­–ç•¥ä½
    current_price = df.iloc[-1]['Close']
    
    if is_uptrend:
        # åœ¨ä¸Šæ¼²è¶¨å‹¢ä¸­ï¼Œå°‹æ‰¾ä½æ–¼ç•¶å‰åƒ¹æ ¼çš„æœ€è¿‘æ”¯æ’
        support_levels = [v for k, v in levels.items() if "Support" in k and v < current_price]
        if support_levels:
            # æœ€æ¥è¿‘ç•¶å‰åƒ¹æ ¼çš„æ”¯æ’ä½ (æœ€é«˜æ”¯æ’ä½)
            key_strategy_level = max(support_levels) 
        else:
            key_strategy_level = low
        
        strategy_info = {
            "Level": key_strategy_level,
            "Type": "é—œéµæ”¯æ’ (æ­¢æåƒè€ƒ)",
            "High": high,
            "Low": low,
        }
    else:
        # åœ¨ä¸‹è·Œè¶¨å‹¢ä¸­ï¼Œå°‹æ‰¾é«˜æ–¼ç•¶å‰åƒ¹æ ¼çš„æœ€è¿‘å£“åŠ›
        resistance_levels = [v for k, v in levels.items() if "Resistance" in k and v > current_price]
        if resistance_levels:
            # æœ€æ¥è¿‘ç•¶å‰åƒ¹æ ¼çš„å£“åŠ›ä½ (æœ€ä½å£“åŠ›ä½)
            key_strategy_level = min(resistance_levels) 
        else:
            key_strategy_level = high
            
        strategy_info = {
            "Level": key_strategy_level,
            "Type": "é—œéµå£“åŠ› (æ­¢ç›ˆåƒè€ƒ)",
            "High": high,
            "Low": low,
        }

    return strategy_info

# ==============================================================================
# 4. å„€è¡¨æ¿æ¸²æŸ“å‡½æ•¸
# ==============================================================================

def create_card_html(label, value, unit="", style_class='sub-card-tile', value_class='value-text-regular'):
    """çµ±ä¸€ç”Ÿæˆå¡ç‰‡ HTML çµæ§‹çš„è¼”åŠ©å‡½æ•¸ï¼Œä½¿ç”¨æ–°çš„æ¨£å¼ã€‚"""
    if unit:
        # å°‡å–®ä½æ”¾åœ¨å€¼ä¹‹å¾Œ
        display_value = f"{value} {unit}"
    else:
        display_value = value

    return f"""
    <div class='{style_class}'>
        <div class='label-text'>{label}</div>
        <div class='{value_class}'>{display_value}</div>
    </div>
    """

def render_strategy_summary_panel(metrics):
    """æ¸²æŸ“é ‚éƒ¨æ ¸å¿ƒæˆ°æƒ…ç¸½è¦½å¡ç‰‡"""
    
    # --- æ ¸å¿ƒæˆ°æƒ…ç¸½è¦½æ¨™é¡Œ (ä½¿ç”¨æ–°çš„ Header æ¨£å¼) ---
    st.markdown("<div class='card-section-header'>æ ¸å¿ƒæˆ°æƒ…ç¸½è¦½</div>", unsafe_allow_html=True)

    # é ‚éƒ¨å››å€‹æŒ‡æ¨™ (Price, Change, Volume, Strategy Summary)
    cols_metrics = st.columns([1.5, 1.5, 1.5, 2.5]) # ç‚ºç­–ç•¥ç¸½çµç•™å‡ºæ›´å¤šç©ºé–“
    
    current_price = metrics['Current_Price']
    price_change = metrics['Price_Change']
    volume = metrics['Volume']
    
    # åƒ¹æ ¼è®Šå‹•é¡è‰² (ç¶ æ¼²ç´…è·Œ)
    change_color = "#28a745" if price_change >= 0 else "#dc3545"

    # 1. ç•¶å‰å¸‚å ´åƒ¹æ ¼
    with cols_metrics[0]:
        st.markdown(create_card_html(
            "ğŸ’° ç•¶å‰å¸‚å ´åƒ¹æ ¼", f"TWD {current_price:,.2f}",
        ), unsafe_allow_html=True)

    # 2. åƒ¹æ ¼è®Šå‹•ç™¾åˆ†æ¯”
    with cols_metrics[1]:
        st.markdown(create_card_html(
            "ğŸš€ 24h è®Šå‹•", 
            f"{price_change:+.2f}%", 
            style_class='sub-card-tile', 
            value_class='value-text-regular',
        ).replace('value-text-regular', f'value-text-regular' if price_change == 0 else f'value-text-regular' ),
        unsafe_allow_html=True) # ç”±æ–¼ Streamlit é™åˆ¶ï¼Œç›´æ¥æ›¿æ›é¡è‰²æ¨™è¨˜

    # 3. äº¤æ˜“é‡
    with cols_metrics[2]:
        st.markdown(create_card_html(
            "â›½ï¸ ç‡ƒæ–™äº¤æ˜“é‡", f"{volume:,.0f}", unit="å–®ä½"
        ), unsafe_allow_html=True)

    # 4. AI å°ˆå®¶è¡Œå‹•å»ºè­° (ä½¿ç”¨ Highlight Tile ä¸¦ä¾æ“šå»ºè­°çµ¦äºˆé¡è‰²)
    with cols_metrics[3]:
        strategy_text = metrics['Strategy_Summary']
        strategy_color = {
            "è²·å…¥ (Buy)": "#28a745", # ç¶ è‰²
            "è³£å‡º (Sell)": "#dc3545", # ç´…è‰²
            "è§€æœ› (Wait)": "#ffc107" # é»ƒè‰²
        }.get(strategy_text, ACCENT_COLOR) # é»˜èªä½¿ç”¨è¼”è‰²

        # Custom Highlight Tile for Strategy
        st.markdown(f"""
        <div class='highlight-tile' style='border-color: {strategy_color}; box-shadow: 0 0 15px {strategy_color}77; background: linear-gradient(145deg, #1e2126, #24282c);'>
            <div class='label-text'>ğŸ›°ï¸ å°ˆå®¶è¡Œå‹•å»ºè­°</div>
            <div class='value-text-highlight' style='color: {strategy_color}; font-size: 2.1em; line-height: 1.1;'>{strategy_text}</div>
        </div>
        """, unsafe_allow_html=True)

    
    # --- æˆ°è¡“è§£æ (è¶¨å‹¢ & ç†ç”±) ---
    st.markdown("---")
    st.markdown("##### ğŸ” æˆ°è¡“è§£æèˆ‡è¶¨å‹¢å¼·åº¦")
    
    # è¶¨å‹¢å¼·åº¦
    st.markdown(f"**è¶¨å‹¢å¼·åº¦**ï¼š<span style='color: {ACCENT_COLOR}; font-weight: bold;'>{metrics['Trend_Strength']}</span>", unsafe_allow_html=True)
    
    # ç†ç”±åˆ—è¡¨
    st.markdown("##### ğŸ“œ æŒ‡æ¨™ç¢ºèªæ¸…å–® (Score: {:.1f})".format(metrics['Score']))
    for reason in metrics['Reasons']:
        prefix = "ğŸŸ¢" if "å¤šé ­" in reason or "è²·å…¥" in reason or "æ½›åŠ›" in reason else \
                 "ğŸ”´" if "ç©ºé ­" in reason or "è³£å‡º" in reason or "é¢¨éšª" in reason else "ğŸŸ¡"
        st.markdown(f"- {prefix} {reason}")


def render_technical_analysis_panel(df):
    """æ¸²æŸ“æŒ‡æ¨™æ•¸æ“šè¡¨"""
    
    # --- æŠ€è¡“æŒ‡æ¨™ç¸½è¦½æ¨™é¡Œ (ä½¿ç”¨æ–°çš„ Header æ¨£å¼) ---
    st.markdown("<div class='card-section-header'>âš”ï¸ å¤šé€±æœŸè¶¨å‹¢ç¢ºèª</div>", unsafe_allow_html=True)
    
    # åƒ…é¡¯ç¤ºæœ€è¿‘ 10 ç­†æ•¸æ“š
    display_df = df.tail(10).copy()
    
    # æ ¼å¼åŒ–é¡¯ç¤º (ä½¿ç”¨ä¸­æ–‡æ™‚é–“æ ¼å¼)
    display_df.index = display_df.index.strftime('%m-%d %H:%M') 
    display_df.index.name = "æ™‚é–“é»"
    
    # é¸å–ä¸¦é‡æ–°å‘½åæ¬„ä½ä»¥ä¾¿ä¸­æ–‡é¡¯ç¤º
    display_df = display_df[[
        'Close', 'MACD', 'MACD_Signal', 'MACD_Hist', 'RSI', 'ADX_9', 'CMF', 'Stoch_%K', 'Stoch_%D'
    ]]
    
    display_df.columns = [
        'æ”¶ç›¤åƒ¹', 'MACD', 'Signal', 'MACD_æŸ±', 'RSI', 'ADX(9)', 'CMF(20)', 'Stoch_%K', 'Stoch_%D'
    ]
    
    # æ‡‰ç”¨é¡è‰²æ˜ å°„è¦å‰‡ (å°ˆæ¥­ç‰ˆåœ–è¡¨åŠŸèƒ½)
    def color_macd(val):
        if val > 0:
            return 'background-color: #0c331a; color: #4CAF50'
        elif val < 0:
            return 'background-color: #380d12; color: #F44336'
        return ''
    
    def color_rsi_stoch(val):
        if val >= RSI_OVERBOUGHT:
            return 'background-color: #380d12; color: #F44336; font-weight: bold;'
        elif val <= RSI_OVERSOLD:
            return 'background-color: #0c331a; color: #4CAF50; font-weight: bold;'
        return ''
    
    def color_adx(val):
        if val > 25:
            return 'background-color: #1e2126; color: #e9967a; font-weight: bold;' # ä½¿ç”¨è¼”è‰²å¼·èª¿è¶¨å‹¢å¼·å‹
        return ''

    styled_df = display_df.style.applymap(color_macd, subset=['MACD_æŸ±']) \
                                .applymap(color_rsi_stoch, subset=['RSI', 'Stoch_%K', 'Stoch_%D']) \
                                .applymap(color_adx, subset=['ADX(9)']) \
                                .format({
                                    'æ”¶ç›¤åƒ¹': "{:.2f}", 
                                    'MACD': "{:.3f}", 
                                    'Signal': "{:.3f}", 
                                    'MACD_æŸ±': "{:.4f}",
                                    'RSI': "{:.2f}",
                                    'ADX(9)': "{:.2f}",
                                    'CMF(20)': "{:.3f}",
                                    'Stoch_%K': "{:.2f}",
                                    'Stoch_%D': "{:.2f}",
                                })

    st.dataframe(styled_df, use_container_width=True, height=450)


def render_expert_chart_pro(df, symbol):
    """æ¸²æŸ“ K ç·šèˆ‡æŠ€è¡“æŒ‡æ¨™çš„å°ˆå®¶ç´šåœ–è¡¨"""
    
    # --- å°ˆå®¶åœ–è¡¨ Pro æ¨™é¡Œ (ä½¿ç”¨æ–°çš„ Header æ¨£å¼) ---
    st.markdown("<div class='card-section-header'>ğŸ“Š å°ˆå®¶åœ–è¡¨ PRO - Kç·šèˆ‡æˆ°è¡“ä¿¡è™Ÿ</div>", unsafe_allow_html=True)

    # å»ºç«‹å››å€‹å­åœ–è¡¨ï¼šåƒ¹æ ¼, MACD, è¶¨å‹¢(ADX/CMF), å‹•é‡(Stochastics)
    fig = make_subplots(
        rows=4, cols=1, 
        shared_xaxes=True, 
        vertical_spacing=0.05,
        row_heights=[0.5, 0.15, 0.15, 0.2] # èª¿æ•´é«˜åº¦æ¯”ä¾‹
    )

    # --- 1. K ç·šåœ–èˆ‡ RSI ---
    fig.add_trace(go.Candlestick(x=df.index,
                                 open=df['Open'],
                                 high=df['High'],
                                 low=df['Low'],
                                 close=df['Close'],
                                 name='åƒ¹æ ¼/Price'), row=1, col=1)
    
    # RSI æ›²ç·šåœ– (ç–ŠåŠ åœ¨åƒ¹æ ¼åœ–ä¸Šï¼Œä½†ä½¿ç”¨ä¸åŒ Y è»¸)
    fig.add_trace(go.Scatter(x=df.index, y=df['RSI'], name='RSI', 
                             line=dict(color='yellow', width=1.5), 
                             yaxis='y2'), row=1, col=1)
    
    # RSI è¶…è²·/è¶…è³£æ°´å¹³ç·š
    fig.add_hrect(y0=RSI_OVERBOUGHT, y1=100, line_width=0, fillcolor="red", opacity=0.1, row=1, col=1, yaxis='y2')
    fig.add_hrect(y0=0, y1=RSI_OVERSOLD, line_width=0, fillcolor="green", opacity=0.1, row=1, col=1, yaxis='y2')
    fig.add_hline(y=RSI_OVERBOUGHT, line_width=1, line_dash="dash", line_color="#dc3545", row=1, col=1, yaxis='y2')
    fig.add_hline(y=RSI_OVERSOLD, line_width=1, line_dash="dash", line_color="#28a745", row=1, col=1, yaxis='y2')
    
    # --- 2. MACD åœ– ---
    fig.add_trace(go.Bar(x=df.index, y=df['MACD_Hist'], name='MACD æŸ±', 
                         marker_color=np.where(df['MACD_Hist'] > 0, '#28a745', '#dc3545')), row=2, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['MACD'], name='MACD', line=dict(color='blue')), row=2, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['MACD_Signal'], name='Signal', line=dict(color='red', dash='dot')), row=2, col=1)
    fig.add_hline(y=0, line_width=1, line_dash="dash", line_color="grey", row=2, col=1)
    
    # --- 3. è¶¨å‹¢èˆ‡è³‡é‡‘æµå‘ (ADX & CMF) ---
    fig.add_trace(go.Scatter(x=df.index, y=df['ADX_9'], name='ADX', line=dict(color='brown')), row=3, col=1)
    fig.add_hline(y=25, line_width=1, line_dash="dash", line_color="grey", row=3, col=1)
    fig.add_trace(go.Bar(x=df.index, y=df['CMF'], name='CMF', 
                         marker_color=np.where(df['CMF'] > 0, '#28a745', '#dc3545')), row=3, col=1)
    fig.add_hline(y=0, line_width=1, line_dash="dash", line_color="grey", row=3, col=1)
    
    # --- 4. Stochastic K/D ---
    fig.add_trace(go.Scatter(x=df.index, y=df['Stoch_%K'], name='Stoch %K', line=dict(color='cyan')), row=4, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['Stoch_%D'], name='Stoch %D', line=dict(color='magenta', dash='dot')), row=4, col=1)
    fig.add_hrect(y0=STOCH_OVERBOUGHT, y1=100, line_width=0, fillcolor="red", opacity=0.2, row=4, col=1); 
    fig.add_hrect(y0=0, y1=STOCH_OVERSOLD, line_width=0, fillcolor="green", opacity=0.2, row=4, col=1)
    fig.add_hline(y=STOCH_OVERBOUGHT, line_width=1, line_dash="dash", line_color="#dc3545", row=4, col=1)
    fig.add_hline(y=STOCH_OVERSOLD, line_width=1, line_dash="dash", line_color="#28a745", row=4, col=1)

    # --- çµ±ä¸€åœ–è¡¨é…ç½® ---
    fig.update_layout(
        title=f"{symbol} Kç·šèˆ‡æŠ€è¡“æŒ‡æ¨™ç¸½è¦½",
        xaxis_rangeslider_visible=False,
        height=900, 
        template="plotly_dark",
        margin=dict(l=20, r=20, t=40, b=20),
        hovermode="x unified",
    )
    
    # è¨­ç½® RSI çš„ç¨ç«‹ Y è»¸ (y2)
    fig.update_layout(
        yaxis2=dict(
            title="RSI",
            overlaying='y',
            side='right',
            range=[0, 100],
            showgrid=False
        )
    )

    # æ›´æ–°è»¸æ¨™ç±¤
    fig.update_yaxes(title_text="åƒ¹æ ¼", row=1, col=1)
    fig.update_yaxes(title_text="MACD", row=2, col=1)
    fig.update_yaxes(title_text="ADX/CMF", row=3, col=1)
    fig.update_yaxes(title_text="Stoch", row=4, col=1)

    st.plotly_chart(fig, use_container_width=True)

def render_fib_risk_panel(fib_info, summary):
    """æ¸²æŸ“æ–æ³¢é‚£å¥‘å›æ¸¬èˆ‡é¢¨éšªç®¡ç†é¢æ¿"""
    
    # --- é¢¨éšªç®¡ç†æ¨™é¡Œ (ä½¿ç”¨æ–°çš„ Header æ¨£å¼) ---
    st.markdown("<div class='card-section-header'>ğŸ›¡ï¸ æ–æ³¢é‚£å¥‘å›æ¸¬èˆ‡é¢¨éšªè©•ä¼°</div>", unsafe_allow_html=True)
    
    if not fib_info:
        st.warning("âš ï¸ æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•é€²è¡Œæ–æ³¢é‚£å¥‘å›æ¸¬åˆ†æã€‚")
        return

    cols_fib = st.columns(3)
    
    strategy_level = fib_info['Level']
    level_type = fib_info['Type']
    high = fib_info['High']
    low = fib_info['Low']
    
    # é¢¨éšªè©•ä¼°ï¼šå¦‚æœç•¶å‰åƒ¹æ ¼éå¸¸æ¥è¿‘é—œéµç­–ç•¥ä½ (Â±1%)ï¼Œå‰‡ç™¼å‡ºè­¦å ±
    current_price = summary['Current_Price']
    is_critical = abs(current_price - strategy_level) / current_price < 0.01

    # 1. æ–æ³¢é‚£å¥‘é—œéµç­–ç•¥ä½
    with cols_fib[0]:
        card_class = 'highlight-tile' if is_critical else 'sub-card-tile'
        value_class = 'value-text-highlight' if is_critical else 'value-text-regular'
        st.markdown(create_card_html(
            f"ğŸ¯ {level_type} (61.8%)", 
            f"TWD {strategy_level:,.2f}", 
            style_class=card_class, 
            value_class=value_class
        ), unsafe_allow_html=True)

    # 2. è¶¨å‹¢é«˜é»
    with cols_fib[1]:
        st.markdown(create_card_html(
            "â¬†ï¸ è¿‘æœŸé«˜é»", 
            f"TWD {high:,.2f}"
        ), unsafe_allow_html=True)
        
    # 3. è¶¨å‹¢ä½é»
    with cols_fib[2]:
        st.markdown(create_card_html(
            "â¬‡ï¸ è¿‘æœŸä½é»", 
            f"TWD {low:,.2f}"
        ), unsafe_allow_html=True)
        
    # --- é¢¨éšªè­¦ç¤ºèˆ‡å»ºè­° ---
    st.markdown("---")
    
    if is_critical:
        st.error(f"ğŸš¨ **ç´…è‰²è­¦å ±**ï¼šç•¶å‰åƒ¹æ ¼ ({current_price:.2f}) æ¥µæ¥è¿‘ **{level_type}** ({strategy_level:.2f})ï¼è«‹æº–å‚™å•Ÿå‹•ç·Šæ€¥æˆ°è¡“éƒ¨ç½²ã€‚")
    else:
        st.info(f"âœ… **æˆ°è¡“å®‰å…¨**ï¼šç•¶å‰åƒ¹æ ¼èˆ‡ {level_type} å°šæœ‰å®‰å…¨è·é›¢ã€‚")

# ==============================================================================
# 5. ä¸»æ‡‰ç”¨ç¨‹å¼é‚è¼¯
# ==============================================================================

# æ‡‰ç”¨æ¨™é¡Œ
st.title("ğŸ›°ï¸ è»Œé“å¸ä»¤éƒ¨ï¼šæˆ°è¡“æƒæ (O.C.T.S.) - V4.3")

# --- å´é‚Šæ¬„è¼¸å…¥ (Sidebar) ---
st.sidebar.header("âš™ï¸ æˆ°è¡“åƒæ•¸é…ç½®")

# 1. è³‡ç”¢é¡åˆ¥é¸æ“‡ (ä¸è®Š)
asset_class = st.sidebar.radio(
    "è³‡ç”¢é¡åˆ¥",
    ["å°è‚¡", "ç¾è‚¡", "åŠ å¯†è²¨å¹£"],
    index=0
)

# 2. æ¨™çš„ä»£è™Ÿè¼¸å…¥ (ä¸è®Š)
search_options = {}
if asset_class == "å°è‚¡":
    search_options = {k: v['name'] for k, v in FULL_SYMBOLS_MAP.items() if ".TW" in k and "-" not in k}
    default_symbol = "2330.TW"
elif asset_class == "ç¾è‚¡":
    search_options = {k: v['name'] for k, v in FULL_SYMBOLS_MAP.items() if ".TW" not in k and "-" not in k}
    default_symbol = "NVDA"
elif asset_class == "åŠ å¯†è²¨å¹£":
    search_options = {k: v['name'] for k, v in FULL_SYMBOLS_MAP.items() if "-" in k}
    default_symbol = "BTC-USD"

# ä¸‹æ‹‰é¸å–®èˆ‡è‡ªå®šç¾©è¼¸å…¥
search_key_map = {v: k for k, v in search_options.items()}
selected_name = st.sidebar.selectbox("å¿«é€Ÿé¸æ“‡æ¨™çš„", list(search_options.values()), index=list(search_options.values()).index(search_options.get(default_symbol, list(search_options.values())[0])) if default_symbol in search_options else 0)
selected_symbol = search_key_map.get(selected_name, default_symbol)

st.sidebar.markdown("---")

# è‡ªå®šç¾©ä»£è™Ÿè¼¸å…¥ (å„ªå…ˆç´šæ›´é«˜)
custom_symbol_input = st.sidebar.text_input(
    "æˆ–æ‰‹å‹•è¼¸å…¥æ¨™çš„ä»£è™Ÿ (e.g., 2330.TW)",
    value=selected_symbol,
    key='sidebar_search_input'
)
final_symbol = custom_symbol_input if custom_symbol_input else selected_symbol


# 3. é€±æœŸé¸æ“‡ (ä¸è®Š)
selected_timeframe = st.sidebar.radio(
    "åˆ†æé€±æœŸ",
    list(PERIOD_MAP.keys()),
    index=2 # é è¨­ç‚º 1 æ—¥
)

# 4. åŸ·è¡ŒæŒ‰éˆ• (ä¸è®Š)
if st.sidebar.button("ğŸ“Š åŸ·è¡ŒAIæˆ°è¡“æƒæ", use_container_width=True):
    st.session_state['data_ready'] = False
    st.session_state['last_search_symbol'] = final_symbol

# --- æ‡‰ç”¨ç¨‹å¼ä¸»é«” ---
if 'last_search_symbol' not in st.session_state:
    st.session_state['last_search_symbol'] = final_symbol
if 'data_ready' not in st.session_state:
    st.session_state['data_ready'] = False

if st.session_state['last_search_symbol']:
    
    period, interval = PERIOD_MAP[selected_timeframe]
    
    with st.spinner(f"ğŸš€ æ­£åœ¨ç‚º {st.session_state['last_search_symbol']} ({selected_timeframe}) ç²å–æ•¸æ“šä¸¦é€²è¡Œ AI æˆ°è¡“åˆ†æ..."):
        # æ•¸æ“šç²å–
        df, status_message = fetch_data(st.session_state['last_search_symbol'], period, interval)
        
        if status_message.startswith("âœ…"):
            st.session_state['data_ready'] = True
            st.session_state['analysis_df'] = df
            
            # ç­–ç•¥åˆ†æ
            st.session_state['strategy_summary'] = analyze_strategy(df)
            
            # æ–æ³¢é‚£å¥‘åˆ†æ
            is_uptrend = st.session_state['strategy_summary']['Trend_Strength'] in ["å¼·å‹ä¸Šæ¼²", "å€é–“éœ‡ç›ª"]
            st.session_state['fib_info'] = calculate_fibonacci_levels(df, is_uptrend)

        st.info(status_message)


if st.session_state.get('data_ready', False) and not st.session_state['analysis_df'].empty:
    
    df = st.session_state['analysis_df']
    summary = st.session_state['strategy_summary']
    fib_info = st.session_state['fib_info']

    # 1. é ‚éƒ¨æ ¸å¿ƒæˆ°æƒ…ç¸½è¦½èˆ‡è¡Œå‹•å»ºè­°
    if summary:
        render_strategy_summary_panel(summary)
        
    st.markdown("---")

    # 2. æ–æ³¢é‚£å¥‘å›æ¸¬èˆ‡é¢¨éšªè©•ä¼° (åœ¨åœ–è¡¨å‰é¡¯ç¤ºï¼Œä½œç‚ºå…ˆè¡ŒæŒ‡æ¨™)
    render_fib_risk_panel(fib_info, summary)
    
    st.markdown("---")
    
    # 3. Kç·šèˆ‡æŠ€è¡“æŒ‡æ¨™åœ–è¡¨
    render_expert_chart_pro(df, st.session_state['last_search_symbol'])
    
    st.markdown("---")
    
    # 4. å¤šé€±æœŸè¶¨å‹¢ç¢ºèªæ•¸æ“šè¡¨
    render_technical_analysis_panel(df)
    
else:
    # æ­¡è¿è¨Šæ¯å€å¡Š (åœ¨æœªåŸ·è¡Œåˆ†ææ™‚é¡¯ç¤º)
    st.markdown("<div class='card-section-header'>æ­¡è¿ç™»å…¥ è»Œé“å¸ä»¤éƒ¨ (O.C.T.S.) çµ‚ç«¯</div>", unsafe_allow_html=True)
    
    st.markdown("""
    <div class='sub-card-tile' style='padding: 2rem;'>
        <p style='font-size: 1.2em; color: #e9967a;'>
        **æŒ‡æ®å®˜ï¼Œè«‹åœ¨å·¦å´æˆ°è¡“åƒæ•¸é…ç½®æ¬„ä½**ï¼š
        </p>
        <ol style='line-height: 1.8; margin-top: 1rem;'>
            <li>**é¸æ“‡è³‡ç”¢é¡åˆ¥**ï¼šé¸æ“‡æ‚¨çš„ç›®æ¨™æ˜Ÿå€ï¼ˆå°è‚¡ã€ç¾è‚¡æˆ–åŠ å¯†è²¨å¹£ï¼‰ã€‚</li>
            <li>**é–å®šæ¨™çš„**ï¼šè¼¸å…¥æˆ–é¸æ“‡ç›®æ¨™ä»£è™Ÿã€‚</li>
            <li>**è¨­å®šåˆ†æé€±æœŸ**ï¼šé¸æ“‡æ‚¨å¸Œæœ›çš„æƒææ·±åº¦ï¼ˆ30 åˆ†é˜åˆ° 1 é€±ï¼‰ã€‚</li>
            <li>**å•Ÿå‹•æˆ°è¡“æƒæ**ï¼šé»æ“Š <span style='color: #FA8072; font-weight: bold;'>ã€ğŸ“Š åŸ·è¡ŒAIæˆ°è¡“æƒæã€</span> æŒ‰éˆ•é–‹å§‹ï¼ŒAI å°‡èåˆå¤šé …é ‚ç´šæŠ€è¡“æŒ‡æ¨™ç‚ºæ‚¨æä¾›æ±ºç­–å»ºè­°ã€‚</li>
        </ol>
        <p style='margin-top: 1.5rem; color: #b0b0b0;'>
        ç‰ˆæœ¬ V4.3 - æ ¸å¿ƒå¼•æ“å·²æ›´æ–°è‡³ã€Œå¤šé€±æœŸè¶¨å‹¢ç¢ºèªã€èˆ‡ã€Œæ–æ³¢é‚£å¥‘å›æ¸¬ã€ç­–ç•¥ã€‚
        </p>
    </div>
    """, unsafe_allow_html=True)


# ç¢ºä¿ session state åˆå§‹åŒ–
if 'last_search_symbol' not in st.session_state:
    st.session_state['last_search_symbol'] = "2330.TW"
if 'data_ready' not in st.session_state:
    st.session_state['data_ready'] = False
if 'sidebar_search_input' not in st.session_state:
    st.session_state['sidebar_search_input'] = "2330.TW"
