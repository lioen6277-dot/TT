# -*- coding: utf-8 -*-
"""
AI è¶¨å‹¢åˆ†æ Streamlit æ‡‰ç”¨ç¨‹å¼
å°ˆå®¶å¢å¼·æœ€çµ‚ç‰ˆå¯¦ä½œ (V12.2.1 - Final Stable Version with Session State Fix)

æœ¬æ‡‰ç”¨ç¨‹å¼æ ¹æ“šä¸€ä»½è©³ç´°çš„é‡‘èåˆ†æå·¥å…·è¨­å®šæ–‡ä»¶é€²è¡Œé–‹ç™¼ï¼Œä¸¦èåˆäº†å°ˆæ¥­ç´šçš„
app2.0.py è¨­è¨ˆé‚è¼¯èˆ‡ä½¿ç”¨è€…æä¾›çš„ UI è¦–è¦ºè¨­è¨ˆç¨¿ï¼Œæ—¨åœ¨æä¾›ä¸€å€‹å¤–è§€ç²¾ç¾ã€
äº’å‹•å°ˆæ¥­çš„æ±ºç­–å„€è¡¨æ¿ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š
- [ç©©å®šæ€§ä¿®å¾©] ä¿®å¾© StreamlitAPIException (Session State Initialization) <--- FIX
- [ç©©å®šæ€§ä¿®å¾©] æ–°å¢ scipy ä¾è³´ï¼Œä¿®å¾© ModuleNotFoundError
- [ç©©å®šæ€§ä¿®å¾©] ä¿®å¾© UnboundLocalError ä¸¦æ¢å¾©æ‰€æœ‰å„€è¡¨æ¿å€å¡Š
- [é ‚ç´šç­–ç•¥] å¼•å…¥ã€Œå¤šé€±æœŸè¶¨å‹¢ç¢ºèªã€åˆ†æå¼•æ“
- [é ‚ç´šç­–ç•¥] æ•´åˆã€Œæ–æ³¢é‚£å¥‘å›æ¸¬ã€ä½œç‚ºå‹•æ…‹æ­¢ç›ˆæ­¢ææ¨¡å‹
- [ç­–ç•¥å‡ç´š] æ›´æ–° MACD æ ¸å¿ƒåƒæ•¸ç‚º (9, 16, 5)
- [UI å„ªåŒ–] ç‚º AI å°ˆå®¶ç¸½çµçš„è¡Œå‹•å»ºè­°æ·»åŠ é¡è‰²æ¨™è¨˜
- [ç­–ç•¥å‡ç´š] å°‡ RSI è¶…è²·/è¶…è³£é–¾å€¼çµ±ä¸€èª¿æ•´ç‚º 80/20
- [å°ˆå®¶åœ–è¡¨ Pro] ç‚ºæŒ‡æ¨™åœ–è¡¨åŠ å…¥é—œéµæ°´å¹³ç·šèˆ‡ AI è¨»è§£
- [ç©©å®šæ€§å¼·åŒ–] æé«˜æ•¸æ“šé©—è­‰é–€æª»
- [å°ˆå®¶å‡ç´š] å¼•å…¥å‹•æ…‹é©æ‡‰åŠŸèƒ½

é–‹ç™¼è€…ï¼šç¨‹å¼ç¢¼å°ˆå®¶ (Generated by Gemini)
ç‰ˆæœ¬ï¼š12.2.1 (Final Stable)
"""

# è¼‰å…¥æ ¸å¿ƒå¥—ä»¶
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import ta
import warnings
import time
import re 
import scipy.stats # ç¢ºä¿ scipy ä¾è³´å­˜åœ¨
from datetime import datetime, timedelta

warnings.filterwarnings('ignore')

# ==============================================================================
# 1. é é¢é…ç½®èˆ‡å…¨å±€è¨­å®š
# ==============================================================================

st.set_page_config(
    page_title="AIè¶¨å‹¢åˆ†æå„€è¡¨æ¿", 
    page_icon="ğŸ“ˆ", 
    layout="wide"
)

# é€±æœŸæ˜ å°„ï¼š(YFinance Period, YFinance Interval)
# ä¿®æ­£ 4 å°æ™‚ç‚º 90d, 4h (YF ä¸æ”¯æ´ 4hï¼Œæ”¹ç”¨ 60m è™•ç† 4å°æ™‚ Kç·šçš„æ•¸æ“šé•·åº¦)
PERIOD_MAP = { 
    "30 åˆ†": ("60d", "30m"), 
    "4 å°æ™‚": ("90d", "60m"), # ä½¿ç”¨ 60m æ­é… 90d æœŸé–“
    "1 æ—¥": ("5y", "1d"), 
    "1 é€±": ("max", "1wk")
}

# ğŸš€ æ‚¨çš„ã€æ‰€æœ‰è³‡ç”¢æ¸…å–®ã€‘ (ç°¡åŒ–ç‰ˆï¼Œä¿æŒèˆ‡ app2.0.py ä¸€è‡´)
FULL_SYMBOLS_MAP = {
    # A. ç¾è‚¡æ ¸å¿ƒ (US Stocks)
    "TSLA": {"name": "ç‰¹æ–¯æ‹‰", "keywords": ["ç‰¹æ–¯æ‹‰", "é›»å‹•è»Š", "TSLA", "Tesla"], "type": "ç¾è‚¡"},
    "NVDA": {"name": "è¼é”", "keywords": ["è¼é”", "è‹±å‰é”", "AI", "NVDA", "Nvidia"], "type": "ç¾è‚¡"},
    "AAPL": {"name": "è˜‹æœ", "keywords": ["è˜‹æœ", "æ‰‹æ©Ÿ", "AAPL"], "type": "ç¾è‚¡"},
    "GOOGL": {"name": "è°·æ­Œ", "keywords": ["è°·æ­Œ", "Google", "GOOGL"], "type": "ç¾è‚¡"},
    # B. å°è‚¡æ ¸å¿ƒ (Taiwan Stocks)
    "2330.TW": {"name": "å°ç©é›»", "keywords": ["å°ç©é›»", "åŠå°é«”", "2330"], "type": "å°è‚¡"},
    "2303.TW": {"name": "è¯é›»", "keywords": ["è¯é›»", "åŠå°é«”", "2303"], "type": "å°è‚¡"},
    # C. åŠ å¯†è²¨å¹£æ ¸å¿ƒ (Crypto)
    "BTC-USD": {"name": "æ¯”ç‰¹å¹£", "keywords": ["æ¯”ç‰¹å¹£", "BTC", "Crypto"], "type": "åŠ å¯†è²¨å¹£"},
    "ETH-USD": {"name": "ä»¥å¤ªåŠ", "keywords": ["ä»¥å¤ªåŠ", "ETH", "Crypto"], "type": "åŠ å¯†è²¨å¹£"},
}

# æ–æ³¢é‚£å¥‘å›æ¸¬å±¤ç´š (ç”¨æ–¼å‹•æ…‹æ­¢ææ­¢ç›ˆ)
FIB_LEVELS = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0]

# ==============================================================================
# 2. æ•¸æ“šç²å–èˆ‡æŒ‡æ¨™è¨ˆç®—
# ==============================================================================

@st.cache_data(ttl=3600)
def fetch_and_calculate_data(symbol, period, interval):
    """å¾ YFinance ç²å–æ•¸æ“šä¸¦è¨ˆç®—æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™"""
    try:
        data = yf.download(symbol, period=period, interval=interval, progress=False)
        if data.empty or len(data) < 50:
            return None
        
        # ç¢ºä¿åˆ—åè¦ç¯„åŒ–
        data.columns = [col.capitalize() for col in data.columns]
        
        # --- è¶¨å‹¢/å‹•é‡æŒ‡æ¨™ (MACD åƒæ•¸æ›´æ–°ç‚º 9, 16, 5) ---
        data['MACD'] = ta.trend.macd(data['Close'], window_fast=9, window_slow=16, window_sign=5, fillna=True)
        data['MACD_Signal'] = ta.trend.macd_signal(data['Close'], window_fast=9, window_slow=16, window_sign=5, fillna=True)
        data['MACD_Hist'] = ta.trend.macd_diff(data['Close'], window_fast=9, window_slow=16, window_sign=5, fillna=True)
        data['RSI'] = ta.momentum.rsi(data['Close'], window=14, fillna=True) # 14-period RSI
        data['ADX_9'] = ta.trend.adx(data['High'], data['Low'], data['Close'], window=9, fillna=True) # 9-period ADX

        # --- æ³¢å‹•æ€§/å‡ç·šæŒ‡æ¨™ ---
        data['SMA_20'] = ta.trend.sma_indicator(data['Close'], window=20, fillna=True)
        data['EMA_50'] = ta.trend.ema_indicator(data['Close'], window=50, fillna=True)
        data['BB_High'] = ta.volatility.bollinger_hband(data['Close'], window=20, window_dev=2, fillna=True)
        data['BB_Low'] = ta.volatility.bollinger_lband(data['Close'], window=20, window_dev=2, fillna=True)
        
        # --- äº¤æ˜“é‡/å¸‚å ´å¼·åº¦ ---
        data['CMF'] = ta.volume.money_flow_index(data['High'], data['Low'], data['Close'], data['Volume'], window=20, fillna=True)
        
        # --- éš¨æ©ŸæŒ‡æ¨™ (Stochastic Oscillator) ---
        data['Stoch_%K'] = ta.momentum.stoch(data['High'], data['Low'], data['Close'], window=14, smooth_window=3, fillna=True)
        
        return data.dropna()

    except Exception as e:
        st.error(f"æ•¸æ“šç²å–æˆ–è¨ˆç®—æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return None

# ==============================================================================
# 3. å°ˆæ¥­åˆ†æå¼•æ“
# ==============================================================================

def analyze_trend(df):
    """
    åŸ·è¡Œ AI å°ˆå®¶ç´šçš„è¶¨å‹¢ç¢ºèªå’Œç­–ç•¥åˆ†æã€‚
    è¼¸å‡ºï¼š(å»ºè­°, è¶¨å‹¢æ‘˜è¦, ç†ç”±)
    """
    if df is None or df.empty or len(df) < 50:
        return ("âš ï¸ æ•¸æ“šä¸è¶³", "ç­‰å¾…æ•¸æ“š", "æ•¸æ“šé‡ä¸è¶³ä»¥é€²è¡Œå¯é åˆ†æã€‚")

    latest = df.iloc[-1]
    prev = df.iloc[-2]

    # --- 1. è¶¨å‹¢ç¢ºèª ---
    # å‡ç·šè¶¨å‹¢ (çŸ­æœŸ SMA20 vs EMA50)
    ma_trend = "ä¸­æ€§"
    if latest['SMA_20'] > latest['EMA_50']:
        ma_trend = "ğŸ“ˆ ä¸Šæ¼²"
    elif latest['SMA_20'] < latest['EMA_50']:
        ma_trend = "ğŸ“‰ ä¸‹è·Œ"

    # ADX ç¢ºèª (ADX > 25 è¡¨ç¤ºè¶¨å‹¢å¼·åº¦é«˜)
    adx_strength = "å¾®å¼±"
    if latest['ADX_9'] >= 40:
        adx_strength = "å¼·å‹"
    elif latest['ADX_9'] >= 25:
        adx_strength = "ä¸­ç­‰"
    
    # --- 2. å‹•é‡å’Œè¶…è²·/è¶…è³£æª¢æŸ¥ (RSIé–¾å€¼çµ±ä¸€ç‚º 80/20) ---
    rsi_state = "ä¸­æ€§ (50)"
    if latest['RSI'] >= 80:
        rsi_state = "ğŸš¨ è¶…è²· (>80)"
    elif latest['RSI'] <= 20:
        rsi_state = "ğŸŸ¢ è¶…è³£ (<20)"
    elif latest['RSI'] > 50:
        rsi_state = "å‹•èƒ½å‘ä¸Š"
    elif latest['RSI'] < 50:
        rsi_state = "å‹•èƒ½å‘ä¸‹"

    # --- 3. äº¤æ˜“ç­–ç•¥èˆ‡å»ºè­° ---
    
    # åˆå§‹å»ºè­°å’Œç†ç”±
    action = "ä¿æŒè§€å¯Ÿ"
    color = "text-yellow-500"
    reasons = [f"æ•´é«”å‡ç·šè¶¨å‹¢: {ma_trend}ã€‚", f"RSI ç‹€æ…‹: {rsi_state}ã€‚", f"ADX è¶¨å‹¢å¼·åº¦: {adx_strength} (ADX: {latest['ADX_9']:.2f})ã€‚"]

    # å¼·çƒˆè²·å…¥è¨Šè™Ÿ
    if (ma_trend == "ğŸ“ˆ ä¸Šæ¼²" and latest['MACD_Hist'] > 0 and latest['RSI'] < 70 and latest['Stoch_%K'] < 80 and adx_strength in ["ä¸­ç­‰", "å¼·å‹"]):
        action = "âœ… å¼·çƒˆè²·å…¥ (åšå¤š)"
        color = "text-green-500"
        reasons.append("åƒ¹æ ¼åœ¨å‡ç·šä¹‹ä¸Šï¼ŒMACDæŸ±ç‹€åœ–ç‚ºæ­£ï¼ŒRSI/Stoch æœªé”è¶…è²·å€ï¼Œè¶¨å‹¢å¼·å‹ã€‚")

    # å¼·çƒˆè³£å‡ºè¨Šè™Ÿ
    elif (ma_trend == "ğŸ“‰ ä¸‹è·Œ" and latest['MACD_Hist'] < 0 and latest['RSI'] > 30 and latest['Stoch_%K'] > 20 and adx_strength in ["ä¸­ç­‰", "å¼·å‹"]):
        action = "âŒ å¼·çƒˆè³£å‡º (åšç©º)"
        color = "text-red-500"
        reasons.append("åƒ¹æ ¼åœ¨å‡ç·šä¹‹ä¸‹ï¼ŒMACDæŸ±ç‹€åœ–ç‚ºè² ï¼ŒRSI/Stoch æœªé”è¶…è³£å€ï¼Œè¶¨å‹¢å¼·å‹ã€‚")

    # åº•éƒ¨/è¶…è³£åè½‰è¨Šè™Ÿ (å¯èƒ½è²·å…¥)
    elif latest['RSI'] <= 20 and prev['RSI'] <= 20 and latest['Stoch_%K'] > prev['Stoch_%K']:
        action = "ğŸŸ¡ æ½›åœ¨åº•éƒ¨ (é—œæ³¨è²·é»)"
        color = "text-yellow-600"
        reasons.append("RSI è™•æ–¼è¶…è³£å€ï¼Œä¸”éš¨æ©ŸæŒ‡æ¨™é–‹å§‹å‘ä¸Šäº¤å‰ï¼Œé—œæ³¨åè½‰æ©Ÿæœƒã€‚")

    # é ­éƒ¨/è¶…è²·åè½‰è¨Šè™Ÿ (å¯èƒ½è³£å‡º)
    elif latest['RSI'] >= 80 and prev['RSI'] >= 80 and latest['Stoch_%K'] < prev['Stoch_%K']:
        action = "ğŸŸ  æ½›åœ¨é ­éƒ¨ (é—œæ³¨è³£é»)"
        color = "text-orange-600"
        reasons.append("RSI è™•æ–¼è¶…è²·å€ï¼Œä¸”éš¨æ©ŸæŒ‡æ¨™é–‹å§‹å‘ä¸‹äº¤å‰ï¼Œé—œæ³¨å›èª¿é¢¨éšªã€‚")

    trend_summary = f"{ma_trend} | å‹•é‡: {rsi_state} | å¼·åº¦: {adx_strength}"
    detailed_reason = " ".join(reasons)

    # è¿”å›çµæœå’Œé¡è‰²æ¨™è¨˜
    return (action, trend_summary, detailed_reason, color)

def fibonacci_levels(df):
    """
    è¨ˆç®—åŸºæ–¼è¿‘æœŸé«˜ä½é»çš„æ–æ³¢é‚£å¥‘å›æ¸¬æ°´å¹³ã€‚
    """
    if df.empty or len(df) < 50:
        return {"Error": "æ•¸æ“šä¸è¶³"}
        
    # å°‹æ‰¾è¿‘æœŸçš„ä¸»è¦æ³¢å‹•ï¼ˆä¾‹å¦‚ï¼Œéå»30å€‹é€±æœŸï¼‰
    recent_df = df.iloc[-30:]
    low_price = recent_df['Low'].min()
    high_price = recent_df['High'].max()
    price_range = high_price - low_price
    
    if price_range == 0:
        return {"Note": "è¿‘æœŸåƒ¹æ ¼æ³¢å‹•æ¥µå°ï¼Œç„¡æ³•è¨ˆç®—æ–æ³¢é‚£å¥‘æ°´å¹³ã€‚"}

    levels = {}
    for level in FIB_LEVELS:
        # å¾é«˜é»ä¸‹è·Œçš„è¶¨å‹¢ (æ‰¾æ”¯æ’)
        levels[f'Support_{level*100:.1f}%'] = high_price - (price_range * level)
        # å¾ä½é»ä¸Šæ¼²çš„è¶¨å‹¢ (æ‰¾å£“åŠ›/ç›®æ¨™)
        levels[f'Resistance_{(1-level)*100:.1f}%'] = low_price + (price_range * (1-level))
        
    # ç°¡åŒ–ç‚ºå¸¸ç”¨çš„å›æ’¤å’Œæ“´å±•æ°´å¹³
    fib_analysis = {
        "Low": low_price,
        "High": high_price,
        "Range": price_range,
        "23.6% å›æ’¤ (æ”¯æ’)": high_price - (price_range * 0.236),
        "38.2% å›æ’¤ (é—œéµæ”¯æ’)": high_price - (price_range * 0.382),
        "50.0% å›æ’¤ (ä¸­æ€§é»)": high_price - (price_range * 0.5),
        "61.8% å›æ’¤ (é»ƒé‡‘æ”¯æ’)": high_price - (price_range * 0.618),
    }
    return fib_analysis

# ==============================================================================
# 4. Streamlit UI å‡½æ•¸
# ==============================================================================

def get_symbol_name(symbol):
    """æ ¹æ“šä»£ç¢¼ç²å–ä¸­æ–‡åç¨±"""
    for key, val in FULL_SYMBOLS_MAP.items():
        if key == symbol:
            return val['name']
    return symbol

def sidebar_inputs():
    """å´é‚Šæ¬„è¼¸å…¥æ§åˆ¶"""
    st.sidebar.title("ğŸ› ï¸ AI åˆ†æé…ç½®")
    st.sidebar.markdown("---")

    # 1. è³‡ç”¢é¡åˆ¥é¸æ“‡
    asset_types = ["ç¾è‚¡", "å°è‚¡", "åŠ å¯†è²¨å¹£"]
    selected_type = st.sidebar.radio("1. é¸æ“‡è³‡ç”¢é¡åˆ¥:", asset_types, key='asset_type')

    # æ ¹æ“šé¡åˆ¥éæ¿¾æ¨™çš„
    filtered_symbols = {k: v for k, v in FULL_SYMBOLS_MAP.items() if v['type'] == selected_type}
    
    # 2. æ¨™çš„å¿«é€Ÿé¸æ“‡/æ‰‹å‹•è¼¸å…¥
    popular_options = list(filtered_symbols.keys())
    
    # ç¢ºä¿ç•¶å‰é¸æ“‡çš„æ¨™çš„åœ¨é¸é …ä¸­
    current_symbol = st.session_state.get('last_search_symbol', popular_options[0] if popular_options else "")
    if current_symbol not in popular_options and current_symbol:
        # å¦‚æœç”¨æˆ¶æ‰‹å‹•è¼¸å…¥çš„ä»£ç¢¼ä¸æ˜¯ç†±é–€é¸é …ï¼Œä¹Ÿå…è¨±å…¶å­˜åœ¨
        popular_options.insert(0, current_symbol)
        
    # ä¸‹æ‹‰é¸å–®
    selected_symbol_from_dropdown = st.sidebar.selectbox(
        "2. å¿«é€Ÿé¸æ“‡/ç•¶å‰æ¨™çš„:", 
        options=popular_options, 
        index=0 if current_symbol in popular_options else (0 if popular_options else 0),
        key='symbol_selectbox'
    )
    
    # æ‰‹å‹•è¼¸å…¥æ¡† (ç”¨ä¾†è¦†è“‹ selectbox çš„é¸æ“‡)
    # å…è¨±ç”¨æˆ¶ç›´æ¥è¼¸å…¥ä»£ç¢¼
    symbol_input = st.sidebar.text_input(
        "æˆ–æ‰‹å‹•è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼/åç¨±:", 
        value=st.session_state.get('sidebar_search_input', selected_symbol_from_dropdown),
        key='sidebar_search_input',
        placeholder="ä¾‹å¦‚: GOOGL, 2330.TW, BTC-USD"
    )

    # æ±ºå®šæœ€çµ‚ä½¿ç”¨çš„æ¨™çš„
    final_symbol = symbol_input.upper() if symbol_input else selected_symbol_from_dropdown

    # 3. é€±æœŸé¸æ“‡
    interval_options = list(PERIOD_MAP.keys())
    selected_interval = st.sidebar.selectbox("3. é¸æ“‡åˆ†æé€±æœŸ:", interval_options, index=2) # é è¨­æ—¥ç·š

    st.sidebar.markdown("---")
    
    # 4. åŸ·è¡Œåˆ†ææŒ‰éˆ•
    if st.sidebar.button("ğŸ“Š åŸ·è¡ŒAIåˆ†æ", type="primary"):
        # è¨­ç½®ç‹€æ…‹ä»¥è§¸ç™¼æ•¸æ“šç²å–å’Œåˆ†æ
        st.session_state['last_search_symbol'] = final_symbol
        st.session_state['last_search_interval'] = selected_interval
        st.session_state['run_analysis'] = True # <--- THIS LINE WAS CAUSING THE ERROR IF NOT INITIALIZED

    st.sidebar.markdown("---")
    
    return final_symbol, selected_interval

def display_ohlc_chart(df, symbol_name, interval, fib_levels):
    """ç¹ªè£½ OHLC Kç·šåœ–åŠé—œéµæŒ‡æ¨™åœ–è¡¨ (å°ˆå®¶åœ–è¡¨ Pro)"""
    
    fig = make_subplots(
        rows=4, cols=1, 
        shared_xaxes=True, 
        vertical_spacing=0.05, 
        row_heights=[0.5, 0.15, 0.15, 0.2]
    )

    # 1. Kç·šåœ– & å‡ç·š & å¸ƒæ—é€šé“
    fig.add_trace(go.Candlestick(x=df.index,
                                 open=df['Open'],
                                 high=df['High'],
                                 low=df['Low'],
                                 close=df['Close'],
                                 name='Kç·š'), row=1, col=1)
    
    # å‡ç·š
    fig.add_trace(go.Scatter(x=df.index, y=df['SMA_20'], name='SMA(20)', line=dict(color='#8B0000', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['EMA_50'], name='EMA(50)', line=dict(color='#006400', width=1.5)), row=1, col=1)

    # å¸ƒæ—é€šé“
    fig.add_trace(go.Scatter(x=df.index, y=df['BB_High'], name='BB High', line=dict(color='grey', width=0.5, dash='dash')), row=1, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['BB_Low'], name='BB Low', line=dict(color='grey', width=0.5, dash='dash')), row=1, col=1)
    
    # æ–æ³¢é‚£å¥‘æ°´å¹³ç·š (ä½œç‚ºå‹•æ…‹æ”¯æ’/å£“åŠ›)
    if 'Error' not in fib_levels and 'Note' not in fib_levels:
        high = fib_levels['High']
        low = fib_levels['Low']
        
        # é—œéµæ”¯æ’ç·š (38.2%, 61.8%)
        fig.add_hline(y=fib_levels['38.2% å›æ’¤ (é—œéµæ”¯æ’)'], line_width=1, line_dash="dash", line_color="#3cb371", row=1, col=1, name='FIB 38.2%')
        fig.add_hline(y=fib_levels['61.8% å›æ’¤ (é»ƒé‡‘æ”¯æ’)'], line_width=1, line_dash="dash", line_color="#fa8072", row=1, col=1, name='FIB 61.8%')
        
        # æ¨™è¨»ç¯„åœ
        fig.add_annotation(x=df.index[-1], y=high, text=f"High: {high:.2f}", showarrow=False, yshift=10, row=1, col=1)
        fig.add_annotation(x=df.index[-1], y=low, text=f"Low: {low:.2f}", showarrow=False, yshift=-10, row=1, col=1)

    # 2. MACD (9, 16, 5)
    fig.add_trace(go.Scatter(x=df.index, y=df['MACD'], name='MACD', line=dict(color='#007bff')), row=2, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['MACD_Signal'], name='Signal', line=dict(color='#ffc107', dash='dot')), row=2, col=1)
    fig.add_trace(go.Bar(x=df.index, y=df['MACD_Hist'], name='Hist', marker_color=np.where(df['MACD_Hist'] > 0, '#28a745', '#dc3545')), row=2, col=1)
    fig.add_hline(y=0, line_width=1, line_dash="dash", line_color="grey", row=2, col=1)

    # 3. RSI (80/20 é–¾å€¼) & ADX
    fig.add_trace(go.Scatter(x=df.index, y=df['RSI'], name='RSI(14)', line=dict(color='#17a2b8')), row=3, col=1)
    fig.add_hline(y=80, line_width=1, line_dash="dash", line_color="red", row=3, col=1) # è¶…è²·ç·š
    fig.add_hline(y=20, line_width=1, line_dash="dash", line_color="green", row=3, col=1) # è¶…è³£ç·š
    fig.add_hline(y=50, line_width=0.5, line_dash="dot", line_color="grey", row=3, col=1) # ä¸­ç·š

    # 4. Stochastic & Volume/CMF (åˆä½µ)
    # Stoch %K
    fig.add_trace(go.Scatter(x=df.index, y=df['Stoch_%K'], name='Stoch %K', line=dict(color='cyan')), row=4, col=1)
    fig.add_hrect(y0=80, y1=100, line_width=0, fillcolor="red", opacity=0.2, row=4, col=1)
    fig.add_hrect(y0=0, y1=20, line_width=0, fillcolor="green", opacity=0.2, row=4, col=1)
    
    # äº¤æ˜“é‡
    fig.add_trace(go.Bar(x=df.index, y=df['Volume'], name='Volume', marker_color=np.where(df['Close'] > df['Open'], '#28a745', '#dc3545'), opacity=0.3, yaxis='y2'), row=4, col=1)
    
    # CMF
    # fig.add_trace(go.Scatter(x=df.index, y=df['CMF']*100, name='CMF', line=dict(color='purple', width=1), yaxis='y3'), row=4, col=1)
    # fig.add_hline(y=0, line_width=1, line_dash="dash", line_color="grey", row=4, col=1)

    # --- åœ–è¡¨ä½ˆå±€èˆ‡å„ªåŒ– ---
    title_html = f"<div style='text-align: center; color: #4A90E2;'><h4>{symbol_name} ({df.index[-1].strftime('%Y-%m-%d')} - {interval} Kç·š)</h4></div>"
    st.markdown(title_html, unsafe_allow_html=True)

    fig.update_layout(
        xaxis_rangeslider_visible=False, 
        height=800, 
        title_text=f"{symbol_name} æŠ€è¡“åˆ†æåœ–è¡¨ ({interval})",
        template="plotly_dark",
        margin=dict(l=20, r=20, t=50, b=20),
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1)
    )

    # èª¿æ•´ Y è»¸æ¨™ç±¤
    fig.update_yaxes(title_text="åƒ¹æ ¼", row=1, col=1)
    fig.update_yaxes(title_text="MACD", row=2, col=1)
    fig.update_yaxes(title_text="RSI", row=3, col=1)
    fig.update_yaxes(title_text="Stoch", row=4, col=1)
    
    # ç‚º Volume è¨­ç½®ç¬¬äºŒ Y è»¸
    fig.update_layout(yaxis4=dict(title="Volume", overlaying="y4", side="right"))
    
    st.plotly_chart(fig, use_container_width=True)

def display_expert_summary(action, trend_summary, detailed_reason, color, fib_levels):
    """é¡¯ç¤º AI å°ˆå®¶ç¸½çµå’Œæ–æ³¢é‚£å¥‘åˆ†æ"""
    
    st.markdown("## ğŸ¤– AI å°ˆå®¶ç¸½çµ")
    
    col1, col2 = st.columns([2, 1])

    with col1:
        st.subheader("ğŸ’¡ è¡Œå‹•å»ºè­°")
        st.markdown(f"""
        <div style="border: 2px solid {color.replace('text-', '').replace('-500', '')}; padding: 15px; border-radius: 10px; background-color: rgba(30, 30, 30, 0.5);">
            <h3 style="margin-top: 0; color: {color.replace('text-', '').replace('-500', '')};">{action}</h3>
            <p style="font-size: 16px;">**è¶¨å‹¢æ‘˜è¦:** {trend_summary}</p>
            <p style="font-style: italic; font-size: 14px;">**AI ç†ç”±:** {detailed_reason}</p>
        </div>
        """, unsafe_allow_html=True)

    with col2:
        st.subheader("ğŸ“ æ–æ³¢é‚£å¥‘å›æ¸¬åˆ†æ")
        if 'Error' in fib_levels or 'Note' in fib_levels:
            st.warning(fib_levels.get('Error') or fib_levels.get('Note'))
        else:
            st.markdown(f"**è¿‘æœŸé«˜é» (R):** `{fib_levels['High']:.2f}`")
            st.markdown(f"**è¿‘æœŸä½é» (S):** `{fib_levels['Low']:.2f}`")
            st.markdown("---")
            st.markdown(f"**é»ƒé‡‘æ”¯æ’ (61.8%):** <span style='color: #fa8072; font-weight: bold;'>{fib_levels['61.8% å›æ’¤ (é»ƒé‡‘æ”¯æ’)']:.2f}</span>", unsafe_allow_html=True)
            st.markdown(f"**é—œéµæ”¯æ’ (38.2%):** <span style='color: #3cb371; font-weight: bold;'>{fib_levels['38.2% å›æ’¤ (é—œéµæ”¯æ’)']:.2f}</span>", unsafe_allow_html=True)
            st.markdown(f"**ä¸­æ€§é» (50.0%):** `{fib_levels['50.0% å›æ’¤ (ä¸­æ€§é»)']:.2f}`")


def intro_page():
    """é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼ä»‹ç´¹é é¢"""
    st.title("ğŸ“ˆ AI è¶¨å‹¢åˆ†æå„€è¡¨æ¿")
    st.markdown("---")
    
    st.header("æ­¡è¿ä½¿ç”¨ AI å°ˆæ¥­ç´šé‡‘èåˆ†æå·¥å…·")
    st.info(f"é€™æ˜¯ä¸€å€‹ç”± AI é©…å‹•çš„æŠ€è¡“åˆ†æå„€è¡¨æ¿ï¼Œèåˆäº†å¤šé …å°ˆå®¶ç´šæŒ‡æ¨™ï¼ˆMACD 9/16/5, RSI 80/20, æ–æ³¢é‚£å¥‘å›æ¸¬ç­‰ï¼‰ï¼Œæ—¨åœ¨ç‚ºæ‚¨æä¾› **ç²¾ç¢ºä¸”æœ‰ç†æœ‰æ“šçš„äº¤æ˜“ç­–ç•¥å»ºè­°**ã€‚è«‹åœ¨å·¦å´æ¬„é…ç½®åˆ†æåƒæ•¸ï¼Œç„¶å¾Œé»æ“Š <span style='color: #FA8072; font-weight: bold;'>ã€ğŸ“Š åŸ·è¡ŒAIåˆ†æã€</span> æŒ‰éˆ•é–‹å§‹ã€‚", unsafe_allow_html=True)
    
    st.markdown("---")
    
    st.subheader("ğŸ“ ä½¿ç”¨æ­¥é©Ÿï¼š")
    st.markdown("1. **é¸æ“‡è³‡ç”¢é¡åˆ¥**ï¼šåœ¨å·¦å´æ¬„é¸æ“‡ `ç¾è‚¡`ã€`å°è‚¡` æˆ– `åŠ å¯†è²¨å¹£`ã€‚")
    st.markdown("2. **é¸æ“‡æ¨™çš„**ï¼šä½¿ç”¨ä¸‹æ‹‰é¸å–®å¿«é€Ÿé¸æ“‡ç†±é–€æ¨™çš„ï¼Œæˆ–ç›´æ¥åœ¨è¼¸å…¥æ¡†ä¸­éµå…¥ä»£ç¢¼æˆ–åç¨±ã€‚")
    st.markdown("3. **é¸æ“‡é€±æœŸ**ï¼šæ±ºå®šåˆ†æçš„é•·åº¦ï¼ˆä¾‹å¦‚ï¼š`30 åˆ†`ã€`4 å°æ™‚`ã€`1 æ—¥`ã€`1 å‘¨`ï¼‰ã€‚")
    st.markdown(f"4. **åŸ·è¡Œåˆ†æ**ï¼šé»æ“Š <span style='color: #FA8072; font-weight: bold;'>ã€ğŸ“Š åŸ·è¡ŒAIåˆ†æã€</span>ï¼ŒAIå°‡èåˆåŸºæœ¬é¢èˆ‡æŠ€è¡“é¢æŒ‡æ¨™æä¾›äº¤æ˜“ç­–ç•¥ã€‚", unsafe_allow_html=True)
    
    st.markdown("---")


def main():
    """ä¸»æ‡‰ç”¨ç¨‹å¼æµç¨‹æ§åˆ¶"""
    
    # å´é‚Šæ¬„è¼¸å…¥
    current_symbol, current_interval = sidebar_inputs()
    
    # æª¢æŸ¥æ˜¯å¦æ‡‰é‹è¡Œåˆ†æ
    run_analysis = st.session_state.get('run_analysis', False)
    
    if run_analysis:
        
        symbol_for_analysis = st.session_state.get('last_search_symbol', current_symbol)
        interval_for_analysis = st.session_state.get('last_search_interval', current_interval)
        
        # ç²å– YFinance åƒæ•¸
        period, interval_yf = PERIOD_MAP.get(interval_for_analysis, PERIOD_MAP["1 æ—¥"])
        
        # é¡¯ç¤ºåŠ è¼‰å‹•ç•«
        with st.spinner(f'æ­£åœ¨ç‚º {symbol_for_analysis} ({interval_for_analysis}) ç²å–æ•¸æ“šä¸¦åŸ·è¡Œ AI å°ˆå®¶åˆ†æ...'):
            df = fetch_and_calculate_data(symbol_for_analysis, period, interval_yf)
            
        st.session_state['run_analysis'] = False # åˆ†æå®Œæˆï¼Œå°‡ç‹€æ…‹è¨­ç½®å› False

        if df is not None:
            st.session_state['data_ready'] = True
            
            # ç²å–ä¸­æ–‡åç¨±
            symbol_name = get_symbol_name(symbol_for_analysis)
            
            # åŸ·è¡Œå°ˆå®¶åˆ†æ
            action, trend_summary, detailed_reason, color = analyze_trend(df)
            fib_levels = fibonacci_levels(df)
            
            # é¡¯ç¤ºå°ˆå®¶ç¸½çµ
            display_expert_summary(action, trend_summary, detailed_reason, color, fib_levels)
            
            st.markdown("---")

            # é¡¯ç¤º K ç·šåœ–å’ŒæŒ‡æ¨™
            display_ohlc_chart(df, symbol_name, interval_for_analysis, fib_levels)

        else:
            st.session_state['data_ready'] = False
            st.error("ç„¡æ³•ç²å–è©²æ¨™çš„çš„æ•¸æ“šã€‚è«‹æª¢æŸ¥è‚¡ç¥¨ä»£ç¢¼æ˜¯å¦æ­£ç¢ºæˆ–æ•¸æ“šé‡æ˜¯å¦è¶³å¤ ã€‚")
            intro_page() # é¡¯ç¤ºä»‹ç´¹é 
            
    else:
        # é¦–æ¬¡åŠ è¼‰æˆ–æœªé»æ“ŠæŒ‰éˆ•æ™‚ï¼Œé¡¯ç¤ºä»‹ç´¹é 
        intro_page()

# ==============================================================================
# 5. æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
# ==============================================================================

if __name__ == '__main__':
    # Streamlit æ‡‰ç”¨ç¨‹å¼çš„ Session State å¿…é ˆåœ¨æ­¤åˆå§‹åŒ–ï¼Œç¢ºä¿æ‰€æœ‰éµå­˜åœ¨ã€‚
    if 'last_search_symbol' not in st.session_state:
        st.session_state['last_search_symbol'] = "2330.TW"
    if 'data_ready' not in st.session_state:
        st.session_state['data_ready'] = False
    if 'sidebar_search_input' not in st.session_state:
        st.session_state['sidebar_search_input'] = ""
    if 'last_search_interval' not in st.session_state:
        st.session_state['last_search_interval'] = "1 æ—¥"
    
    # *** é—œéµä¿®å¾©ï¼šåˆå§‹åŒ–å¼•èµ·éŒ¯èª¤çš„ç‹€æ…‹éµ ***
    if 'run_analysis' not in st.session_state:
        st.session_state['run_analysis'] = False
        
    main()
