# -*- coding: utf-8 -*-
"""
AI è¶¨å‹¢åˆ†æ Streamlit æ‡‰ç”¨ç¨‹å¼
å°ˆå®¶å¢å¼·æœ€çµ‚ç‰ˆå¯¦ä½œ (V2.0 - Interactive Dashboard)

æœ¬æ‡‰ç”¨ç¨‹å¼æ ¹æ“šä¸€ä»½è©³ç´°çš„é‡‘èåˆ†æå·¥å…·è¨­å®šæ–‡ä»¶é€²è¡Œé–‹ç™¼ï¼Œ
æ—¨åœ¨æä¾›ä¸€å€‹æ•´åˆæ€§çš„è‚¡ç¥¨ã€ETFã€æŒ‡æ•¸åŠåŠ å¯†è²¨å¹£çš„ AI è¶¨å‹¢åˆ†æå¹³å°ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š
- [å‡ç´š] äº’å‹•å¼æ±ºç­–å„€è¡¨æ¿
- [å‡ç´š] å¯è§£é‡‹æ€§ AI (XAI) æ±ºç­–ä¾æ“šå±•ç¤º
- [å‡ç´š] åŒ…å«å‹•æ…‹éƒ¨ä½è¦æ¨¡è¨ˆç®—çš„å°ˆæ¥­é¢¨éšªç®¡ç†
- çµ±ä¸€æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“
- é›™è»Œåˆ¶åŸºæœ¬é¢è©•åˆ†ç³»çµ±
- AI èåˆä¿¡è™Ÿç”Ÿæˆæ¨¡å‹
- æ¨™æº–åŒ–ç­–ç•¥å›æ¸¬å¼•æ“

é–‹ç™¼è€…ï¼šç¨‹å¼ç¢¼å°ˆå®¶ (Generated by Gemini)
ç‰ˆæœ¬ï¼š2.0.0 (Major Refactor based on Expert Document)
"""

# è¼‰å…¥æ ¸å¿ƒå¥—ä»¶
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import pandas_ta as ta
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# --- 1. æ‡‰ç”¨ç¨‹å¼å…¨åŸŸè¨­å®šèˆ‡éœæ…‹è³‡æ–™ ---

# è¨­ç½®é é¢é…ç½® (å¯¬ç‰ˆ)
st.set_page_config(
    page_title="ğŸš€ AI è¶¨å‹¢åˆ†æå°ˆå®¶ç³»çµ±",
    page_icon="ğŸ“ˆ",
    layout="wide"
)

# (NEW v2.0) æ‡‰ç”¨ç¨‹å¼çš„è‡ªè¨‚ CSS æ¨£å¼
st.markdown("""
<style>
    /* ä¸»è¦æ¨™é¡Œèˆ‡æŒ‰éˆ•çš„æ·¡é®­é­šè‰²èª¿ */
    .salmon-text {
        color: #FA8072;
    }
    /* å¼·èª¿èªªæ˜æ–‡å­— */
    .stButton>button {
        border-color: #FA8072;
        color: #FA8072;
    }
    .stButton>button:hover {
        border-color: #E9967A;
        color: #E9967A;
    }
</style>
""", unsafe_allow_html=True)


# è³‡ç”¢åº« (FULL_SYMBOLS_MAP)
FULL_SYMBOLS_MAP = {
    'ç¾è‚¡': {
        'AAPL': {'name': 'è˜‹æœ', 'keywords': ['Apple', 'iPhone']},
        'GOOGL': {'name': 'Alphabet (Google)', 'keywords': ['google', 'android']},
        'MSFT': {'name': 'å¾®è»Ÿ', 'keywords': ['Microsoft', 'windows']},
        'NVDA': {'name': 'è¼é”', 'keywords': ['Nvidia', 'AI', 'GPU']},
        'TSLA': {'name': 'ç‰¹æ–¯æ‹‰', 'keywords': ['Tesla', 'EV']},
        'SPY': {'name': 'S&P 500 ETF', 'keywords': ['sp500', 'index']},
        '^GSPC': {'name': 'S&P 500 æŒ‡æ•¸', 'keywords': ['spx']}
    },
    'å°è‚¡': {
        '2330.TW': {'name': 'å°ç©é›»', 'keywords': ['TSMC']},
        '2317.TW': {'name': 'é´»æµ·', 'keywords': ['foxconn']},
        '2454.TW': {'name': 'è¯ç™¼ç§‘', 'keywords': ['mediatek']},
        '0050.TW': {'name': 'å…ƒå¤§å°ç£50', 'keywords': ['etf']},
        '^TWII': {'name': 'å°ç£åŠ æ¬ŠæŒ‡æ•¸', 'keywords': ['taiex']}
    },
    'åŠ å¯†è²¨å¹£': {
        'BTC-USD': {'name': 'æ¯”ç‰¹å¹£', 'keywords': ['Bitcoin']},
        'ETH-USD': {'name': 'ä»¥å¤ªå¹£', 'keywords': ['Ethereum']},
        'SOL-USD': {'name': 'Solana', 'keywords': ['sol']},
    }
}

# åˆ†æé€±æœŸ (PERIOD_MAP)
PERIOD_MAP = {
    '30 åˆ†': {'period': '60d', 'interval': '30m'},
    '4 å°æ™‚': {'period': '1y', 'interval': '60m'},
    '1 æ—¥': {'period': '5y', 'interval': '1d'},
    '1 é€±': {'period': 'max', 'interval': '1wk'}
}

# --- 2. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ (å¾Œç«¯é‚è¼¯) ---

@st.cache_data(ttl=600)
def get_data(symbol, period, interval):
    """
    ä½¿ç”¨ yfinance ç²å–æŒ‡å®šè³‡ç”¢çš„æ­·å²å¸‚å ´æ•¸æ“šã€‚
    """
    try:
        ticker = yf.Ticker(symbol)
        df = ticker.history(period=period, interval=interval)
        if df.empty:
            st.error(f"éŒ¯èª¤ï¼šç„¡æ³•ç²å– '{symbol}' çš„æ•¸æ“šã€‚è«‹æª¢æŸ¥ä»£ç¢¼æˆ–æ›´æ›åˆ†æé€±æœŸã€‚")
            return None
        df.index = pd.to_datetime(df.index)
        if 'USD' in symbol:
             df.index = df.index.tz_convert(None)
        else:
             df.index = df.index.tz_localize(None)
        return df
    except Exception as e:
        st.error(f"æ•¸æ“šç²å–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
        return None

@st.cache_data
def calculate_indicators(df):
    """
    çµ±ä¸€è¨ˆç®—æ‰€æœ‰å¿…è¦çš„æŠ€è¡“æŒ‡æ¨™ã€‚
    """
    df.ta.ema(length=10, append=True)
    df.ta.ema(length=50, append=True)
    df.ta.ema(length=200, append=True)
    df.ta.macd(fast=12, slow=26, signal=9, append=True)
    df.ta.adx(length=14, append=True)
    df.ta.rsi(length=14, append=True)
    df.ta.bbands(length=20, std=2, append=True)
    df.ta.atr(length=14, append=True)
    df.ta.obv(append=True)
    df.ta.cmf(length=20, append=True)
    df.dropna(inplace=True)
    return df

@st.cache_data(ttl=3600)
def get_fundamental_data(symbol):
    """
    ç²å–åŸºæœ¬é¢æ•¸æ“šèˆ‡æ–°èã€‚
    """
    try:
        if any(keyword in symbol for keyword in ['-USD', '^']):
             return {'info': {}, 'news': [{'title': 'æŒ‡æ•¸æˆ–åŠ å¯†è²¨å¹£ç„¡åŸºæœ¬é¢/æ–°èæ•¸æ“š'}]}
        ticker = yf.Ticker(symbol)
        info = ticker.info
        news = ticker.news
        return {'info': info, 'news': news[:5]}
    except Exception:
        return {'info': {}, 'news': [{'title': 'ç„¡æ³•ç²å–æ­¤è³‡ç”¢çš„åŸºæœ¬é¢/æ–°èæ•¸æ“š'}]}

def calculate_fundamental_scores(info):
    """
    é›™è»Œåˆ¶åŸºæœ¬é¢è©•åˆ†ã€‚
    """
    ai_score, display_score = 0, 0
    roe = info.get('returnOnEquity', 0)
    debt_to_equity = info.get('debtToEquity')
    revenue_growth = info.get('revenueGrowth', 0)
    pe_ratio = info.get('trailingPE')
    peg_ratio = info.get('pegRatio')
    free_cash_flow = info.get('freeCashflow', 0)
    total_cash = info.get('totalCash', 0)
    total_debt = info.get('totalDebt', 1)

    if roe is not None and roe > 0.15: ai_score += 2
    if debt_to_equity is not None and debt_to_equity < 50: ai_score += 2
    if revenue_growth is not None and revenue_growth > 0.10: ai_score += 1
    if pe_ratio is not None and pe_ratio < 15: ai_score += 1
    if peg_ratio is not None and peg_ratio < 1: ai_score += 1

    if roe is not None:
        if roe > 0.15: display_score += 3
        elif roe > 0.10: display_score += 2
        elif roe > 0: display_score += 1
    if pe_ratio is not None:
        if pe_ratio < 15: display_score += 3
        elif pe_ratio < 25: display_score += 2
        elif pe_ratio < 35: display_score += 1
    if free_cash_flow > 0 and total_cash > total_debt: display_score += 3
    elif free_cash_flow > 0 or total_cash > total_debt: display_score += 2
    elif total_cash > total_debt * 0.5: display_score += 1
        
    return {'ai_score': ai_score, 'display_score': display_score}

def generate_ai_fusion_signal(df, fa_score):
    """
    AI èåˆä¿¡è™Ÿç”Ÿæˆæ¨¡å‹ã€‚
    (UPDATED v2.0) è¿”å›è©³ç´°çš„æ±ºç­–ä¾æ“šåˆ†æ•¸ (decision_factors)
    """
    latest, prev = df.iloc[-1], df.iloc[-2]
    decision_factors = {}

    ma_score = 0
    if latest['EMA_10'] > latest['EMA_50'] and prev['EMA_10'] <= prev['EMA_50']: ma_score = 3.5
    elif latest['EMA_10'] < latest['EMA_50'] and prev['EMA_10'] >= prev['EMA_50']: ma_score = -3.5
    elif latest['EMA_10'] > latest['EMA_50'] and latest['EMA_50'] > latest['EMA_200']: ma_score = 2.0
    elif latest['EMA_10'] < latest['EMA_50'] and latest['EMA_50'] < latest['EMA_200']: ma_score = -2.0
    decision_factors['è¶¨å‹¢åˆ†æ•¸ (MA Score)'] = ma_score

    momentum_score = 0
    if latest['RSI_14'] < 40: momentum_score = 2.0
    elif latest['RSI_14'] > 60: momentum_score = -2.0
    decision_factors['å‹•èƒ½åˆ†æ•¸ (Momentum Score)'] = momentum_score
        
    strength_score = 0
    if latest['MACDh_12_26_9'] > 0 and latest['MACDh_12_26_9'] > prev['MACDh_12_26_9']: strength_score = 1.5
    elif latest['MACDh_12_26_9'] < 0 and latest['MACDh_12_26_9'] < prev['MACDh_12_26_9']: strength_score = -1.5
    if latest['ADX_14'] > 25: strength_score *= 1.5
    decision_factors['å¼·åº¦åˆ†æ•¸ (Strength Score)'] = strength_score

    kline_score = 0
    if 'ATRr_14' in latest.index and abs(latest['Close'] - latest['Open']) > 0.7 * latest['ATRr_14']:
        kline_score = 1.0 if latest['Close'] > latest['Open'] else -1.0
    decision_factors['Kç·šåˆ†æ•¸ (Kline Score)'] = kline_score
    
    fa_normalized_score = 0
    if fa_score > 0:
      fa_normalized_score = (fa_score / 7) * 3 
    decision_factors['åŸºæœ¬é¢åˆ†æ•¸ (FA Score)'] = fa_normalized_score
    
    total_score = sum(decision_factors.values())

    if total_score >= 4.0: action = "è²·é€² (Buy)"
    elif 1.0 <= total_score < 4.0: action = "ä¸­æ€§åè²· (Hold/Buy)"
    elif -1.0 < total_score < 1.0: action = "è§€æœ› (Neutral)"
    elif -4.0 < total_score <= -1.0: action = "ä¸­æ€§åè³£ (Hold/Sell)"
    else: action = "è³£å‡º (Sell/Short)"

    confidence = min(int(abs(total_score) / 8.0 * 100), 100)
        
    return {'total_score': round(total_score, 2), 'action': action, 'confidence': confidence, 'factors': decision_factors}

def calculate_entry_price(action, latest):
    """
    æ ¹æ“š AI è¡Œå‹•å»ºè­°è¨ˆç®—å»ºè­°çš„å…¥å ´åƒ¹ä½ã€‚
    """
    entry_price = "N/A"
    if 'Buy' in action:
        entry_price = latest.get('EMA_10', latest['Close'] * 0.995)
    elif 'Sell' in action:
        entry_price = latest.get('EMA_10', latest['Close'] * 1.005)
    
    if isinstance(entry_price, (int, float)):
        return round(entry_price, 2)
    return entry_price

def calculate_risk_management(df):
    """
    å¤šç­–ç•¥å…±è­˜æ­¢ç›ˆæ­¢æè¨ˆç®—ã€‚
    """
    latest = df.iloc[-1]
    sl_prices, tp_prices = [], []

    if 'ATRr_14' in latest.index and pd.notna(latest['ATRr_14']):
        sl_prices.append(latest['Close'] - 2 * latest['ATRr_14'])
        tp_prices.append(latest['Close'] + 2 * latest['ATRr_14'])
    if 'BBL_20_2.0' in latest.index and 'BBU_20_2.0' in latest.index:
        sl_prices.append(latest['BBL_20_2.0'])
        tp_prices.append(latest['BBU_20_2.0'])
    if len(df) >= 30:
        recent_df = df.iloc[-30:]
        sl_prices.append(recent_df['Low'].min())
        tp_prices.append(recent_df['High'].max())

    if not sl_prices or not tp_prices:
        fallback_atr = latest.get('ATRr_14', latest['Close'] * 0.05)
        if pd.isna(fallback_atr): fallback_atr = latest['Close'] * 0.05
        return {'sl': round(latest['Close'] - 2 * fallback_atr, 2), 'tp': round(latest['Close'] + 2 * fallback_atr, 2)}

    return {'sl': round(np.mean(sorted(sl_prices, reverse=True)[:2]), 2), 'tp': round(np.mean(sorted(tp_prices)[:2]), 2)}

def run_backtest(df):
    """
    ç­–ç•¥å›æ¸¬å¼•æ“: SMA 20 / EMA 50 å‡ç·šäº¤å‰ç­–ç•¥ã€‚
    """
    if 'EMA_50' not in df.columns: df.ta.ema(length=50, append=True)
    df['SMA_20'] = ta.sma(df['Close'], length=20)
    df.dropna(inplace=True)
    
    if df.empty: return {'total_return': 0, 'win_rate': 0, 'max_drawdown': 0, 'trades_count': 0, 'equity_curve': pd.Series([1.0])}

    df['signal'] = 0
    df.loc[(df['SMA_20'] > df['EMA_50']) & (df['SMA_20'].shift(1) <= df['EMA_50'].shift(1)), 'signal'] = 1
    df.loc[(df['SMA_20'] < df['EMA_50']) & (df['SMA_20'].shift(1) >= df['EMA_50'].shift(1)), 'signal'] = -1

    position, trades = 0, []
    for i, row in df.iterrows():
        if position == 0 and row['signal'] == 1:
            position, entry_price = 1, row['Close']
        elif position == 1 and row['signal'] == -1:
            position, exit_price = 0, row['Close']
            trades.append((exit_price / entry_price) - 1)

    if not trades: return {'total_return': 0, 'win_rate': 0, 'max_drawdown': 0, 'trades_count': 0, 'equity_curve': pd.Series([1.0])}
        
    equity = (pd.Series(trades) + 1).cumprod()
    max_drawdown = abs(((equity - equity.cummax()) / equity.cummax()).min()) * 100

    return {
        'total_return': round((equity.iloc[-1] - 1) * 100 if not equity.empty else 0, 2),
        'win_rate': round(len([t for t in trades if t > 0]) / len(trades) * 100 if trades else 0, 2),
        'max_drawdown': round(max_drawdown, 2),
        'trades_count': len(trades),
        'equity_curve': equity
    }

# --- 3. Streamlit ä½¿ç”¨è€…ä»‹é¢ (UI) ---

with st.sidebar:
    st.image("https://storage.googleapis.com/gemini-prod/images/workspace_icon_for_light_background.png", width=80)
    st.header("âš™ï¸ åˆ†æè¨­å®š")
    
    st.subheader("1. é¸æ“‡åˆ†æè³‡ç”¢")
    
    def clear_manual_input():
        st.session_state.manual_input = ""

    asset_category = st.selectbox("è³‡ç”¢é¡åˆ¥", list(FULL_SYMBOLS_MAP.keys()), on_change=clear_manual_input)
    popular_assets = {f"{symbol} ({details['name']})": symbol for symbol, details in FULL_SYMBOLS_MAP[asset_category].items()}
    selected_popular = st.selectbox("ç†±é–€æ¨™çš„", list(popular_assets.keys()), on_change=clear_manual_input)
    manual_input = st.text_input("æˆ–æ‰‹å‹•è¼¸å…¥ä»£ç¢¼ (å„ªå…ˆä½¿ç”¨)", placeholder="ä¾‹å¦‚: 2330.TW, TSLA", key='manual_input')

    if st.session_state.manual_input and st.session_state.manual_input.strip():
        final_symbol = st.session_state.manual_input.strip().upper()
        all_symbols = {s: d['name'] for cat in FULL_SYMBOLS_MAP.values() for s, d in cat.items()}
        final_symbol_name = all_symbols.get(final_symbol, "æœªçŸ¥ä»£ç¢¼")
    else:
        final_symbol = popular_assets[selected_popular]
        final_symbol_name = FULL_SYMBOLS_MAP[asset_category][final_symbol]['name']
        
    st.info(f"ç•¶å‰ç›®æ¨™: **{final_symbol} ({final_symbol_name})**")

    st.subheader("2. é¸æ“‡åˆ†æé€±æœŸ")
    selected_period_label = st.selectbox("æ™‚é–“é€±æœŸ", list(PERIOD_MAP.keys()))
    period_params = PERIOD_MAP[selected_period_label]

    # (NEW v2.0) å‹•æ…‹éƒ¨ä½è¦æ¨¡è¨ˆç®—æ‰€éœ€çš„è¼¸å…¥
    st.subheader("3. é¢¨éšªåå¥½è¨­å®š")
    total_capital = st.number_input("ç¸½è³‡é‡‘ (ç”¨æ–¼éƒ¨ä½è¨ˆç®—)", min_value=1000, value=100000, step=1000)
    risk_per_trade = st.slider("å–®ç­†æœ€å¤§é¢¨éšª (%)", 1.0, 5.0, 2.0, 0.5) / 100

    st.subheader("4. åŸ·è¡Œåˆ†æ")
    start_analysis_html = f"<p class='salmon-text'>ğŸ“Š åŸ·è¡ŒAIåˆ†æ</p>"
    start_analysis = st.button("ğŸ“Š åŸ·è¡ŒAIåˆ†æ", use_container_width=True)


st.markdown("<h1 class='salmon-text'>ğŸš€ æ­¡è¿ä½¿ç”¨ AI è¶¨å‹¢åˆ†æ</h1>", unsafe_allow_html=True)
st.caption(f"æ•¸æ“šæ›´æ–°æ™‚é–“: {pd.Timestamp.now('Asia/Taipei').strftime('%Y-%m-%d %H:%M:%S CST')}")

if start_analysis:
    with st.spinner('AI åˆ†æå¼•æ“å•Ÿå‹•ä¸­ï¼Œè«‹ç¨å€™...'):
        data = get_data(final_symbol, period_params['period'], period_params['interval'])

        if data is not None and not data.empty:
            data_with_indicators = calculate_indicators(data.copy())
            
            if data_with_indicators.empty or len(data_with_indicators) < 2:
                st.error("éŒ¯èª¤ï¼šè¨ˆç®—æŠ€è¡“æŒ‡æ¨™å¾Œç„¡æœ‰æ•ˆæ•¸æ“šï¼Œå¯èƒ½æ˜¯æ­·å²æ•¸æ“šéçŸ­ã€‚è«‹å˜—è©¦æ›´é•·çš„åˆ†æé€±æœŸã€‚")
            else:
                funda_data = get_fundamental_data(final_symbol)
                funda_scores = calculate_fundamental_scores(funda_data['info'])
                ai_signal = generate_ai_fusion_signal(data_with_indicators, funda_scores['ai_score'])
                risk_levels = calculate_risk_management(data_with_indicators)
                entry_price = calculate_entry_price(ai_signal['action'], data_with_indicators.iloc[-1])
                backtest_results = run_backtest(data_with_indicators.copy())

                # (NEW v2.0) è¨ˆç®—å»ºè­°éƒ¨ä½è¦æ¨¡
                position_size = "N/A"
                if isinstance(entry_price, (int, float)) and entry_price > risk_levels['sl']:
                    trade_risk_per_share = entry_price - risk_levels['sl']
                    max_risk_amount = total_capital * risk_per_trade
                    position_size = int(max_risk_amount / trade_risk_per_share)

                # --- [å‡ç´š v2.0] äº’å‹•å¼æ±ºç­–å„€è¡¨æ¿ ---
                st.markdown("---")
                funda_rating = f"åŸºæœ¬é¢è©•ç´š: {funda_scores['display_score']}/9" if funda_scores['display_score'] > 0 else "åŸºæœ¬é¢è©•ç´š: N/A"
                st.header(f"ğŸ“ˆ {final_symbol_name} ({final_symbol}) - {selected_period_label} åˆ†æå ±å‘Š")
                st.subheader(funda_rating)
                st.markdown("---")

                # å„€è¡¨æ¿ä¸ŠåŠéƒ¨: æ ¸å¿ƒæ±ºç­–
                col1, col2 = st.columns([1.5, 1])
                with col1:
                    st.subheader("ğŸ¯ æ ¸å¿ƒè¡Œå‹•èˆ‡é‡åŒ–è©•åˆ†")
                    c1, c2, c3, c4 = st.columns(4)
                    c1.metric("ç•¶å‰åƒ¹æ ¼", f"{data_with_indicators['Close'].iloc[-1]:,.2f}")
                    c2.metric("æœ€çµ‚è¡Œå‹•å»ºè­°", ai_signal['action'])
                    c3.metric("ç¸½é‡åŒ–è©•åˆ†", f"{ai_signal['total_score']:.2f}")
                    c4.metric("ä¿¡å¿ƒæŒ‡æ•¸", f"{ai_signal['confidence']}%")
                
                with col2:
                    st.subheader("ğŸ§  AI æ±ºç­–ä¾æ“š (XAI)")
                    with st.expander("é»æ“ŠæŸ¥çœ‹å„é …å› å­å¾—åˆ†"):
                        for factor, score in ai_signal['factors'].items():
                            st.markdown(f" - **{factor}:** `{score:.2f}`")

                st.markdown("---")

                # å„€è¡¨æ¿ä¸‹åŠéƒ¨: é¢¨éšªèˆ‡å¯¦å‹™
                st.subheader("ğŸ›¡ï¸ ç²¾ç¢ºäº¤æ˜“ç­–ç•¥èˆ‡é¢¨éšªæ§åˆ¶")
                col1, col2, col3, col4, col5 = st.columns(5)
                col1.metric("å»ºè­°æ“ä½œ", ai_signal['action'].split(" ")[0])
                col2.metric("å»ºè­°å…¥å ´åƒ¹", f"{entry_price:,.2f}" if isinstance(entry_price, (int, float)) else "N/A")
                col3.metric("å»ºè­°éƒ¨ä½è¦æ¨¡", f"{position_size} è‚¡/å–®ä½" if isinstance(position_size, int) else "N/A")
                col4.metric("å…±è­˜æ­¢ç›ˆåƒ¹ (TP)", f"{risk_levels['tp']:,.2f}", delta=f"{((risk_levels['tp']/data_with_indicators['Close'].iloc[-1])-1)*100:.2f}%")
                col5.metric("å…±è­˜æ­¢æåƒ¹ (SL)", f"{risk_levels['sl']:,.2f}", delta=f"{((risk_levels['sl']/data_with_indicators['Close'].iloc[-1])-1)*100:.2f}%", delta_color="inverse")
                
                st.markdown("---")

                # å®Œæ•´æŠ€è¡“åˆ†æåœ–è¡¨ (ç§»è‡³å‰æ–¹ï¼Œæ›´ç¬¦åˆå„€è¡¨æ¿é‚è¼¯)
                st.subheader("ğŸ“Š å®Œæ•´æŠ€è¡“åˆ†æåœ–è¡¨")
                fig = make_subplots(rows=4, cols=1, shared_xaxes=True, vertical_spacing=0.03, row_heights=[0.5, 0.15, 0.15, 0.2])
                fig.add_trace(go.Candlestick(x=data_with_indicators.index, open=data_with_indicators['Open'], high=data_with_indicators['High'], low=data_with_indicators['Low'], close=data_with_indicators['Close'], name='Kç·š'), row=1, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['EMA_10'], mode='lines', name='EMA 10', line=dict(color='orange', width=1)), row=1, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['EMA_50'], mode='lines', name='EMA 50', line=dict(color='blue', width=1)), row=1, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['EMA_200'], mode='lines', name='EMA 200', line=dict(color='purple', width=2, dash='dash')), row=1, col=1)
                fig.add_trace(go.Bar(x=data_with_indicators.index, y=data_with_indicators['Volume'], name='æˆäº¤é‡'), row=2, col=1)
                fig.add_trace(go.Bar(x=data_with_indicators.index, y=data_with_indicators['MACDh_12_26_9'], name='MACD Hist'), row=3, col=1)
                fig.add_trace(go.Scatter(x=data_with_indicators.index, y=data_with_indicators['RSI_14'], mode='lines', name='RSI 14'), row=4, col=1)
                fig.add_hline(y=70, line_dash="dash", row=4, col=1, line_color="red")
                fig.add_hline(y=30, line_dash="dash", row=4, col=1, line_color="green")
                fig.update_layout(height=800, xaxis_rangeslider_visible=False, legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1))
                st.plotly_chart(fig, use_container_width=True)

                st.markdown("---")
                # è¼”åŠ©è³‡è¨Šæ¨¡çµ„
                col_main, col_side = st.columns([1,1])
                with col_main:
                    st.subheader(f"ğŸ”™ ç­–ç•¥å›æ¸¬å ±å‘Š (SMA 20/50)")
                    c1, c2, c3, c4 = st.columns(4)
                    c1.metric("ç¸½å›å ±ç‡", f"{backtest_results['total_return']:.2f}%")
                    c2.metric("å‹ç‡", f"{backtest_results['win_rate']:.2f}%")
                    c3.metric("æœ€å¤§å›æ’¤", f"{backtest_results['max_drawdown']:.2f}%")
                    c4.metric("äº¤æ˜“æ¬¡æ•¸", backtest_results['trades_count'])
                with col_side:
                    st.subheader("ğŸ“° æœ€æ–°ç›¸é—œæ–°è")
                    for news_item in funda_data['news']:
                        title = news_item.get('title', 'æ–°èæ¨™é¡Œä¸å¯ç”¨')
                        link = news_item.get('link')
                        if link: st.markdown(f"- [{title}]({link})")
                        else: st.markdown(f"- {title}")

else:
    # (NEW v2.0) å…¨æ–°çš„æ­¡è¿é é¢
    st.markdown("""
    <p>è«‹åœ¨å·¦å´é¸æ“‡æˆ–è¼¸å…¥æ‚¨æƒ³åˆ†æçš„æ¨™çš„ï¼ˆä¾‹å¦‚ï¼š2330.TWã€NVDAã€BTC-USDï¼‰ï¼Œç„¶å¾Œé»æ“Š <span class='salmon-text'>ã€ğŸ“Š åŸ·è¡ŒAIåˆ†æã€</span> æŒ‰éˆ•é–‹å§‹ã€‚</p>
    """, unsafe_allow_html=True)
    st.markdown("---")
    
    col1, col2 = st.columns(2)
    with col1:
        st.subheader("ğŸ“ ä½¿ç”¨æ­¥é©Ÿï¼š")
        st.markdown("""
        1.  **é¸æ“‡è³‡ç”¢é¡åˆ¥**ï¼šåœ¨å·¦å´æ¬„é¸æ“‡ `ç¾è‚¡`ã€`å°è‚¡` æˆ– `åŠ å¯†è²¨å¹£`ã€‚
        2.  **é¸æ“‡æ¨™çš„**ï¼šä½¿ç”¨ä¸‹æ‹‰é¸å–®å¿«é€Ÿé¸æ“‡ç†±é–€æ¨™çš„ï¼Œæˆ–ç›´æ¥åœ¨è¼¸å…¥æ¡†ä¸­éµå…¥ä»£ç¢¼æˆ–åç¨±ã€‚
        3.  **é¸æ“‡é€±æœŸ**ï¼šæ±ºå®šåˆ†æçš„é•·åº¦ï¼ˆä¾‹å¦‚ï¼š`30 åˆ†` (çŸ­æœŸ)ã€`1 æ—¥` (ä¸­é•·ç·š)ï¼‰ã€‚
        4.  **åŸ·è¡Œåˆ†æ**ï¼šé»æ“Š <span class='salmon-text'>ã€ğŸ“Š åŸ·è¡ŒAIåˆ†æã€</span>ï¼ŒAIå°‡èåˆåŸºæœ¬é¢èˆ‡æŠ€è¡“é¢æŒ‡æ¨™æä¾›äº¤æ˜“ç­–ç•¥ã€‚
        """, unsafe_allow_html=True)

    with col2:
        st.subheader("âš ï¸ å…è²¬è²æ˜:")
        st.warning("""
        æœ¬åˆ†ææ¨¡å‹åŒ…å«å¤šä½AIçš„é‡åŒ–è§€é»ï¼Œä½†åƒ…ä¾›æ•™è‚²èˆ‡åƒè€ƒç”¨é€”ã€‚æŠ•è³‡æ¶‰åŠé¢¨éšªï¼Œæ‰€æœ‰äº¤æ˜“æ±ºç­–æ‡‰åŸºæ–¼æ‚¨å€‹äººçš„ç¨ç«‹ç ”ç©¶å’Œè²¡å‹™ç‹€æ³ï¼Œä¸¦å»ºè­°è«®è©¢å°ˆæ¥­é‡‘èé¡§å•ã€‚
        """)

    st.markdown("---")
    st.subheader("ğŸ“Š æ•¸æ“šä¾†æº:")
    st.info("Yahoo Finance | æŠ€è¡“æŒ‡æ¨™: TA åº« | APPå„ªåŒ–: å°ˆæ¥­ç¨‹å¼ç¢¼å°ˆå®¶")

