# -*- coding: utf-8 -*-
"""
AI è¶¨å‹¢åˆ†æ Streamlit æ‡‰ç”¨ç¨‹å¼
å°ˆå®¶å¢å¼·æœ€çµ‚ç‰ˆå¯¦ä½œ (V12.5 - Tactical Mode Upgrade)

æœ¬æ‡‰ç”¨ç¨‹å¼æ ¹æ“šä¸€ä»½è©³ç´°çš„é‡‘èåˆ†æå·¥å…·è¨­å®šæ–‡ä»¶é€²è¡Œé–‹ç™¼ï¼Œæ—¨åœ¨æä¾›ä¸€å€‹å¤–è§€ç²¾ç¾ã€
äº’å‹•å°ˆæ¥­çš„æ±ºç­–å„€è¡¨æ¿ã€‚

æ ¸å¿ƒåŠŸèƒ½æ›´æ–°ï¼š
- [UI/UX å„ªåŒ–] **æˆ°è¡“æƒææ¨¡å¼ (O.C.T.S.)** å‡ç´šï¼šå°‡ã€Œå›æº¯Kç·šæ•¸ã€çš„æ•¸å€¼è¼¸å…¥æ›¿æ›ç‚º
  æ›´ç›´è§€çš„ã€ŒçŸ­æœŸéˆæ•ã€ã€ã€Œä¸­æœŸå¹³è¡¡ã€ã€ã€Œé•·æœŸç©©å®šã€æ¨¡å¼é¸æ“‡ï¼Œä¸¦æä¾›æ˜ç¢ºçš„éˆæ•åº¦/ç©©å®šæ€§èªªæ˜ã€‚
- [é‚è¼¯å„ªåŒ–] ä¿®å¾©å¤šé€±æœŸè¶¨å‹¢ç¢ºèªåˆ†æ•¸çš„åˆ¤æ–·æ¢ä»¶ (å¾ >= 1.5 æ”¹ç‚º == 2)ã€‚
- [è¦–è¦ºå„ªåŒ–] å¯¦ä½œ MACD æŸ±ç‹€åœ–çš„åŠ é€Ÿ/æ¸›é€Ÿ (Acc/Dec) é¡è‰²é‚è¼¯ï¼Œæä¾›æ›´å°ˆæ¥­çš„è¶¨å‹¢å¼·å¼±åˆ¤æ–·ã€‚

é–‹ç™¼è€…ï¼šç¨‹å¼ç¢¼å°ˆå®¶ (Generated by Gemini)
ç‰ˆæœ¬ï¼š12.5.0 (Tactical Mode Upgrade)
"""

# è¼‰å…¥æ ¸å¿ƒå¥—ä»¶
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import ta
import warnings
import time
import re 
from datetime import datetime, timedelta
# æ–°å¢ scipy ä¾è³´ï¼Œç¢ºä¿ç©©å®šæ€§
try:
    from scipy.stats import linregress
except ImportError:
    st.error("éŒ¯èª¤: ç¼ºå°‘å¿…è¦çš„ 'scipy' å¥—ä»¶ã€‚è«‹åŸ·è¡Œ 'pip install scipy' å®‰è£ã€‚")
    st.stop()

warnings.filterwarnings('ignore')

# ==============================================================================
# 1. é é¢é…ç½®èˆ‡å…¨å±€è¨­å®š
# ==============================================================================

st.set_page_config(
    page_title="AIè¶¨å‹¢åˆ†æ V12.5", 
    page_icon="ğŸ“ˆ", 
    layout="wide"
)

# é€±æœŸæ˜ å°„ï¼š(YFinance Period, YFinance Interval)
PERIOD_MAP = { 
    "30 åˆ†": ("60d", "30m"), 
    "4 å°æ™‚": ("1y", "60m"), 
    "1 æ—¥": ("5y", "1d"), 
    "1 é€±": ("max", "1wk")
}

# ğŸš€ æ‚¨çš„ã€æ‰€æœ‰è³‡ç”¢æ¸…å–®ã€‘ (ç°¡åŒ–ï¼Œåƒ…ç‚ºç¯„ä¾‹)
FULL_SYMBOLS_MAP = {
    # ----------------------------------------------------
    # A. ç¾è‚¡æ ¸å¿ƒ (US Stocks) - å€‹è‚¡
    # ----------------------------------------------------
    "TSLA": {"name": "ç‰¹æ–¯æ‹‰", "keywords": ["ç‰¹æ–¯æ‹‰", "é›»å‹•è»Š", "TSLA", "Tesla"]},
    "NVDA": {"name": "è¼é”", "keywords": ["è¼é”", "è‹±å‰é”", "AI", "NVDA", "Nvidia"]},
    "AAPL": {"name": "è˜‹æœ", "keywords": ["è˜‹æœ", "æ‰‹æ©Ÿ", "AAPL", "Apple"]},
    # ----------------------------------------------------
    # B. å°è‚¡æ ¸å¿ƒ (TW Stocks) - å€‹è‚¡
    # ----------------------------------------------------
    "2330.TW": {"name": "å°ç©é›»", "keywords": ["å°ç©é›»", "æ™¶åœ“", "2330", "TSMC"]},
    "2454.TW": {"name": "è¯ç™¼ç§‘", "keywords": ["è¯ç™¼ç§‘", "MTK", "2454"]},
    # ----------------------------------------------------
    # C. åŠ å¯†è²¨å¹£ (Crypto)
    # ----------------------------------------------------
    "BTC-USD": {"name": "æ¯”ç‰¹å¹£/USD", "keywords": ["æ¯”ç‰¹å¹£", "BTC", "Bitcoin"]},
    "ETH-USD": {"name": "ä»¥å¤ªå¹£/USD", "keywords": ["ä»¥å¤ªå¹£", "ETH", "Ethereum"]},
}


# ==============================================================================
# 2. æ•¸æ“šç²å–èˆ‡è™•ç†
# ==============================================================================

@st.cache_data(ttl=3600, show_spinner="ğŸš€ æ­£åœ¨å¾ Yahoo Finance ç²å–æ•¸æ“š...")
def get_historical_data(symbol, period, interval):
    """
    å¾ yfinance ç²å–æ­·å²æ•¸æ“šã€‚
    """
    try:
        data = yf.download(symbol, period=period, interval=interval, progress=False)
        if data.empty or len(data) < 10:
            return pd.DataFrame(), f"éŒ¯èª¤ï¼šç„¡æ³•ç²å– {symbol} çš„æ•¸æ“šï¼Œæˆ–æ•¸æ“šé‡ä¸è¶³ (åƒ…æœ‰ {len(data)} æ ¹Kç·š)ã€‚"
        
        # æ•¸æ“šé©—è­‰é–€æª»æé«˜ï¼šè‡³å°‘éœ€è¦ 50 æ ¹Kç·šæ‰èƒ½é€²è¡Œæœ‰æ•ˆçš„æŠ€è¡“åˆ†æ
        if len(data) < 50:
             return pd.DataFrame(), f"æ•¸æ“šé‡ä¸è¶³ï¼šéœ€è¦è‡³å°‘ 50 æ ¹Kç·šé€²è¡Œæœ‰æ•ˆåˆ†æï¼Œç›®å‰åƒ…æœ‰ {len(data)} æ ¹ã€‚"

        # ç¢ºä¿åˆ—åè¦ç¯„åŒ– (å¤§å¯«)
        data.columns = [col.capitalize() for col in data.columns]
        data.index.name = 'Date'
        return data, None
    except Exception as e:
        return pd.DataFrame(), f"æ•¸æ“šç²å–ç•°å¸¸: {e}"

def calculate_indicators(df, lookback_candles):
    """
    è¨ˆç®—ä¸€ç³»åˆ—æŠ€è¡“æŒ‡æ¨™ï¼Œä¸¦æ ¹æ“š lookback_candles è£åˆ‡æ•¸æ“šã€‚
    """
    if df.empty:
        return df

    # 1. è¶¨å‹¢æŒ‡æ¨™
    df['SMA_20'] = df['Close'].rolling(window=20).mean()
    df['EMA_50'] = df['Close'].ewm(span=50, adjust=False).mean()
    
    # MACD è¨ˆç®—
    df['MACD_Line'] = ta.trend.macd(df['Close'], window_fast=9, window_slow=16, window_sign=5)
    df['MACD_Signal'] = ta.trend.macd_signal(df['Close'], window_fast=9, window_slow=16, window_sign=5)
    df['MACD_Hist'] = ta.trend.macd_diff(df['Close'], window_fast=9, window_slow=16, window_sign=5)
    
    # è¦–è¦ºå„ªåŒ–: MACD æŸ±ç‹€åœ–åŠ é€Ÿ/æ¸›é€Ÿåˆ¤å®š (Acc/Dec)
    df['MACD_Hist_Prev'] = df['MACD_Hist'].shift(1)
    
    # MACD_Color: 1=å¤šé ­åŠ é€Ÿ(æ·±ç¶ )ã€2=å¤šé ­æ¸›é€Ÿ(æ·ºç¶ )ã€3=ç©ºé ­åŠ é€Ÿ(æ·±ç´…)ã€4=ç©ºé ­æ¸›é€Ÿ(æ·ºç´…)
    def determine_macd_color(row):
        if row['MACD_Hist'] > 0:
            if row['MACD_Hist'] > row['MACD_Hist_Prev']:
                return 'DeepGreen' # å¤šé ­åŠ é€Ÿ: æŸ±å­è®Šé•·
            else:
                return 'LightGreen' # å¤šé ­æ¸›é€Ÿ: æŸ±å­è®ŠçŸ­æˆ–æŒå¹³
        else:
            if row['MACD_Hist'] < 0: # ç¢ºä¿ MACD_Hist < 0
                if row['MACD_Hist'] < row['MACD_Hist_Prev']:
                    return 'DeepRed' # ç©ºé ­åŠ é€Ÿ: è² å‘æŸ±å­è®Šé•· (å€¼æ›´å°)
                else:
                    return 'LightRed' # ç©ºé ­æ¸›é€Ÿ: è² å‘æŸ±å­è®ŠçŸ­æˆ–æŒå¹³ (å€¼æ›´å¤§)
            else: # MACD_Hist æ¥è¿‘ 0 ä¸” MACD_Hist_Prev å·²ç¶“è¨ˆç®—ï¼Œé€™å€‹åˆ†æ”¯ç†è«–ä¸Šä¸æ‡‰è©²åŸ·è¡Œï¼Œä½†ä½œç‚ºä¿è­·
                return 'LightGreen' if row['MACD_Hist_Prev'] > 0 else 'LightRed'

    
    df['MACD_Color'] = df.apply(determine_macd_color, axis=1)


    df['ADX_9'] = ta.trend.adx(df['High'], df['Low'], df['Close'], window=9)
    df['ADX_pos'] = ta.trend.adx_pos(df['High'], df['Low'], df['Close'], window=9)
    df['ADX_neg'] = ta.trend.adx_neg(df['High'], df['Low'], df['Close'], window=9)

    # 2. å‹•é‡æŒ‡æ¨™
    df['RSI'] = ta.momentum.rsi(df['Close'], window=14)
    df['Stoch_%K'] = ta.momentum.stoch(df['High'], df['Low'], df['Close'], window=14, smooth_window=3)
    df['Stoch_%D'] = ta.momentum.stoch_signal(df['High'], df['Low'], df['Close'], window=14, smooth_window=3)

    # 3. æˆäº¤é‡æŒ‡æ¨™
    df['CMF'] = ta.volume.money_flow_index(df['High'], df['Low'], df['Close'], df['Volume'], window=20, fillna=False)
    
    # 4. æ³¢å‹•æ€§æŒ‡æ¨™ (å¸ƒæ—å¸¶)
    bb = ta.volatility.BollingerBands(close=df['Close'], window=20, window_dev=2)
    df['BB_High'] = bb.bollinger_hband()
    df['BB_Low'] = bb.bollinger_lband()
    df['BB_Mid'] = bb.bollinger_mavg()
    
    # 5. æ–æ³¢é‚£å¥‘å›æ¸¬ (å‹•æ…‹æ­¢ç›ˆæ­¢ææ¨¡å‹)
    # ä½¿ç”¨æœ€å¾Œ lookback_candles å…§çš„æœ€é«˜å’Œæœ€ä½åƒ¹
    recent_df = df.iloc[-lookback_candles:] 
    high_250 = recent_df['High'].max()
    low_250 = recent_df['Low'].min()
    diff = high_250 - low_250
    df['FIB_R3'] = high_250 - 0.236 * diff
    df['FIB_R2'] = high_250 - 0.382 * diff
    df['FIB_R1'] = high_250 - 0.500 * diff
    df['FIB_S1'] = low_250 + 0.500 * diff
    df['FIB_S2'] = low_250 + 0.382 * diff
    df['FIB_S3'] = low_250 + 0.236 * diff


    # 6. è£åˆ‡æ•¸æ“š: åªä¿ç•™ lookback_candles æ•¸é‡çš„æ•¸æ“š
    df = df.iloc[-lookback_candles:]
    df = df.dropna()

    return df

def get_multi_timeframe_trend(df_daily, df_weekly):
    """
    å¤šé€±æœŸè¶¨å‹¢ç¢ºèªï¼šæª¢æŸ¥æ—¥ç·šå’Œé€±ç·šè¶¨å‹¢ã€‚
    """
    if df_daily.empty or df_weekly.empty:
        return "æ•¸æ“šä¸è¶³", 0

    # 1. æ—¥ç·šè¶¨å‹¢ (Daily Trend)
    # ä½¿ç”¨æœ€å¾Œä¸€æ ¹æ—¥Kç·šçš„ MACD æŸ±ç‹€åœ–å’Œ ADX å¼·åº¦
    daily_macd_hist = df_daily['MACD_Hist'].iloc[-1]
    daily_adx = df_daily['ADX_9'].iloc[-1]
    
    # è¶¨å‹¢å¼·åº¦åˆ¤å®š
    daily_strength = "å¼·" if daily_adx > 35 else ("ä¸­" if daily_adx > 25 else "å¼±")

    if daily_macd_hist > 0:
        daily_trend = f"æ—¥ç·šï¼š{daily_strength}å‹¢ä¸Šæ¼²"
        daily_score = 1
    elif daily_macd_hist < 0:
        daily_trend = f"æ—¥ç·šï¼š{daily_strength}å‹¢ä¸‹è·Œ"
        daily_score = -1
    else:
        daily_trend = "æ—¥ç·šï¼šç›¤æ•´"
        daily_score = 0

    # 2. é€±ç·šè¶¨å‹¢ (Weekly Trend)
    # ä½¿ç”¨æœ€å¾Œä¸€æ ¹é€±Kç·šçš„ MACD æŸ±ç‹€åœ–
    weekly_macd_hist = df_weekly['MACD_Hist'].iloc[-1]

    if weekly_macd_hist > 0:
        weekly_trend = "é€±ç·šï¼šå¤šé ­æ’åˆ—"
        weekly_score = 1
    elif weekly_macd_hist < 0:
        weekly_trend = "é€±ç·šï¼šç©ºé ­æ’åˆ—"
        weekly_score = -1
    else:
        weekly_trend = "é€±ç·šï¼šç›¤æ•´"
        weekly_score = 0

    # 3. ç¶œåˆå¾—åˆ† (Composite Score)
    total_score = daily_score + weekly_score
    
    # 4. è¶¨å‹¢ç¢ºèªçµæœ
    if total_score == 2:
        confirmation = "<span style='color: #28a745; font-weight: bold;'>ğŸŸ¢ å¼·çƒˆå¤šé ­ç¢ºèª (é›™é‡è¶¨å‹¢å‘ä¸Š)</span>"
    elif total_score == -2:
        confirmation = "<span style='color: #dc3545; font-weight: bold;'>ğŸ”´ å¼·çƒˆç©ºé ­ç¢ºèª (é›™é‡è¶¨å‹¢å‘ä¸‹)</span>"
    elif total_score == 1:
        confirmation = "<span style='color: #ffc107;'>ğŸŸ¡ æ½›åœ¨å¤šé ­ (æ—¥ç·šå¼·æ–¼é€±ç·š)</span>"
    elif total_score == -1:
        confirmation = "<span style='color: #ffc107;'>ğŸŸ¡ æ½›åœ¨ç©ºé ­ (é€±ç·šå¼·æ–¼æ—¥ç·š)</span>"
    else:
        confirmation = "âšª è¶¨å‹¢ä¸æ˜æˆ–ç›¤æ•´"
        
    summary = f"{confirmation}<br><small>{daily_trend}, {weekly_trend}</small>"
    
    return summary, total_score


def generate_ai_analysis(df, symbol_name, total_score):
    """
    æ ¹æ“šæŠ€è¡“æŒ‡æ¨™å’Œå¤šé€±æœŸç¢ºèªçµæœç”Ÿæˆ AI äº¤æ˜“ç­–ç•¥ã€‚
    """
    if df.empty:
        return "æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•ç”Ÿæˆåˆ†æã€‚", "ä¸­æ€§"

    last_close = df['Close'].iloc[-1]
    
    # --- æŒ‡æ¨™ç‹€æ…‹åˆ¤å®š ---
    macd_status = "å¤šé ­" if df['MACD_Hist'].iloc[-1] > 0 else "ç©ºé ­"
    rsi_status = "è¶…è²·" if df['RSI'].iloc[-1] > 80 else ("è¶…è³£" if df['RSI'].iloc[-1] < 20 else "ä¸­æ€§")
    stoch_status = "è¶…è²·" if df['Stoch_%K'].iloc[-1] > 80 else ("è¶…è³£" if df['Stoch_%K'].iloc[-1] < 20 else "ä¸­æ€§")
    adx_status = "å¼·å‹¢" if df['ADX_9'].iloc[-1] > 25 else "å¼±å‹¢/ç›¤æ•´"
    cmf_status = "è³‡é‡‘æµå…¥" if df['CMF'].iloc[-1] > 0 else "è³‡é‡‘æµå‡º"
    
    # å¸ƒæ—å¸¶çªç ´åˆ¤å®š
    bb_breakout = ""
    if last_close > df['BB_High'].iloc[-1]:
        bb_breakout = "çªç ´ä¸Šè»Œ (å¼·å‹¢)"
    elif last_close < df['BB_Low'].iloc[-1]:
        bb_breakout = "è·Œç ´ä¸‹è»Œ (å¼±å‹¢)"

    # --- ç¶œåˆç­–ç•¥ç”Ÿæˆ ---
    if total_score == 2: # å¼·çƒˆå¤šé ­ç¢ºèª
        action = "ğŸŸ¢ å¼·çƒˆè²·å…¥ (Strong Buy)"
        reason = f"å¤šé€±æœŸå¼·çƒˆå¤šé ­ç¢ºèª (æ—¥ç·š/é€±ç·šå‡ç‚ºå¤šé ­)ã€‚MACD (9, 16, 5) æŸ±ç‹€ç·šæŒçºŒç‚ºæ­£ ({macd_status})ï¼ŒADX é¡¯ç¤ºå¼·å‹¢è¶¨å‹¢ ({adx_status})ã€‚ç•¶å‰åƒ¹æ ¼ {last_close:.2f} è™•æ–¼ä¸Šå‡é€šé“ï¼Œä¸”è³‡é‡‘æµå‘ ({cmf_status}) åå‘æ­£é¢ã€‚"
        risk_level = "ä¸­é«˜"
    elif total_score == -2: # å¼·çƒˆç©ºé ­ç¢ºèª
        action = "ğŸ”´ å¼·çƒˆè³£å‡º (Strong Sell)"
        reason = f"å¤šé€±æœŸå¼·çƒˆç©ºé ­ç¢ºèª (æ—¥ç·š/é€±ç·šå‡ç‚ºç©ºé ­)ã€‚MACD æŸ±ç‹€ç·šæŒçºŒç‚ºè²  ({macd_status})ï¼ŒADX é¡¯ç¤ºè¶¨å‹¢å¼·å‹ ({adx_status})ã€‚ç•¶å‰åƒ¹æ ¼ {last_close:.2f} è™•æ–¼ä¸‹é™é€šé“ï¼Œéœ€è­¦æƒ•è³‡é‡‘æµå‡º ({cmf_status})ã€‚"
        risk_level = "ä¸­é«˜"
    elif rsi_status == "è¶…è²·" and stoch_status == "è¶…è²·" and total_score > -2:
        action = "ğŸŸ¡ æ½›åœ¨è³£å‡º (Potential Sell)"
        reason = f"RSI ({df['RSI'].iloc[-1]:.2f}) å’Œ Stochastics ({df['Stoch_%K'].iloc[-1]:.2f}) åŒæ™‚é€²å…¥è¶…è²·å€ï¼Œé¡¯ç¤ºçŸ­æœŸå›èª¿é¢¨éšªå¢åŠ ã€‚MACD é›–ç‚º {macd_status}ï¼Œä½†å¤šé€±æœŸç¢ºèªä¸å¼·ï¼Œå»ºè­°è§€æœ›æˆ–è€ƒæ…®éƒ¨åˆ†ç²åˆ©äº†çµã€‚"
        risk_level = "é«˜"
    elif rsi_status == "è¶…è³£" and stoch_status == "è¶…è³£" and total_score < 2:
        action = "ğŸŸ¢ æ½›åœ¨è²·å…¥ (Potential Buy)"
        reason = f"RSI ({df['RSI'].iloc[-1]:.2f}) å’Œ Stochastics ({df['Stoch_%K'].iloc[-1]:.2f}) åŒæ™‚é€²å…¥è¶…è³£å€ï¼Œé¡¯ç¤ºçŸ­æœŸåå½ˆæ©Ÿæœƒã€‚MACD é›–ç‚º {macd_status}ï¼Œä½†å¤šé€±æœŸç¢ºèªä¸å¼·ï¼Œå»ºè­°è¼•å€‰ä»‹å…¥æˆ–ç­‰å¾…æ›´æ˜ç¢ºçš„åº•éƒ¨è¨Šè™Ÿã€‚"
        risk_level = "é«˜"
    else:
        action = "âšª ä¸­æ€§è§€æœ› (Neutral)"
        reason = f"æŒ‡æ¨™æ··é›œæˆ–è™•æ–¼ç›¤æ•´å€é–“ã€‚MACD ç‚º {macd_status}ï¼ŒRSI ä½æ–¼ä¸­æ€§å€ ({rsi_status})ã€‚ADX ({adx_status}) é¡¯ç¤ºè¶¨å‹¢å¯èƒ½ä¸å¤ å¼·å‹ã€‚å»ºè­°ç­‰å¾…æ˜ç¢ºçš„å¤šé€±æœŸç¢ºèªè¨Šè™Ÿæˆ–é—œéµæ”¯æ’å£“åŠ›ä½çªç ´ ({bb_breakout if bb_breakout else 'ç„¡çªç ´'})ã€‚"
        risk_level = "ä¸­"

    # --- å‹•æ…‹æ­¢ç›ˆæ­¢æå»ºè­° (åŸºæ–¼æ–æ³¢é‚£å¥‘) ---
    fib_res = df['FIB_R3'].iloc[-1] # æœ€å¼·é˜»åŠ›
    fib_sup = df['FIB_S3'].iloc[-1] # æœ€å¼·æ”¯æ’
    
    stop_loss = df['FIB_S2'].iloc[-1] if total_score >= 0 else df['FIB_R2'].iloc[-1]
    take_profit = df['FIB_R2'].iloc[-1] if total_score >= 0 else df['FIB_S2'].iloc[-1]
    
    # ç¢ºä¿æ­¢ç›ˆæ­¢æä¸æœƒå¤ªæ¥è¿‘ç•¶å‰åƒ¹æ ¼ï¼Œå¦‚æœæ¥è¿‘ï¼Œä½¿ç”¨è¼ƒé çš„FIB R3/S3ä½œç‚ºåƒè€ƒ (ç°¡å–®é‚è¼¯ä¿è­·)
    if abs(take_profit - last_close) < 0.05 * last_close: # å¦‚æœå·®è·å°æ–¼5%
        take_profit = fib_res if total_score >= 0 else fib_sup
    if abs(stop_loss - last_close) < 0.05 * last_close: # å¦‚æœå·®è·å°æ–¼5%
        stop_loss = fib_sup if total_score >= 0 else fib_res

    
    # æ ¼å¼åŒ–è¼¸å‡º
    analysis_text = f"""
    <div style='border: 2px solid #3498db; border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #f0f8ff;'>
        <h4 style='color: #2c3e50;'>âœ¨ {symbol_name} AI å°ˆå®¶ç¸½çµèˆ‡è¡Œå‹•å»ºè­°</h4>
        <p><strong>æœ€æ–°æ”¶ç›¤åƒ¹ï¼š</strong> <span style='color: #1abc9c; font-weight: bold;'>{last_close:.2f}</span></p>
        <p><strong>å»ºè­°è¡Œå‹•ï¼š</strong> {action}</p>
        <p><strong>ä¸»è¦è€ƒé‡ï¼š</strong> {reason}</p>
        <p><strong>ç¶œåˆé¢¨éšªè©•ç´šï¼š</strong> {risk_level}</p>
        <hr style='border-top: 1px dashed #ccc;'>
        <h5 style='color: #2c3e50;'>ğŸ“Œ æ–æ³¢é‚£å¥‘å‹•æ…‹æ­¢ç›ˆæ­¢æ (åŸºæ–¼éå» {df.shape[0]} æ ¹Kç·š)</h5>
        <p>ğŸ‘‰ **æ­¢ç›ˆç›®æ¨™ (Take Profit):** ç´„ <span style='color: #28a745; font-weight: bold;'>{take_profit:.2f}</span> (å‹•æ…‹åƒè€ƒ)</p>
        <p>ğŸ›‘ **æ­¢æç›®æ¨™ (Stop Loss):** ç´„ <span style='color: #dc3545; font-weight: bold;'>{stop_loss:.2f}</span> (å‹•æ…‹åƒè€ƒ)</p>
        <p>ğŸ›¡ï¸ **é—œéµæ”¯æ’ (Support):** FIB S3 ç´„ {fib_sup:.2f}</p>
        <p>âš”ï¸ **é—œéµé˜»åŠ› (Resistance):** FIB R3 ç´„ {fib_res:.2f}</p>
    </div>
    """
    
    return analysis_text, action


# ==============================================================================
# 3. Streamlit UI ä»‹é¢èˆ‡äº¤äº’é‚è¼¯
# ==============================================================================

# åˆå§‹åŒ– Session State
if 'last_search_symbol' not in st.session_state:
    st.session_state['last_search_symbol'] = "2330.TW"
if 'data_ready' not in st.session_state:
    st.session_state['data_ready'] = False
if 'sidebar_search_input' not in st.session_state:
    st.session_state['sidebar_search_input'] = ""


# --- å·¦å´æ¬„ (Sidebar) é…ç½® ---
st.sidebar.title("ğŸ› ï¸ åˆ†æåƒæ•¸è¨­å®š")

# A. è³‡ç”¢é¡åˆ¥èˆ‡æ¨™çš„é¸æ“‡
asset_class = st.sidebar.radio(
    "é¸æ“‡è³‡ç”¢é¡åˆ¥", 
    ["ç¾è‚¡", "å°è‚¡", "åŠ å¯†è²¨å¹£"], 
    index=1
)

# æ ¹æ“šè³‡ç”¢é¡åˆ¥éæ¿¾æ¨™çš„
if asset_class == "ç¾è‚¡":
    filtered_symbols = {k: v for k, v in FULL_SYMBOLS_MAP.items() if k not in ["2330.TW", "2454.TW", "BTC-USD", "ETH-USD"]}
elif asset_class == "å°è‚¡":
    filtered_symbols = {k: v for k, v in FULL_SYMBOLS_MAP.items() if ".TW" in k}
else:
    filtered_symbols = {k: v for k, v in FULL_SYMBOLS_MAP.items() if "-USD" in k}

symbol_list = list(filtered_symbols.keys())
name_list = [f"{v['name']} ({k})" for k, v in filtered_symbols.items()]
combined_list = list(zip(symbol_list, name_list))

# ä¸‹æ‹‰é¸å–®é¸æ“‡
selected_name = st.sidebar.selectbox(
    "å¿«é€Ÿé¸æ“‡ç†±é–€æ¨™çš„",
    name_list,
    index=0
)
# ç²å–å¯¦éš›ä»£ç¢¼
current_symbol = symbol_list[name_list.index(selected_name)]

# å…è¨±è‡ªè¨‚è¼¸å…¥ (ä½¿ç”¨è€…å¯è¼¸å…¥ä»»ä½•ä»£ç¢¼)
st.session_state['sidebar_search_input'] = st.sidebar.text_input(
    "æˆ–è¼¸å…¥è‡ªè¨‚ä»£ç¢¼ (e.g., AAPL, 0050.TW)",
    value=current_symbol,
    key='symbol_input'
)

# æœ€çµ‚ç¢ºèªè¦ä½¿ç”¨çš„ä»£ç¢¼
if st.session_state.symbol_input:
    final_symbol = st.session_state.symbol_input.upper()
else:
    final_symbol = current_symbol
    
symbol_display_name = FULL_SYMBOLS_MAP.get(final_symbol, {}).get("name", final_symbol)


# B. é€±æœŸèˆ‡å›æ¸¬è¨­å®š
st.sidebar.markdown("---")
st.sidebar.subheader("â³ é€±æœŸèˆ‡å›æ¸¬")

timeframe_option = st.sidebar.selectbox(
    "ğŸ“Š Kç·šé€±æœŸ (Interval)",
    list(PERIOD_MAP.keys()),
    index=2 # é è¨­ç‚º '1 æ—¥'
)

# ==============================================================================
# --- ğŸ’¡ æˆ°è¡“æƒææ¨¡å¼å„ªåŒ–å€ (O.C.T.S.) ---
# ==============================================================================
st.sidebar.markdown("---")
st.sidebar.subheader("ğŸ“¡ æˆ°è¡“æƒææ¨¡å¼ (O.C.T.S.)")

# 1. é è¨­æ¨¡å¼é¸æ“‡ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡æƒ…å¢ƒè€Œéæ•¸å­—
preset_key = st.sidebar.selectbox(
    "é¸æ“‡æƒææ¨¡å¼ (Mode)",
    [
        "è‡ªå‹•é©æ‡‰ (Auto-Adaptive, æ¨è–¦)", 
        "æˆ°è¡“çªæ“Š (Tactical Rush, çŸ­æœŸéˆæ•)", 
        "å€åŸŸå·¡èˆª (Sector Patrol, ä¸­æœŸå¹³è¡¡)", 
        "è»Œé“éƒ¨ç½² (Orbital Deploy, é•·æœŸç©©å®š)", 
        "è‡ªè¨‚ Kç·šæ•¸ (Expert Mode)"
    ],
    index=0,
    key='lookback_preset'
)

st.sidebar.markdown("""
<small style='color: #95a5a6;'>
<strong>æ¨¡å¼èªªæ˜:</strong> æ±ºå®š AI æ¨¡å‹å›æº¯å¤šå°‘æ ¹Kç·šé€²è¡Œåˆ†æã€‚
<br>Kç·šæ•¸è¶Šå°‘ â†’ <span style='color: #2ecc71; font-weight: bold;'>éˆæ•åº¦é«˜</span> (æŠ“çŸ­æœŸæ©Ÿæœƒ)
<br>Kç·šæ•¸è¶Šå¤š â†’ <span style='color: #3498db; font-weight: bold;'>ç©©å®šæ€§é«˜</span> (æŠ“é•·æœŸè¶¨å‹¢)
</small>
""", unsafe_allow_html=True)


# 2. è™•ç†é è¨­èˆ‡è‡ªè¨‚é‚è¼¯
default_candle_count = 250 # å®‰å…¨çš„é è¨­å€¼
lookback_candles = 250 # é è¨­å€¼

if preset_key == "è‡ªå‹•é©æ‡‰ (Auto-Adaptive, æ¨è–¦)":
    # æ ¹æ“šé¸å®šçš„Kç·šé€±æœŸï¼Œè¨­ç½®ä¸€å€‹åˆç†çš„é è¨­Kç·šæ•¸
    if timeframe_option in ["30 åˆ†", "4 å°æ™‚"]:
        lookback_candles = 80 # çŸ­ç·šåå‘éˆæ•
        lookback_candles_text = "ç´„ 80 æ ¹"
    elif timeframe_option == "1 æ—¥":
        lookback_candles = 150 # ä¸­æœŸå¹³è¡¡
        lookback_candles_text = "ç´„ 150 æ ¹"
    elif timeframe_option == "1 é€±":
        lookback_candles = 250 # é•·æœŸç©©å®š
        lookback_candles_text = "ç´„ 250 æ ¹"
    else:
        lookback_candles = default_candle_count
        lookback_candles_text = f"ç´„ {default_candle_count} æ ¹"
    st.sidebar.info(f"AI å·²é¸æ“‡ **{lookback_candles_text}** Kç·šé€²è¡Œè‡ªå‹•é©æ‡‰åˆ†æã€‚")

elif preset_key == "æˆ°è¡“çªæ“Š (Tactical Rush, çŸ­æœŸéˆæ•)":
    lookback_candles = 60
elif preset_key == "å€åŸŸå·¡èˆª (Sector Patrol, ä¸­æœŸå¹³è¡¡)":
    lookback_candles = 120
elif preset_key == "è»Œé“éƒ¨ç½² (Orbital Deploy, é•·æœŸç©©å®š)":
    lookback_candles = 250
elif preset_key == "è‡ªè¨‚ Kç·šæ•¸ (Expert Mode)":
    # é¡¯ç¤ºåŸå§‹è¼¸å…¥æ¡†
    lookback_candles = st.sidebar.number_input(
        "ğŸ“ **è‡ªè¨‚Kç·šæ•¸ (10-1000)**",
        min_value=10,
        max_value=1000,
        value=default_candle_count,
        step=10,
        key='lookback_custom'
    )
    st.sidebar.warning("è­¦å‘Š: è‡ªè¨‚æ¨¡å¼éœ€è¦å°ˆæ¥­çŸ¥è­˜ï¼Œè«‹è¬¹æ…èª¿æ•´ã€‚")


# ç¢ºä¿ lookback_candles ç‚ºæ•´æ•¸
lookback_candles = int(lookback_candles)
# ==============================================================================
# --- ğŸ’¡ æˆ°è¡“æƒææ¨¡å¼å„ªåŒ–å€çµæŸ ---
# ==============================================================================


# C. åŸ·è¡Œåˆ†ææŒ‰éˆ•
st.sidebar.markdown("---")
analyze_button = st.sidebar.button("ğŸ“Š åŸ·è¡ŒAIåˆ†æ", type="primary")


# --- ä¸»é«”å…§å®¹ (Main Content) ---

# é ‚éƒ¨å„€è¡¨æ¿æ¨™é¡Œ
st.markdown(f"""
    <div style="text-align: center; background-color: #2c3e50; padding: 10px; border-radius: 10px; color: white;">
        <h1 style="margin: 0;">ğŸ“ˆ {symbol_display_name} ({final_symbol}) AI è¶¨å‹¢åˆ†æå„€è¡¨æ¿</h1>
        <p style="margin: 0; font-size: 16px;">V12.5 - {timeframe_option}é€±æœŸåˆ†æï¼Œç•¶å‰æƒææ·±åº¦: {lookback_candles} æ ¹Kç·š</p>
    </div>
""", unsafe_allow_html=True)


if analyze_button or st.session_state.data_ready:
    
    with st.spinner(f"æ­£åœ¨ç‚º {final_symbol} åŸ·è¡Œ {timeframe_option} é€±æœŸAIåˆ†æ..."):
        
        # 1. ç²å–ä¸»è¦é€±æœŸæ•¸æ“š
        period, interval = PERIOD_MAP[timeframe_option]
        df, error = get_historical_data(final_symbol, period, interval)
        
        if error:
            st.error(error)
            st.session_state.data_ready = False
        else:
            # 2. è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ä¸¦è£åˆ‡æ•¸æ“š (ä½¿ç”¨ lookback_candles)
            df = calculate_indicators(df, lookback_candles)
            
            if df.empty:
                 st.error(f"éŒ¯èª¤ï¼šåœ¨è¨ˆç®—æŒ‡æ¨™å¾Œï¼Œå‰©é¤˜çš„æœ‰æ•ˆæ•¸æ“šä¸è¶³ã€‚è«‹å˜—è©¦æ¸›å°‘å›æº¯Kç·šæ•¸æˆ–é¸æ“‡æ›´é•·çš„é€±æœŸã€‚")
                 st.session_state.data_ready = False
            else:
                st.session_state.data_ready = True
                
                # 3. åŸ·è¡Œå¤šé€±æœŸè¶¨å‹¢ç¢ºèª (ç²å–æ—¥ç·šå’Œé€±ç·šæ•¸æ“š)
                df_daily, _ = get_historical_data(final_symbol, "5y", "1d")
                df_weekly, _ = get_historical_data(final_symbol, "max", "1wk")
                
                # è¨ˆç®—å¤šé€±æœŸæŒ‡æ¨™ï¼ˆéœ€é‡æ–°è¨ˆç®— MACD ç­‰ï¼Œä½¿ç”¨æ¨™æº– lookback 250ï¼‰
                if not df_daily.empty:
                    df_daily = calculate_indicators(df_daily, 250) 
                if not df_weekly.empty:
                     df_weekly = calculate_indicators(df_weekly, 250)
                
                multi_trend_summary, total_score = get_multi_timeframe_trend(df_daily, df_weekly)

                # 4. ç”Ÿæˆ AI åˆ†æç¸½çµ
                ai_analysis_text, action_category = generate_ai_analysis(df, symbol_display_name, total_score)
                
                # --- å„€è¡¨æ¿é¡¯ç¤º ---
                
                col1, col2 = st.columns([1, 2])
                
                with col1:
                    st.markdown(ai_analysis_text, unsafe_allow_html=True)
                    
                    st.markdown("---")
                    st.subheader("ğŸŒ å¤šé€±æœŸè¶¨å‹¢ç¢ºèª")
                    st.markdown(multi_trend_summary, unsafe_allow_html=True)
                    
                    st.markdown("---")
                    st.subheader("æ•¸æ“šæ¦‚è¦½")
                    st.dataframe(df.tail(5)[['Open', 'High', 'Low', 'Close', 'Volume', 'RSI', 'MACD_Hist']], use_container_width=True)

                with col2:
                    st.subheader("ğŸ•¯ï¸ Kç·šèˆ‡æ–æ³¢é‚£å¥‘/å¸ƒæ—å¸¶")
                    
                    # å‰µå»º K ç·šåœ–èˆ‡æŒ‡æ¨™å­åœ–
                    fig = make_subplots(rows=4, cols=1, 
                                        shared_xaxes=True, 
                                        vertical_spacing=0.05,
                                        row_heights=[0.5, 0.15, 0.15, 0.2],
                                        subplot_titles=(
                                            f'{symbol_display_name} Kç·šåœ– & è¶¨å‹¢ç·š', 
                                            'MACD (9, 16, 5)', 
                                            'ADX & CMF',
                                            'RSI & Stochastics'
                                        ))

                    # Row 1: Kç·šåœ– (Candlestick)
                    fig.add_trace(go.Candlestick(x=df.index,
                                                open=df['Open'],
                                                high=df['High'],
                                                low=df['Low'],
                                                close=df['Close'],
                                                name='Kç·š'), row=1, col=1)
                    
                    # Row 1: æ–æ³¢é‚£å¥‘æ”¯æ’èˆ‡é˜»åŠ›ç·š
                    fig.add_trace(go.Scatter(x=df.index, y=df['FIB_R3'], name='FIB R3 (é˜»åŠ›)', line=dict(color='red', dash='dot')), row=1, col=1)
                    fig.add_trace(go.Scatter(x=df.index, y=df['FIB_S3'], name='FIB S3 (æ”¯æ’)', line=dict(color='green', dash='dot')), row=1, col=1)
                    
                    # Row 1: å¸ƒæ—å¸¶
                    fig.add_trace(go.Scatter(x=df.index, y=df['BB_High'], name='BB High', line=dict(color='orange', width=1)), row=1, col=1)
                    fig.add_trace(go.Scatter(x=df.index, y=df['BB_Low'], name='BB Low', line=dict(color='purple', width=1)), row=1, col=1)
                    fig.add_trace(go.Scatter(x=df.index, y=df['BB_Mid'], name='BB Mid', line=dict(color='grey', width=1, dash='dash')), row=1, col=1)

                    # Row 2: MACD (æ‡‰ç”¨åŠ é€Ÿ/æ¸›é€Ÿé¡è‰²é‚è¼¯)
                    # å®šç¾©å››ç¨®é¡è‰²ï¼šæ·±ç¶ (åŠ é€Ÿå¤šé ­)ã€æ·ºç¶ (æ¸›é€Ÿå¤šé ­)ã€æ·±ç´…(åŠ é€Ÿç©ºé ­)ã€æ·ºç´…(æ¸›é€Ÿç©ºé ­)
                    macd_color_map = {
                        'DeepGreen': '#1e7b3a', 
                        'LightGreen': '#63b379',
                        'DeepRed': '#b32431',  
                        'LightRed': '#e6737c'
                    }
                    
                    # ä½¿ç”¨ df['MACD_Color'] æ˜ å°„é¡è‰²
                    bar_colors = [macd_color_map.get(c, 'white') for c in df['MACD_Color']]
                    
                    fig.add_trace(go.Bar(x=df.index, y=df['MACD_Hist'], name='MACD Hist', marker_color=bar_colors), row=2, col=1)
                    fig.add_trace(go.Scatter(x=df.index, y=df['MACD_Line'], name='MACD Line', line=dict(color='#007bff')), row=2, col=1)
                    fig.add_trace(go.Scatter(x=df.index, y=df['MACD_Signal'], name='Signal Line', line=dict(color='#ffc107')), row=2, col=1)
                    fig.add_hline(y=0, line_width=1, line_dash="dash", line_color="grey", row=2, col=1)

                    # Row 3: ADX & CMF
                    fig.add_trace(go.Scatter(x=df.index, y=df['ADX_9'], name='ADX', line=dict(color='brown')), row=3, col=1)
                    fig.add_hline(y=25, line_width=1, line_dash="dash", line_color="grey", row=3, col=1) # 25ç‚ºè¶¨å‹¢å¼·å¼±åˆ†ç•Œç·š
                    fig.add_trace(go.Bar(x=df.index, y=df['CMF'], name='CMF', marker_color=np.where(df['CMF'] > 0, '#28a745', '#dc3545')), row=3, col=1)
                    fig.add_hline(y=0, line_width=1, line_dash="dash", line_color="grey", row=3, col=1)

                    # Row 4: RSI & Stochastics
                    fig.add_trace(go.Scatter(x=df.index, y=df['Stoch_%K'], name='Stoch %K', line=dict(color='cyan')), row=4, col=1)
                    fig.add_trace(go.Scatter(x=df.index, y=df['RSI'], name='RSI', line=dict(color='blue')), row=4, col=1)
                    fig.add_hrect(y0=80, y1=100, line_width=0, fillcolor="red", opacity=0.2, row=4, col=1); # è¶…è²·å€
                    fig.add_hrect(y0=0, y1=20, line_width=0, fillcolor="green", opacity=0.2, row=4, col=1) # è¶…è³£å€
                    fig.add_hline(y=50, line_width=1, line_dash="dash", line_color="grey", row=4, col=1) # ä¸­ç·š

                    # æ›´æ–°ä½ˆå±€
                    fig.update_layout(
                        height=1000, 
                        xaxis_rangeslider_visible=False,
                        template="plotly_dark", # ä½¿ç”¨æš—è‰²ä¸»é¡Œ
                        title_x=0.5,
                        hovermode="x unified"
                    )
                    
                    fig.update_xaxes(showgrid=True, gridwidth=1, gridcolor='rgba(255,255,255,0.1)')
                    fig.update_yaxes(showgrid=True, gridwidth=1, gridcolor='rgba(255,255,255,0.1)')

                    st.plotly_chart(fig, use_container_width=True)

                st.success(f"âœ… {symbol_display_name} çš„AIåˆ†æå·²å®Œæˆï¼ç‰ˆæœ¬ V12.5")

else:
    # åˆå§‹æ­¡è¿ç•«é¢
    st.markdown("""
        <div style="padding: 20px; text-align: center; background-color: #ecf0f1; border-radius: 10px; color: #34495e;">
            <h2>æ­¡è¿ä½¿ç”¨ AI è¶¨å‹¢åˆ†æå„€è¡¨æ¿ V12.5</h2>
            <p>æœ¬å·¥å…·é›†æˆäº†å¤šé€±æœŸç¢ºèªã€æ–æ³¢é‚£å¥‘å‹•æ…‹æ¨¡å‹åŠå¤šé …æ ¸å¿ƒæŠ€è¡“æŒ‡æ¨™ã€‚</p>
            <p>è«‹åœ¨å·¦å´æ¬„è¨­å®šæ‚¨çš„ <span style='color: #2c3e50; font-weight: bold;'>æ¨™çš„</span>ã€<span style='color: #2c3e50; font-weight: bold;'>Kç·šé€±æœŸ</span> åŠ <span style='color: #2c3e50; font-weight: bold;'>æˆ°è¡“æƒææ¨¡å¼</span>ï¼Œç„¶å¾Œé»æ“Š <span style='color: #3498db; font-weight: bold;'>ã€ğŸ“Š åŸ·è¡ŒAIåˆ†æã€</span> æŒ‰éˆ•é–‹å§‹ã€‚</p>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("---")
    
    st.subheader("ğŸ“ ä½¿ç”¨æ­¥é©Ÿï¼š")
    st.markdown("1. **é¸æ“‡è³‡ç”¢é¡åˆ¥**ï¼šåœ¨å·¦å´æ¬„é¸æ“‡ `ç¾è‚¡`ã€`å°è‚¡` æˆ– `åŠ å¯†è²¨å¹£`ã€‚")
    st.markdown("2. **é¸æ“‡æ¨™çš„**ï¼šä½¿ç”¨ä¸‹æ‹‰é¸å–®å¿«é€Ÿé¸æ“‡ç†±é–€æ¨™çš„ï¼Œæˆ–ç›´æ¥åœ¨è¼¸å…¥æ¡†ä¸­éµå…¥ä»£ç¢¼æˆ–åç¨±ã€‚")
    st.markdown("3. **é¸æ“‡é€±æœŸ**ï¼šæ±ºå®šåˆ†æçš„é•·åº¦ï¼ˆä¾‹å¦‚ï¼š`30 åˆ†`ã€`1 æ—¥`ã€`1 å‘¨`ï¼‰ã€‚")
    st.markdown("4. **é¸æ“‡æˆ°è¡“æƒææ¨¡å¼**ï¼šæ ¹æ“šæ‚¨çš„äº¤æ˜“ç›®æ¨™ï¼ˆçŸ­æœŸã€ä¸­æœŸã€é•·æœŸï¼‰é¸æ“‡æ¨¡å¼ï¼Œ<span style='color: #3498db; font-weight: bold;'>é¿å…ç›´æ¥è¼¸å…¥Kç·šæ•¸</span>ã€‚", unsafe_allow_html=True)
    st.markdown(f"5. **åŸ·è¡Œåˆ†æ**ï¼šé»æ“Š <span style='color: #3498db; font-weight: bold;'>ã€ğŸ“Š åŸ·è¡ŒAIåˆ†æã€**</span>ï¼ŒAIå°‡èåˆå¤šç¶­åº¦æŒ‡æ¨™æä¾›äº¤æ˜“ç­–ç•¥ã€‚", unsafe_allow_html=True)
    
    st.markdown("---")


# ==============================================================================
# 4. é‹è¡Œä¸»é‚è¼¯
# ==============================================================================
# ä¸éœ€è¦ __main__ å€å¡Šï¼ŒStreamlit æœƒè‡ªå‹•é‹è¡Œ
# if __name__ == '__main__':
#     pass
