# -*- coding: utf-8 -*-
"""
AI è¶¨å‹¢åˆ†æ Streamlit æ‡‰ç”¨ç¨‹å¼
å°ˆå®¶å¢å¼·æœ€çµ‚ç‰ˆå¯¦ä½œ (V4.3 - UI å„ªåŒ–èˆ‡ç©©å®šæ€§ä¿®å¾©)

ä¿®å¾©é‡é»ï¼š
- [ç©©å®šæ€§ä¿®å¾©] è§£æ±ºæŠ€è¡“æŒ‡æ¨™è¨ˆç®—æ™‚ï¼Œè¿”å›äºŒç¶­é™£åˆ— (N, 1) å°è‡´çš„ Plotly æˆ– Numpy éŒ¯èª¤ã€‚
- é€éåœ¨æŒ‡æ¨™è¨ˆç®—å¾Œå¼·åˆ¶ä½¿ç”¨ .squeeze() ç¢ºä¿æ‰€æœ‰æŒ‡æ¨™è³‡æ–™ç‚ºä¸€ç¶­ Seriesã€‚
- [å®Œæ•´æ€§ä¿®å¾©] è£œé½Šä¸Šå‚³æ™‚è¢«æˆªæ–·çš„ Plotly åœ–è¡¨ç¹ªè£½ä»£ç¢¼ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š
- [ç©©å®šæ€§ä¿®å¾©] æ–°å¢ scipy ä¾è³´ï¼Œä¿®å¾© ModuleNotFoundError
- [é ‚ç´šç­–ç•¥] å¼•å…¥ã€Œå¤šé€±æœŸè¶¨å‹¢ç¢ºèªã€åˆ†æå¼•æ“
- [é ‚ç´šç­–ç•¥] æ•´åˆã€Œæ–æ³¢é‚£å¥‘å›æ¸¬ã€ä½œç‚ºå‹•æ…‹æ­¢ç›ˆæ­¢ææ¨¡å‹
- [UI å„ªåŒ–] ç‚º AI å°ˆå®¶ç¸½çµçš„è¡Œå‹•å»ºè­°æ·»åŠ é¡è‰²æ¨™è¨˜
- [å°ˆå®¶åœ–è¡¨ Pro] ç‚ºæŒ‡æ¨™åœ–è¡¨åŠ å…¥é—œéµæ°´å¹³ç·šèˆ‡ AI è¨»è§£

é–‹ç™¼è€…ï¼šç¨‹å¼ç¢¼å°ˆå®¶ (Generated by Gemini)
ç‰ˆæœ¬ï¼š4.3.1 (Stability Enhanced and Complete)
"""

# è¼‰å…¥æ ¸å¿ƒå¥—ä»¶
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import ta
import warnings
import time
import re 
from datetime import datetime, timedelta
from scipy.stats import linregress # ç¢ºä¿ scipy ä¾è³´å­˜åœ¨

warnings.filterwarnings('ignore')

# ==============================================================================
# 1. é é¢é…ç½®èˆ‡å…¨å±€è¨­å®š
# ==============================================================================

st.set_page_config(
    page_title="è»Œé“å¸ä»¤éƒ¨ï¼šæˆ°è¡“æƒæ (O.C.T.S.) - V4.3", 
    page_icon="ğŸ›°ï¸", 
    layout="wide"
)

# é€±æœŸæ˜ å°„ï¼š(YFinance Period, YFinance Interval)
PERIOD_MAP = { 
    "30 åˆ†": ("60d", "30m"), 
    "4 å°æ™‚": ("1y", "60m"), # ä½¿ç”¨ 60m æ•¸æ“šé€²è¡Œèšåˆæˆ–ä½œç‚º 4H çš„è¿‘ä¼¼
    "1 æ—¥": ("5y", "1d"), 
    "1 é€±": ("max", "1wk")
}

# ğŸš€ æ‚¨çš„ã€æ‰€æœ‰è³‡ç”¢æ¸…å–®ã€‘ (èˆ‡ä½¿ç”¨è€…æä¾›çš„ä¸€è‡´)
FULL_SYMBOLS_MAP = {
    # ----------------------------------------------------
    # A. ç¾è‚¡æ ¸å¿ƒ (US Stocks) - å€‹è‚¡
    # ----------------------------------------------------
    "TSLA": {"name": "ç‰¹æ–¯æ‹‰", "keywords": ["ç‰¹æ–¯æ‹‰", "é›»å‹•è»Š", "TSLA", "Tesla"]},
    "NVDA": {"name": "è¼é”", "keywords": ["è¼é”", "è‹±å‰é”", "AI", "NVDA", "Nvidia"]},
    "AAPL": {"name": "è˜‹æœ", "keywords": ["è˜‹æœ", "Apple", "AAPL"]},
    "GOOGL": {"name": "è°·æ­Œ/Alphabet", "keywords": ["è°·æ­Œ", "Alphabet", "GOOGL", "GOOG"]},
    "MSFT": {"name": "å¾®è»Ÿ", "keywords": ["å¾®è»Ÿ", "Microsoft", "MSFT"]},
    "AMZN": {"name": "äºé¦¬éœ", "keywords": ["äºé¦¬éœ", "Amazon", "AMZN"]},
    "META": {"name": "Meta/è‡‰æ›¸", "keywords": ["è‡‰æ›¸", "Meta", "FB", "META"]},
    "NFLX": {"name": "ç¶²é£›", "keywords": ["ç¶²é£›", "Netflix", "NFLX"]},
    "ADBE": {"name": "Adobe", "keywords": ["Adobe", "ADBE"]},
    "CRM": {"name": "Salesforce", "keywords": ["Salesforce", "CRM"]},
    "ORCL": {"name": "ç”²éª¨æ–‡", "keywords": ["ç”²éª¨æ–‡", "Oracle", "ORCL"]},
    "COST": {"name": "å¥½å¸‚å¤š", "keywords": ["å¥½å¸‚å¤š", "Costco", "COST"]},
    "JPM": {"name": "æ‘©æ ¹å¤§é€š", "keywords": ["æ‘©æ ¹å¤§é€š", "JPMorgan", "JPM"]},
    "V": {"name": "Visa", "keywords": ["Visa", "V"]},
    "WMT": {"name": "æ²ƒçˆ¾ç‘ª", "keywords": ["æ²ƒçˆ¾ç‘ª", "Walmart", "WMT"]},
    "PG": {"name": "å¯¶æ½”", "keywords": ["å¯¶æ½”", "P&G", "PG"]},
    "KO": {"name": "å¯å£å¯æ¨‚", "keywords": ["å¯å£å¯æ¨‚", "CocaCola", "KO"]},
    "PEP": {"name": "ç™¾äº‹", "keywords": ["ç™¾äº‹", "Pepsi", "PEP"]},
    "MCD": {"name": "éº¥ç•¶å‹", "keywords": ["éº¥ç•¶å‹", "McDonalds", "MCD"]},
    "QCOM": {"name": "é«˜é€š", "keywords": ["é«˜é€š", "Qualcomm", "QCOM"]},
    "INTC": {"name": "è‹±ç‰¹çˆ¾", "keywords": ["è‹±ç‰¹çˆ¾", "Intel", "INTC"]},
    "AMD": {"name": "è¶…å¾®", "keywords": ["è¶…å¾®", "AMD"]},
    "LLY": {"name": "ç¦®ä¾†", "keywords": ["ç¦®ä¾†", "EliLilly", "LLY"]},
    "UNH": {"name": "è¯åˆå¥åº·", "keywords": ["è¯åˆå¥åº·", "UNH"]},
    "HD": {"name": "å®¶å¾—å¯¶", "keywords": ["å®¶å¾—å¯¶", "HomeDepot", "HD"]},
    "CAT": {"name": "é–‹æ‹“é‡å·¥", "keywords": ["é–‹æ‹“é‡å·¥", "Caterpillar", "CAT"]},
    # B. ç¾è‚¡æŒ‡æ•¸/ETF (US Indices/ETFs)
    "^GSPC": {"name": "S&P 500 æŒ‡æ•¸", "keywords": ["æ¨™æ™®", "S&P500", "^GSPC", "SPX"]},
    "^IXIC": {"name": "NASDAQ ç¶œåˆæŒ‡æ•¸", "keywords": ["ç´æ–¯é”å…‹", "NASDAQ", "^IXIC"]},
    "^DJI": {"name": "é“ç“Šå·¥æ¥­æŒ‡æ•¸", "keywords": ["é“ç“Š", "DowJones", "^DJI"]},
    "SPY": {"name": "SPDR æ¨™æ™®500 ETF", "keywords": ["SPY", "æ¨™æ™®ETF"]},
    "QQQ": {"name": "Invesco QQQ Trust", "keywords": ["QQQ", "ç´æ–¯é”å…‹ETF"]},
    "VOO": {"name": "Vanguard æ¨™æ™®500 ETF", "keywords": ["VOO", "Vanguard"]},
    # ----------------------------------------------------
    # C. å°ç£å¸‚å ´ (TW Stocks/ETFs/Indices)
    # ----------------------------------------------------
    "2330.TW": {"name": "å°ç©é›»", "keywords": ["å°ç©é›»", "2330", "TSMC"]},
    "2317.TW": {"name": "é´»æµ·", "keywords": ["é´»æµ·", "2317", "Foxconn"]},
    "2454.TW": {"name": "è¯ç™¼ç§‘", "keywords": ["è¯ç™¼ç§‘", "2454", "MediaTek"]},
    "2308.TW": {"name": "å°é”é›»", "keywords": ["å°é”é›»", "2308", "Delta"]},
    "3017.TW": {"name": "å¥‡é‹", "keywords": ["å¥‡é‹", "3017", "æ•£ç†±"]},
    "3231.TW": {"name": "ç·¯å‰µ", "keywords": ["ç·¯å‰µ", "3231"]},
    "2382.TW": {"name": "å»£é”", "keywords": ["å»£é”", "2382"]},
    "2379.TW": {"name": "ç‘æ˜±", "keywords": ["ç‘æ˜±", "2379"]},
    "2881.TW": {"name": "å¯Œé‚¦é‡‘", "keywords": ["å¯Œé‚¦é‡‘", "2881"]},
    "2882.TW": {"name": "åœ‹æ³°é‡‘", "keywords": ["åœ‹æ³°é‡‘", "2882"]},
    "2603.TW": {"name": "é•·æ¦®", "keywords": ["é•·æ¦®", "2603", "èˆªé‹"]},
    "2609.TW": {"name": "é™½æ˜", "keywords": ["é™½æ˜", "2609", "èˆªé‹"]},
    "2615.TW": {"name": "è¬æµ·", "keywords": ["è¬æµ·", "2615", "èˆªé‹"]},
    "2891.TW": {"name": "ä¸­ä¿¡é‡‘", "keywords": ["ä¸­ä¿¡é‡‘", "2891"]},
    "1101.TW": {"name": "å°æ³¥", "keywords": ["å°æ³¥", "1101"]},
    "1301.TW": {"name": "å°å¡‘", "keywords": ["å°å¡‘", "1301"]},
    "2357.TW": {"name": "è¯ç¢©", "keywords": ["è¯ç¢©", "2357"]},
    "0050.TW": {"name": "å…ƒå¤§å°ç£50", "keywords": ["å°ç£50", "0050", "å°ç£äº”å"]},
    "0056.TW": {"name": "å…ƒå¤§é«˜è‚¡æ¯", "keywords": ["é«˜è‚¡æ¯", "0056"]},
    "00878.TW": {"name": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯", "keywords": ["00878", "åœ‹æ³°æ°¸çºŒ"]},
    "^TWII": {"name": "å°è‚¡æŒ‡æ•¸", "keywords": ["å°è‚¡æŒ‡æ•¸", "åŠ æ¬ŠæŒ‡æ•¸", "^TWII"]},
    # ----------------------------------------------------
    # D. åŠ å¯†è²¨å¹£ (Crypto)
    # ----------------------------------------------------
    "BTC-USD": {"name": "æ¯”ç‰¹å¹£", "keywords": ["æ¯”ç‰¹å¹£", "BTC", "bitcoin", "BTC-USDT"]},
    "ETH-USD": {"name": "ä»¥å¤ªåŠ", "keywords": ["ä»¥å¤ªåŠ", "ETH", "ethereum", "ETH-USDT"]},
    "SOL-USD": {"name": "Solana", "keywords": ["Solana", "SOL", "SOL-USDT"]},
    "BNB-USD": {"name": "å¹£å®‰å¹£", "keywords": ["å¹£å®‰å¹£", "BNB", "BNB-USDT"]},
    "DOGE-USD": {"name": "ç‹—ç‹—å¹£", "keywords": ["ç‹—ç‹—å¹£", "DOGE", "DOGE-USDT"]},
    "XRP-USD": {"name": "ç‘æ³¢å¹£", "keywords": ["ç‘æ³¢å¹£", "XRP", "XRP-USDT"]},
    "ADA-USD": {"name": "Cardano", "keywords": ["Cardano", "ADA", "ADA-USDT"]},
    "ASTER-USD": {"name": "Aster", "keywords": ["Aster", "ASTER-USD"]},
    "AVAX-USD": {"name": "Avalanche", "keywords": ["Avalanche", "AVAX", "AVAX-USDT"]},
    "DOT-USD": {"name": "Polkadot", "keywords": ["Polkadot", "DOT", "DOT-USDT"]},
    "LINK-USD": {"name": "Chainlink", "keywords": ["Chainlink", "LINK", "LINK-USDT"]},
}

# å»ºç«‹ç¬¬äºŒå±¤é¸æ“‡å™¨æ˜ å°„
CATEGORY_MAP = {
    "ç¾è‚¡ (US) - å€‹è‚¡/ETF/æŒ‡æ•¸": [c for c in FULL_SYMBOLS_MAP.keys() if not (c.endswith(".TW") or c.endswith("-USD") or c.startswith("^TWII"))],
    "å°è‚¡ (TW) - å€‹è‚¡/ETF/æŒ‡æ•¸": [c for c in FULL_SYMBOLS_MAP.keys() if c.endswith(".TW") or c.startswith("^TWII")],
    "åŠ å¯†è²¨å¹£ (Crypto)": [c for c in FULL_SYMBOLS_MAP.keys() if c.endswith("-USD")],
}

CATEGORY_HOT_OPTIONS = {}
for category, codes in CATEGORY_MAP.items():
    options = {}
    sorted_codes = sorted(codes) 
    for code in sorted_codes:
        info = FULL_SYMBOLS_MAP.get(code)
        if info:
            options[f"{code} - {info['name']}"] = code
    CATEGORY_HOT_OPTIONS[category] = options
    

# ==============================================================================
# 2. æ•¸æ“šç²å–èˆ‡è™•ç†
# ==============================================================================

def get_symbol_name(symbol):
    """æ ¹æ“šä»£ç¢¼ç²å–ä¸­æ–‡åç¨±"""
    info = FULL_SYMBOLS_MAP.get(symbol)
    return info['name'] if info else symbol

def fuzzy_search_symbol(query):
    """æ¨¡ç³Šæœç´¢ä»£ç¢¼æˆ–åç¨±"""
    if not query:
        return None
    query = query.lower()
    for symbol, info in FULL_SYMBOLS_MAP.items():
        if query == symbol.lower():
            return symbol
        if query in info['name'].lower():
            return symbol
        if any(query in kw.lower() for kw in info['keywords']):
            return symbol
    return None

def fetch_data(symbol, period, interval):
    """å¾ Yahoo Finance ç²å–æ•¸æ“š"""
    try:
        data = yf.download(symbol, period=period, interval=interval, progress=False)
        if data.empty:
            st.error(f"âŒ æ•¸æ“šç²å–å¤±æ•—ï¼šæ‰¾ä¸åˆ° {symbol} çš„æ•¸æ“šæˆ–æŒ‡å®šçš„é€±æœŸç„¡æ•¸æ“šã€‚è«‹æª¢æŸ¥ä»£ç¢¼æˆ–èª¿æ•´é€±æœŸã€‚")
            return None
        
        # æ•¸æ“šé©—è­‰ï¼šç¢ºä¿æœ‰è¶³å¤ çš„æ•¸æ“šé»é€²è¡Œåˆ†æ (è‡³å°‘ 30 å€‹)
        if len(data) < 30:
            st.warning(f"âš ï¸ æ•¸æ“šé»ä¸è¶³ ({len(data)} ç­†)ã€‚åˆ†æçµæœå¯èƒ½ä¸å¯é ã€‚")
            return None
            
        data.columns = ['Open', 'High', 'Low', 'Close', 'Adj Close', 'Volume']
        return data
    except Exception as e:
        st.error(f"âŒ æ•¸æ“šç²å–ç•°å¸¸: {e}")
        return None

# ==============================================================================
# 3. æŠ€è¡“æŒ‡æ¨™è¨ˆç®— (æ ¸å¿ƒä¿®å¾©å€)
# ==============================================================================

def calculate_indicators(df):
    """è¨ˆç®—æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™ä¸¦å°‡çµæœå¼·åˆ¶ç‚º 1D Series ä»¥é¿å… Plotly éŒ¯èª¤"""
    
    # 1. è¶¨å‹¢æŒ‡æ¨™ (Trend Indicators)
    macd = ta.trend.MACD(close=df['Close'], window_fast=9, window_slow=16, window_sign=5)
    df['MACD'] = macd.macd().squeeze()        # ğŸ› ï¸ ä¿®å¾©é»ï¼šä½¿ç”¨ .squeeze() ç¢ºä¿ 1D
    df['MACD_Signal'] = macd.macd_signal().squeeze() # ğŸ› ï¸ ä¿®å¾©é»
    df['MACD_Hist'] = macd.macd_diff().squeeze()     # ğŸ› ï¸ ä¿®å¾©é»
    
    # ADX (Average Directional Movement Index)
    df['ADX_9'] = ta.trend.ADX(high=df['High'], low=df['Low'], close=df['Close'], window=9).adx().squeeze() # ğŸ› ï¸ ä¿®å¾©é»

    # 2. ç§»å‹•å¹³å‡ç·š (Moving Averages)
    df['SMA_20'] = ta.trend.sma_indicator(df['Close'], window=20).squeeze() # ğŸ› ï¸ ä¿®å¾©é»
    df['SMA_60'] = ta.trend.sma_indicator(df['Close'], window=60).squeeze() # ğŸ› ï¸ ä¿®å¾©é»
    df['SMA_120'] = ta.trend.sma_indicator(df['Close'], window=120).squeeze() # ğŸ› ï¸ ä¿®å¾©é»

    # 3. æ³¢å‹•æ€§/å‹•é‡æŒ‡æ¨™ (Volatility/Momentum)
    rsi = ta.momentum.RSIIndicator(close=df['Close'], window=14)
    df['RSI'] = rsi.rsi().squeeze() # ğŸ› ï¸ ä¿®å¾©é»

    stoch = ta.momentum.StochRSIIndicator(close=df['Close'], window=14, smooth1=3, smooth2=3)
    df['Stoch_%K'] = stoch.stoch().squeeze() # ğŸ› ï¸ ä¿®å¾©é»
    df['Stoch_%D'] = stoch.stoch_signal().squeeze() # ğŸ› ï¸ ä¿®å¾©é»

    # 4. æˆäº¤é‡æŒ‡æ¨™ (Volume Indicators)
    df['CMF'] = ta.volume.ChaikinMoneyFlow(high=df['High'], low=df['Low'], close=df['Close'], volume=df['Volume']).cmf().squeeze() # ğŸ› ï¸ ä¿®å¾©é»
    
    # 5. å¸ƒæ—å¸¶ (Bollinger Bands)
    bollinger = ta.volatility.BollingerBands(close=df['Close'], window=20, window_dev=2)
    df['BB_High'] = bollinger.bollinger_hband().squeeze() # ğŸ› ï¸ ä¿®å¾©é»
    df['BB_Low'] = bollinger.bollinger_lband().squeeze()  # ğŸ› ï¸ ä¿®å¾©é»
    
    # æ–æ³¢é‚£å¥‘å›æ’¤æ°´å¹³ (Fibo Levels for dynamic S/R)
    # æ‰¾åˆ°æœ€è¿‘çš„æ³¢æ®µé«˜é»å’Œä½é»ï¼Œè¨ˆç®—æ–æ³¢é‚£å¥‘æ°´å¹³
    # ä½¿ç”¨è¿‘ 150 æ ¹ K ç·šæ•¸æ“š
    lookback = min(150, len(df))
    last_high = df['High'].iloc[-lookback:].max()
    last_low = df['Low'].iloc[-lookback:].min()
    fibo_diff = last_high - last_low
    
    fibo_levels = {
        '23.6%': last_high - 0.236 * fibo_diff,
        '38.2%': last_high - 0.382 * fibo_diff,
        '50.0%': last_high - 0.500 * fibo_diff,
        '61.8%': last_high - 0.618 * fibo_diff,
        '78.6%': last_high - 0.786 * fibo_diff,
    }
    
    # å°‡æ–æ³¢é‚£å¥‘æ°´å¹³å„²å­˜ç‚ºå­—å…¸ï¼Œæ–¹ä¾¿å¾ŒçºŒåœ¨åˆ†æä¸­èª¿ç”¨
    df['Fibo_Levels'] = pd.Series([fibo_levels] * len(df))
    
    return df

# ==============================================================================
# 4. AI ç­–ç•¥åˆ†æå¼•æ“ (Expert Strategy)
# ==============================================================================

def expert_analysis(df, symbol_name, selected_interval):
    """
    AI å°ˆå®¶ç´šè¶¨å‹¢èˆ‡ç­–ç•¥ç¸½çµ (å¤šé€±æœŸç¢ºèª + å‹•æ…‹æ–æ³¢é‚£å¥‘)
    """
    if df.empty or len(df) < 5:
        return "æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•é€²è¡Œåˆ†æã€‚"

    # --- 1. å®šç¾©ç•¶å‰åƒ¹æ ¼èˆ‡è¶¨å‹¢ç‹€æ…‹ ---
    current_price = df['Close'].iloc[-1]
    
    # ç¢ºä¿ SMA æ•¸æ“šå­˜åœ¨ä¸”ä¸ç‚º NaN
    if df['SMA_60'].iloc[-1] is np.nan or df['SMA_20'].iloc[-1] is np.nan:
        return "ç§»å‹•å¹³å‡ç·šæ•¸æ“šè¨ˆç®—ä¸è¶³ï¼Œè«‹ä½¿ç”¨æ›´é•·çš„é€±æœŸæˆ–ç­‰å¾…æ›´å¤šæ•¸æ“šé»ã€‚"

    sma_20 = df['SMA_20'].iloc[-1]
    sma_60 = df['SMA_60'].iloc[-1]
    
    trend_score = 0
    trend_details = []

    # --- 2. å¤šé€±æœŸè¶¨å‹¢ç¢ºèª (Multi-Period Trend Confirmation) ---
    if current_price > sma_60:
        trend_score += 1
        trend_details.append("âœ… **é•·æœŸè¶¨å‹¢ç¢ºèª (SMA-60)**: åƒ¹æ ¼ä½æ–¼é•·æœŸç§»å‹•å¹³å‡ç·šä¸Šæ–¹ï¼Œè¶¨å‹¢å¼·å‹ã€‚")
    elif current_price < sma_60:
        trend_score -= 1
        trend_details.append("âŒ **é•·æœŸè¶¨å‹¢è­¦ç¤º (SMA-60)**: åƒ¹æ ¼ä½æ–¼é•·æœŸç§»å‹•å¹³å‡ç·šä¸‹æ–¹ï¼Œè¶¨å‹¢ç–²è»Ÿã€‚")
    else:
        trend_details.append("âšª **é•·æœŸè¶¨å‹¢ä¸­æ€§**: åƒ¹æ ¼æ¥è¿‘é•·æœŸç§»å‹•å¹³å‡ç·šï¼Œè¶¨å‹¢ä¸æ˜ã€‚")

    if current_price > sma_20:
        trend_score += 1
        trend_details.append("ğŸŸ¢ **çŸ­æœŸå‹¢é ­å¼·å‹ (SMA-20)**: åƒ¹æ ¼ä½æ–¼çŸ­æœŸç§»å‹•å¹³å‡ç·šä¸Šæ–¹ï¼Œå‹•èƒ½ç©æ¥µã€‚")
    elif current_price < sma_20:
        trend_score -= 1
        trend_details.append("ğŸ”´ **çŸ­æœŸå‹¢é ­æ¸›å¼± (SMA-20)**: åƒ¹æ ¼ä½æ–¼çŸ­æœŸç§»å‹•å¹³å‡ç·šä¸‹æ–¹ï¼Œå‹•èƒ½æ¸›å¼±ã€‚")
        
    # --- 3. å‹•é‡èˆ‡æ³¢å‹•æ€§è©•ä¼° (Momentum & Volatility) ---
    rsi = df['RSI'].iloc[-1]
    adx = df['ADX_9'].iloc[-1]
    
    momentum_details = []
    
    if rsi > 80:
        momentum_details.append(f"ğŸ”´ **RSI æ¥µåº¦è¶…è²· ({rsi:.2f})**ï¼šçŸ­æœŸå…§å­˜åœ¨è¼ƒå¤§å›èª¿é¢¨éšªã€‚")
        trend_score -= 1.5
    elif rsi < 20:
        momentum_details.append(f"ğŸŸ¢ **RSI æ¥µåº¦è¶…è³£ ({rsi:.2f})**ï¼šè¶…è³£å€åŸŸï¼Œå¯èƒ½å‡ºç¾åå½ˆã€‚")
        trend_score += 1.5
    elif rsi > 50:
        momentum_details.append(f"ğŸŸ¢ **RSI å¼·å‹¢å€åŸŸ ({rsi:.2f})**ï¼šè²·æ–¹åŠ›é‡ä½”å„ªã€‚")
        trend_score += 0.5
    else:
        momentum_details.append(f"âšª **RSI å¼±å‹¢å€åŸŸ ({rsi:.2f})**ï¼šè³£æ–¹åŠ›é‡ä½”å„ªã€‚")
        trend_score -= 0.5
        
    if adx > 25:
        momentum_details.append(f"ğŸŸ¡ **ADX è¶¨å‹¢å¼·åº¦ ({adx:.2f})**ï¼šè¶¨å‹¢ç¢ºç«‹ï¼Œå¯ä¿¡åº¦é«˜ã€‚")
        trend_score += 1
    else:
        momentum_details.append(f"âšª **ADX è¶¨å‹¢å¼·åº¦ ({adx:.2f})**ï¼šå¸‚å ´ç›¤æ•´æˆ–è¶¨å‹¢ä¸æ˜é¡¯ã€‚")

    # --- 4. æ–æ³¢é‚£å¥‘å›æ¸¬ä½œç‚ºæ­¢ç›ˆ/æ­¢æå»ºè­° (Fibonacci S/R) ---
    fibo_levels_map = df['Fibo_Levels'].iloc[-1]
    fibo_analysis = []
    
    # æ‰¾åˆ°æœ€æ¥è¿‘ç•¶å‰åƒ¹æ ¼çš„æ–æ³¢é‚£å¥‘æ”¯æ’å’Œé˜»åŠ›
    sorted_fibo = sorted(fibo_levels_map.items(), key=lambda item: item[1], reverse=True)
    
    support_level = None
    resistance_level = None
    
    for level, price in sorted_fibo:
        if price < current_price:
            if support_level is None or price > support_level[1]:
                support_level = (level, price)
        elif price > current_price:
            if resistance_level is None or price < resistance_level[1]:
                resistance_level = (level, price)
                
    if resistance_level:
        fibo_analysis.append(f"**å‹•æ…‹é˜»åŠ› (æ­¢ç›ˆå€)**: {resistance_level[0]} @ {resistance_level[1]:.2f}")
    else:
        fibo_analysis.append(f"**å‹•æ…‹é˜»åŠ› (æ­¢ç›ˆå€)**: ç„¡æ˜é¡¯é˜»åŠ›ï¼Œéœ€è§€å¯Ÿæ­·å²é«˜é»ã€‚")
        
    if support_level:
        fibo_analysis.append(f"**é—œéµæ”¯æ’ (æ­¢æå€)**: {support_level[0]} @ {support_level[1]:.2f}")
    else:
        fibo_analysis.append(f"**é—œéµæ”¯æ’ (æ­¢æå€)**: ç„¡æ˜é¡¯æ”¯æ’ï¼Œéœ€è§€å¯Ÿæ­·å²ä½é»ã€‚")

    # --- 5. ç¶œåˆçµè«–èˆ‡è¡Œå‹•å»ºè­° (Consolidated Action) ---
    # è¨­ç½®é»˜èªå€¼ä»¥é˜² level ç‚º None
    res_price = resistance_level[1] if resistance_level else current_price * 1.05
    sup_price = support_level[1] if support_level else current_price * 0.95

    if trend_score >= 2:
        action = "<span style='color: #28a745; font-weight: bold;'>æ¥µåº¦çœ‹æ¼² (Strong Buy)</span>"
        recommendation = f"è¶¨å‹¢å’Œå‹•é‡æŒ‡æ¨™**å¼·çƒˆæ”¯æŒ**ä¸Šæ¼²ã€‚å»ºè­°åœ¨é—œéµæ”¯æ’ä½ ({sup_price:.2f}) é™„è¿‘æˆ–çªç ´è¿‘æœŸé˜»åŠ› ({res_price:.2f}) æ™‚**å»ºç«‹å¤šé ­å€‰ä½**ã€‚"
    elif trend_score >= 0.5:
        action = "<span style='color: #ffc107; font-weight: bold;'>åå‘çœ‹æ¼² (Mild Buy)</span>"
        recommendation = f"å¸‚å ´è™•æ–¼**ç©æ¥µä½†è¬¹æ…çš„è¶¨å‹¢**ã€‚ç­‰å¾…æ›´æ˜ç¢ºçš„ä¿¡è™Ÿï¼Œå¯è€ƒæ…®è¼•å€‰å¤šé ­ï¼Œä¸¦å¯†åˆ‡é—œæ³¨æ–æ³¢é‚£å¥‘æ”¯æ’ ({sup_price:.2f})ã€‚"
    elif trend_score <= -2:
        action = "<span style='color: #dc3545; font-weight: bold;'>æ¥µåº¦çœ‹è·Œ (Strong Sell)</span>"
        recommendation = f"æŠ€è¡“é¢å’Œå‹•é‡æŒ‡æ¨™**å¼·çƒˆé¡¯ç¤ºä¸‹è¡Œé¢¨éšª**ã€‚å»ºè­°åœ¨é—œéµé˜»åŠ›ä½ ({res_price:.2f}) é™„è¿‘æˆ–è·Œç ´æ”¯æ’ ({sup_price:.2f}) æ™‚**å»ºç«‹ç©ºé ­å€‰ä½**ã€‚"
    elif trend_score <= -0.5:
        action = "<span style='color: #6c757d; font-weight: bold;'>åå‘çœ‹è·Œ (Mild Sell)</span>"
        recommendation = f"å¸‚å ´è™•æ–¼**ç–²è»Ÿç‹€æ…‹**ã€‚å»ºè­°ä¿æŒè§€æœ›ï¼Œæˆ–è€ƒæ…®è¼•å€‰ç©ºé ­ï¼Œå°‡æ–æ³¢é‚£å¥‘é˜»åŠ› ({res_price:.2f}) ä½œç‚ºæ­¢æåƒè€ƒã€‚"
    else:
        action = "<span style='color: #17a2b8; font-weight: bold;'>ç›¤æ•´è§€æœ› (Neutral/Consolidation)</span>"
        recommendation = f"æ‰€æœ‰æŒ‡æ¨™**ç›¸äº’çŸ›ç›¾æˆ–è¶¨å‹¢ä¸æ˜é¡¯**ã€‚å»ºè­°è§€æœ›ï¼Œç­‰å¾…åƒ¹æ ¼çªç ´ {sup_price:.2f} (å‘ä¸‹) æˆ– {res_price:.2f} (å‘ä¸Š) ä»¥ç¢ºç«‹æ–°è¶¨å‹¢ã€‚"
        
    summary = f"""
    ### ğŸ›°ï¸ AI æˆ°è¡“ç¸½çµï¼š{symbol_name} ({selected_interval} é€±æœŸ)
    
    ç•¶å‰åƒ¹æ ¼: **{current_price:.2f}** | è¶¨å‹¢å¼·åº¦åˆ†æ•¸: **{trend_score:.1f}**
    
    ---
    #### ğŸ”­ è¶¨å‹¢ç¢ºèª (å¤šé€±æœŸä¿¡è™Ÿ)
    - {'<br>'.join(trend_details)}

    #### ğŸ’¥ å‹•é‡èˆ‡é¢¨éšªè©•ä¼°
    - {'<br>'.join(momentum_details)}

    #### ğŸ›¡ï¸ æˆ°è¡“éƒ¨ç½²ï¼šæ­¢ç›ˆ/æ­¢æå»ºè­° (åŸºæ–¼æ–æ³¢é‚£å¥‘å›æ’¤)
    - {'<br>'.join(fibo_analysis)}
    
    ---
    #### ğŸš€ æœ€çµ‚è¡Œå‹•å»ºè­°
    **ç¶œåˆåˆ¤æ–·**: {action}
    
    **ç­–ç•¥æè¿°**: {recommendation}
    """
    
    return summary

# ==============================================================================
# 5. Plotly åœ–è¡¨ç”Ÿæˆ (Expert Chart Pro)
# ==============================================================================

def display_analysis_and_chart(df, symbol):
    """
    ç¹ªè£½ K ç·šåœ–ã€MACDã€ADX/CMFã€Stoch/RSI å››å€æŒ‡æ¨™åœ–è¡¨
    """
    if df.empty:
        st.warning("æ²’æœ‰æ•¸æ“šå¯ä¾›ç¹ªè£½åœ–è¡¨ã€‚")
        return

    # 1. æº–å‚™å­åœ–ä½ˆå±€
    # 5 è¡Œ 1 åˆ—ï¼šKç·šåœ–, MACD, ADX, CMF, Stoch/RSI
    fig = make_subplots(
        rows=5, 
        cols=1, 
        shared_xaxes=True, 
        vertical_spacing=0.03, 
        row_heights=[0.5, 0.15, 0.15, 0.1, 0.1],
        subplot_titles=(
            'Kç·šåœ– & å‡ç·š & å¸ƒæ—å¸¶ & æ–æ³¢é‚£å¥‘æ°´å¹³', 
            'MACD (è¶¨å‹¢å‹•èƒ½)', 
            'ADX & CMF (è¶¨å‹¢å¼·åº¦èˆ‡è³‡é‡‘æµ)', 
            'RSI (ç›¸å°å¼·å¼±æŒ‡æ•¸)', 
            'Stochastics (è¶…è²·/è¶…è³£)'
        )
    )

    # --- Row 1: Kç·šåœ– & å‡ç·š & BBå¸¶ & æ–æ³¢é‚£å¥‘ ---
    # Kç·šåœ–
    fig.add_trace(go.Candlestick(
        x=df.index,
        open=df['Open'],
        high=df['High'],
        low=df['Low'],
        close=df['Close'],
        name='Kç·š',
        showlegend=False,
    ), row=1, col=1)

    # ç§»å‹•å¹³å‡ç·š
    fig.add_trace(go.Scatter(x=df.index, y=df['SMA_20'], name='SMA 20', line=dict(color='#ff9900', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['SMA_60'], name='SMA 60', line=dict(color='#17a2b8', width=2)), row=1, col=1)
    
    # å¸ƒæ—å¸¶ (BB)
    fig.add_trace(go.Scatter(x=df.index, y=df['BB_High'], name='BB High', line=dict(color='#FA8072', width=0.5, dash='dash'), opacity=0.8), row=1, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['BB_Low'], name='BB Low', line=dict(color='#40E0D0', width=0.5, dash='dash'), opacity=0.8, fill='tonexty', fillcolor='rgba(135, 206, 250, 0.1)'), row=1, col=1)

    # æ–æ³¢é‚£å¥‘æ°´å¹³ (åƒ…ç¹ªè£½æœ€å¾Œä¸€å€‹æ•¸æ“šé»çš„å€¼)
    fibo_levels_map = df['Fibo_Levels'].iloc[-1]
    for level_name, price in fibo_levels_map.items():
        # åªåœ¨åœ–è¡¨ä¸Šç¹ªè£½è¿‘æœŸçš„æ–æ³¢é‚£å¥‘æ°´å¹³
        fig.add_hline(y=price, line_width=1, line_dash="dot", line_color="#d65f5f", 
                      annotation_text=f"Fibo {level_name}", 
                      annotation_position="bottom right",
                      row=1, col=1)
    
    # --- Row 2: MACD ---
    fig.add_trace(go.Bar(x=df.index, y=df['MACD_Hist'], name='MACD Hist', 
                         marker_color=np.where(df['MACD_Hist'] > 0, '#28a745', '#dc3545')), row=2, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['MACD'], name='MACD', line=dict(color='#17a2b8')), row=2, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['MACD_Signal'], name='Signal', line=dict(color='#ff9900')), row=2, col=1)
    fig.add_hline(y=0, line_width=1, line_dash="dash", line_color="grey", row=2, col=1)


    # --- Row 3: ADX & CMF ---
    # ADX (è¶¨å‹¢å¼·åº¦)
    fig.add_trace(go.Scatter(x=df.index, y=df['ADX_9'], name='ADX', line=dict(color='#6f42c1')), row=3, col=1)
    fig.add_hline(y=25, line_width=1, line_dash="dash", line_color="grey", row=3, col=1)
    
    # CMF (è³‡é‡‘æµ) - æ”¾åœ¨è¼”åŠ©Yè»¸
    fig.add_trace(go.Bar(x=df.index, y=df['CMF'], name='CMF', 
                         marker_color=np.where(df['CMF'] > 0, 'rgba(40, 167, 69, 0.5)', 'rgba(220, 53, 69, 0.5)'),
                         yaxis='y3'), row=3, col=1)
    fig.update_layout(yaxis3=dict(overlaying='yaxis', side='right', range=[-1, 1], showgrid=False, zeroline=False))
    fig.add_hline(y=0, line_width=1, line_dash="dot", line_color="grey", row=3, col=1)


    # --- Row 4: RSI ---
    fig.add_trace(go.Scatter(x=df.index, y=df['RSI'], name='RSI', line=dict(color='#ffc107')), row=4, col=1)
    fig.add_hline(y=80, line_width=1, line_dash="dash", line_color="#dc3545", row=4, col=1)
    fig.add_hline(y=20, line_width=1, line_dash="dash", line_color="#28a745", row=4, col=1)
    fig.add_hrect(y0=80, y1=100, line_width=0, fillcolor="#dc3545", opacity=0.1, row=4, col=1)
    fig.add_hrect(y0=0, y1=20, line_width=0, fillcolor="#28a745", opacity=0.1, row=4, col=1)
    fig.update_yaxes(range=[0, 100], row=4, col=1)

    # --- Row 5: Stochastics ---
    fig.add_trace(go.Scatter(x=df.index, y=df['Stoch_%K'], name='Stoch %K', line=dict(color='#00ffff')), row=5, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['Stoch_%D'], name='Stoch %D', line=dict(color='#ff00ff', dash='dot')), row=5, col=1)
    fig.add_hrect(y0=80, y1=100, line_width=0, fillcolor="#dc3545", opacity=0.1, row=5, col=1)
    fig.add_hrect(y0=0, y1=20, line_width=0, fillcolor="#28a745", opacity=0.1, row=5, col=1)
    fig.update_yaxes(range=[0, 100], row=5, col=1)


    # --- å…¨å±€ä½ˆå±€å„ªåŒ– ---
    fig.update_layout(
        title=f'ğŸ›°ï¸ {get_symbol_name(symbol)} ({symbol}) æˆ°è¡“æƒæ - V4.3',
        height=1000,
        xaxis_rangeslider_visible=False,
        template="plotly_dark",
        margin=dict(l=20, r=20, t=50, b=20),
        legend=dict(orientation="h", y=1.02, x=0.01)
    )

    # éš±è—æ‰€æœ‰éä¸» K ç·šåœ–çš„ x è»¸åˆ»åº¦
    for i in range(1, 5):
        fig.update_xaxes(showticklabels=False, row=i, col=1)

    st.plotly_chart(fig, use_container_width=True)

# ==============================================================================
# 6. Streamlit UI çµæ§‹
# ==============================================================================

# å‰µå»ºè‡ªå®šç¾©æ¨£å¼ (CSS Injection)
def set_custom_css():
    st.markdown("""
        <style>
        /* æ‡‰ç”¨ç¨‹å¼ä¸»é«”æ¨£å¼ */
        .stApp {
            background-color: #0d1117; /* æ·±è‰²èƒŒæ™¯ */
            color: #c9d1d9; /* æ·ºè‰²æ–‡å­— */
        }
        /* å´é‚Šæ¬„æ¨£å¼ */
        [data-testid="stSidebar"] {
            background-color: #161b22; 
        }
        /* å¡ç‰‡æ¨™é¡Œæ¨£å¼ */
        .card-section-header {
            font-size: 1.5rem;
            font-weight: bold;
            color: #58a6ff; /* GitHub Blue */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #21262d;
            padding-bottom: 5px;
        }
        /* æˆ°è¡“ç¸½çµé¢æ¿æ¨£å¼ */
        .summary-box {
            background-color: #21262d; 
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            line-height: 1.8;
            font-size: 1.05em;
        }
        /* è¡Œå‹•å»ºè­°é¡è‰²æ¨™ç±¤ */
        .summary-box span {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 1.1em;
        }
        /* æ­¡è¿è¨Šæ¯å¡ç‰‡ */
        .sub-card-tile {
            background-color: #161b22;
            padding: 1.5rem;
            border-radius: 6px;
            border-left: 5px solid #FA8072;
            margin-bottom: 1rem;
        }
        </style>
    """, unsafe_allow_html=True)
    
set_custom_css()

# ä¾§è¾¹æ è¼¸å…¥æ§ä»¶
def sidebar_inputs():
    st.sidebar.title("ğŸ› ï¸ æˆ°è¡“åƒæ•¸é…ç½®")

    # 1. è³‡ç”¢é¡åˆ¥é¸æ“‡
    category = st.sidebar.selectbox(
        "é¸æ“‡è³‡ç”¢é¡åˆ¥:",
        options=list(CATEGORY_MAP.keys()),
        index=0,
        key='category_select'
    )
    
    # 2. ç†±é–€æ¨™çš„é¸æ“‡ (åŸºæ–¼é¡åˆ¥)
    hot_options = CATEGORY_HOT_OPTIONS.get(category, {})
    
    # ç²å–ç•¶å‰é¸æ“‡çš„ä»£ç¢¼ï¼ˆç”¨æ–¼åˆå§‹åŒ–æˆ–æŸ¥æ‰¾ï¼‰
    selected_name_code = st.sidebar.selectbox(
        "å¿«é€Ÿé¸æ“‡ç†±é–€æ¨™çš„:",
        options=list(hot_options.keys()),
        index=0,
        key='hot_option_select'
    )
    
    selected_code = hot_options.get(selected_name_code, "")
    
    # 3. ç¬¦è™Ÿæ‰‹å‹•è¼¸å…¥ (ç”¨æ–¼è¦†è“‹é¸æ“‡)
    search_query = st.sidebar.text_input(
        "æˆ–æ‰‹å‹•è¼¸å…¥ä»£ç¢¼/åç¨±:",
        value=selected_code,
        key='sidebar_search_input'
    )
    
    # 4. é€±æœŸé¸æ“‡
    selected_interval_name = st.sidebar.selectbox(
        "é¸æ“‡åˆ†æé€±æœŸ:",
        options=list(PERIOD_MAP.keys()),
        index=2, # é è¨­ç‚º '1 æ—¥'
        key='interval_select'
    )
    
    period, interval = PERIOD_MAP[selected_interval_name]
    
    # ç¢ºå®šæœ€çµ‚è¦æŸ¥è©¢çš„ä»£ç¢¼
    final_symbol = fuzzy_search_symbol(search_query) or selected_code
    
    st.sidebar.markdown("---")
    
    # åŸ·è¡Œåˆ†ææŒ‰éˆ•
    if st.sidebar.button("ğŸ“Š åŸ·è¡Œ AI åˆ†æ", key='run_analysis_button'):
        st.session_state['data_ready'] = False
        st.session_state['last_search_symbol'] = final_symbol
        st.session_state['last_period'] = period
        st.session_state['last_interval'] = interval
        st.session_state['last_interval_name'] = selected_interval_name
        
        # é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        with st.spinner(f'æ­£åœ¨é–å®šç›®æ¨™ {final_symbol} ä¸¦åŸ·è¡Œæˆ°è¡“æƒæ...'):
            data = fetch_data(final_symbol, period, interval)
            
            if data is not None and not data.empty:
                st.session_state['data'] = calculate_indicators(data)
                st.session_state['data_ready'] = True
            else:
                st.session_state['data_ready'] = False
        
        # åˆ·æ–°é é¢ä»¥é¡¯ç¤ºçµæœ
        st.rerun()

# æ–æ³¢é‚£å¥‘å’Œé¢¨éšªé¢æ¿ (å–®ç¨æ¸²æŸ“ä»¥æ–¹ä¾¿ UI ä½ˆå±€)
def render_fib_risk_panel(fibo_levels_map, symbol_name):
    st.markdown("<div class='card-section-header'>âš”ï¸ å‹•æ…‹æ­¢ç›ˆæ­¢ææ¨¡å‹ (æ–æ³¢é‚£å¥‘å›æ’¤)</div>", unsafe_allow_html=True)
    
    if not fibo_levels_map:
        st.warning("ç„¡æ³•è¨ˆç®—æ–æ³¢é‚£å¥‘æ°´å¹³ï¼Œè«‹ç¢ºä¿æ•¸æ“šå……è¶³ã€‚")
        return

    col1, col2, col3, col4, col5 = st.columns(5)
    cols = [col1, col2, col3, col4, col5]
    
    fibo_data = sorted(fibo_levels_map.items(), key=lambda item: item[1], reverse=True)
    
    for i, (level, price) in enumerate(fibo_data):
        with cols[i]:
            st.metric(
                label=f"Fibo: {level}",
                value=f"${price:,.2f}",
                delta=f"é—œéµä½" if price > df['Close'].iloc[-1] else f"æ”¯æ’ä½"
            )


def render_technical_analysis_panel(df):
    st.markdown("<div class='card-section-header'>ğŸ“Š æŠ€è¡“æŒ‡æ¨™æ•¸æ“šè¡¨</div>", unsafe_allow_html=True)
    
    # æå–æœ€æ–°çš„æ•¸æ“šé»
    latest = df.iloc[-1].filter(items=[
        'Close', 'SMA_20', 'SMA_60', 
        'RSI', 'MACD', 'MACD_Signal', 'MACD_Hist', 
        'ADX_9', 'CMF', 'Stoch_%K', 'Stoch_%D'
    ])
    
    # æ ¼å¼åŒ–
    formatted_data = latest.apply(lambda x: f"{x:.2f}" if isinstance(x, (float, np.floating)) else x)

    # æ§‹å»ºè¡¨æ ¼
    data_points = {
        'æŒ‡æ¨™': ['æ”¶ç›¤åƒ¹ (Close)', 'çŸ­æœŸå‡ç·š (SMA 20)', 'é•·æœŸå‡ç·š (SMA 60)', 
                 'RSI (14)', 'MACD', 'MACD Signal', 'MACD Hist', 
                 'ADX (9)', 'CMF', 'Stoch %K', 'Stoch %D'],
        'æ•¸å€¼': formatted_data.tolist()
    }
    
    # å‰µå»ºä¸€å€‹ DataFrame é€²è¡Œ Streamlit é¡¯ç¤º
    tech_df = pd.DataFrame(data_points)
    
    # æ‡‰ç”¨é¡è‰²æ¨™è¨˜é‚è¼¯ (åƒ…ç‚ºå±•ç¤ºï¼Œä¸ä¿®æ”¹åŸå§‹æ•¸å€¼)
    def apply_color_style(row):
        color = 'white'
        if 'RSI' in row['æŒ‡æ¨™']:
            val = float(row['æ•¸å€¼'])
            if val > 80: color = '#dc3545'
            elif val < 20: color = '#28a745'
        elif 'MACD Hist' in row['æŒ‡æ¨™']:
            val = float(row['æ•¸å€¼'])
            if val > 0: color = '#28a745'
            elif val < 0: color = '#dc3545'
        
        return f'<span style="color: {color}; font-weight: bold;">{row["æ•¸å€¼"]}</span>'

    tech_df['æ•¸å€¼ (åˆ†æ)'] = tech_df.apply(apply_color_style, axis=1)

    # é¡¯ç¤ºçµæœ (ä½¿ç”¨ markdown æ¨¡æ“¬è¡¨æ ¼ä¸¦æ‡‰ç”¨é¡è‰²)
    markdown_table = "æŒ‡æ¨™ | æ•¸å€¼ \n--- | ---\n"
    for index, row in tech_df.iterrows():
        markdown_table += f"{row['æŒ‡æ¨™']} | {row['æ•¸å€¼ (åˆ†æ)']} \n"
        
    st.markdown(markdown_table, unsafe_allow_html=True)


# æ‡‰ç”¨ç¨‹å¼ä¸»é‚è¼¯
def main():
    if 'last_search_symbol' not in st.session_state:
        st.session_state['last_search_symbol'] = "2330.TW"
    if 'data_ready' not in st.session_state:
        st.session_state['data_ready'] = False
    
    # åŸ·è¡Œå´é‚Šæ¬„è¼¸å…¥
    sidebar_inputs()
    
    # ä¸»é é¢å…§å®¹
    st.title("è»Œé“å¸ä»¤éƒ¨ï¼šæˆ°è¡“æƒæ (O.C.T.S.)")
    st.subheader(f"ç›®æ¨™ä»£è™Ÿ: {get_symbol_name(st.session_state['last_search_symbol'])} ({st.session_state['last_search_symbol']})")

    if st.session_state.get('data_ready', False):
        df = st.session_state['data']
        symbol_name = get_symbol_name(st.session_state['last_search_symbol'])
        selected_interval = st.session_state['last_interval_name']
        
        # 1. AI æˆ°è¡“ç¸½çµ
        summary_text = expert_analysis(df, symbol_name, selected_interval)
        st.markdown(f"<div class='summary-box'>{summary_text}</div>", unsafe_allow_html=True)
        
        st.markdown("---")
        
        # 2. æ–æ³¢é‚£å¥‘å›æ¸¬èˆ‡é¢¨éšªè©•ä¼°
        render_fib_risk_panel(df['Fibo_Levels'].iloc[-1], symbol_name)
        
        st.markdown("---")
        
        # 3. Kç·šèˆ‡æŠ€è¡“æŒ‡æ¨™åœ–è¡¨
        st.markdown("<div class='card-section-header'>ğŸ“ˆ å°ˆå®¶åœ–è¡¨ Pro (å¤šæŒ‡æ¨™èåˆ)</div>", unsafe_allow_html=True)
        display_analysis_and_chart(df, st.session_state['last_search_symbol'])
        
        st.markdown("---")
        
        # 4. å¤šé€±æœŸè¶¨å‹¢ç¢ºèªæ•¸æ“šè¡¨
        render_technical_analysis_panel(df)
        
    else:
        # æ­¡è¿è¨Šæ¯å€å¡Š (åœ¨æœªåŸ·è¡Œåˆ†ææ™‚é¡¯ç¤º)
        st.markdown("<div class='card-section-header'>æ­¡è¿ç™»å…¥ è»Œé“å¸ä»¤éƒ¨ (O.C.T.S.) çµ‚ç«¯</div>", unsafe_allow_html=True)
        
        st.markdown("""
        <div class='sub-card-tile' style='padding: 2rem;'>
            <p style='font-size: 1.2em; color: #e9967a;'>
            **æŒ‡æ®å®˜ï¼Œè«‹åœ¨å·¦å´æˆ°è¡“åƒæ•¸é…ç½®æ¬„ä½**ï¼š
            </p>
            <ol style='line-height: 1.8; margin-top: 1rem;'>
                <li>**é¸æ“‡è³‡ç”¢é¡åˆ¥**ï¼šé¸æ“‡æ‚¨çš„ç›®æ¨™æ˜Ÿå€ï¼ˆå°è‚¡ã€ç¾è‚¡æˆ–åŠ å¯†è²¨å¹£ï¼‰ã€‚</li>
                <li>**é–å®šæ¨™çš„**ï¼šè¼¸å…¥æˆ–é¸æ“‡ç›®æ¨™ä»£è™Ÿã€‚</li>
                <li>**è¨­å®šåˆ†æé€±æœŸ**ï¼šé¸æ“‡æ‚¨å¸Œæœ›çš„æƒææ·±åº¦ï¼ˆ30 åˆ†, 4 å°æ™‚, 1 æ—¥, 1 é€±ï¼‰ã€‚</li>
                <li>**åŸ·è¡Œæƒæ**ï¼šé»æ“Š <span style='color: #28a745; font-weight: bold;'>ã€ğŸ“Š åŸ·è¡Œ AI åˆ†æã€</span> æŒ‰éˆ•é–‹å§‹ã€‚</li>
            </ol>
            <p style='margin-top: 1.5rem; color: #8b949e;'>
            AI æ ¸å¿ƒå°‡æä¾›ç¶œåˆè¶¨å‹¢ç¢ºèªã€å‹•æ…‹æ–æ³¢é‚£å¥‘æ­¢ç›ˆ/æ­¢æå»ºè­°ï¼Œä»¥åŠå¤šæŒ‡æ¨™èåˆçš„å°ˆå®¶åœ–è¡¨ã€‚
            </p>
        </div>
        """, unsafe_allow_html=True)


if __name__ == '__main__':
    main()
